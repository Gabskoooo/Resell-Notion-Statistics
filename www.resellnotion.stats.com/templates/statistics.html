{% extends 'base.html' %}

{% block title %}Statistiques | ResellNotion{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        --glass-bg: rgba(255, 255, 255, 0.03);
        --glass-border: rgba(255, 255, 255, 0.08);
        --primary-glow: #8a2be2;
        --success-glow: #00ffa3;
        --danger-glow: #ff4d4d;
        --warning-glow: #ffcc00;
    }

    body {
        background: #0b0e14;
        /* Note : Le fichier de fond doit √™tre appel√© en .png si utilis√© ult√©rieurement */
        background-image:
            radial-gradient(circle at 0% 0%, rgba(138, 43, 226, 0.1) 0%, transparent 35%),
            radial-gradient(circle at 100% 100%, rgba(0, 255, 163, 0.05) 0%, transparent 35%);
        color: #f8f9fa;
        font-family: 'Plus Jakarta Sans', sans-serif;
        min-height: 100vh;
    }

    .stats-container { padding: 30px; }

    /* --- NAVIGATION PAR ONGLETS --- */
    .nav-tabs-premium {
        display: flex; gap: 10px; margin-bottom: 30px; padding: 5px;
        background: rgba(255,255,255,0.03); border-radius: 18px;
        border: 1px solid var(--glass-border);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Firefox */
    }
    .nav-tabs-premium::-webkit-scrollbar { display: none; /* Chrome/Safari */ }

    .nav-tabs-premium .tab-link {
        padding: 12px 24px; border-radius: 14px; color: #8e9297; font-weight: 600;
        font-size: 0.9rem; cursor: pointer; transition: 0.3s; white-space: nowrap;
        border: none; background: transparent;
    }
    .nav-tabs-premium .tab-link.active { background: var(--primary-glow); color: white; box-shadow: 0 0 15px rgba(138, 43, 226, 0.3); }

    .tab-pane { display: none; }
    .tab-pane.active { display: block; animation: fadeInUp 0.4s ease-out forwards; }

    /* --- CARDS & STATS --- */
    .premium-card {
        background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 24px;
        padding: 24px; transition: 0.4s all; height: 100%; backdrop-filter: blur(10px);
    }
    .stat-label { color: #8e9297; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .stat-numb { font-size: 2rem; font-weight: 700; margin-top: 5px; color: #fff; }
    .text-glow-purple { color: #fff; text-shadow: 0 0 15px rgba(138, 43, 226, 0.4); }
    .text-glow-green { color: var(--success-glow); text-shadow: 0 0 15px rgba(0, 255, 163, 0.3); }
    .text-glow-red { color: var(--danger-glow); text-shadow: 0 0 15px rgba(255, 77, 77, 0.4); }

    .period-btn {
        background: var(--glass-bg); border: 1px solid var(--glass-border); color: #8e9297;
        padding: 10px 18px; border-radius: 14px; text-decoration: none; transition: 0.3s;
        font-size: 0.85rem; font-weight: 600; cursor: pointer;
    }
    .period-btn.active { background: var(--primary-glow); color: white; border: none; }
    .custom-input { background: var(--glass-bg) !important; border: 1px solid var(--glass-border) !important; color: #fff !important; border-radius: 12px; padding: 8px 12px; }

    .progress-custom { height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; position: relative; }
    .progress-bar-glow { box-shadow: 0 0 10px currentColor; transition: width 1s ease-in-out; }
    .health-circle { width: 120px; height: 120px; border-radius: 50%; border: 6px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; margin: 0 auto; position: relative; }

    .table-premium { border-collapse: separate; border-spacing: 0 8px; }
    .table-premium tr { background: var(--glass-bg); }
    .table-premium td, .table-premium th { border: none !important; padding: 16px !important; color: #f8f9fa; }

    .expert-text { font-size: 1.15rem; line-height: 1.7; font-weight: 400; }
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center; }
    .overlay-content { background: #161a2b; padding: 35px; border-radius: 24px; max-width: 500px; width: 90%; border: 1px solid var(--glass-border); position: relative; max-height: 90vh; overflow-y: auto; }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    /* --- OPTIMISATIONS RESPONSIVE --- */

    /* Typographie fluide pour les titres */
    h1 { font-size: clamp(1.5rem, 5vw, 2.5rem); }

    @media (max-width: 992px) {
        .stat-numb { font-size: 1.6rem; }
        .expert-text { font-size: 1rem; }
    }

    @media (max-width: 768px) {
        .stats-container { padding: 15px; }

        .d-flex.flex-wrap.justify-content-between {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .period-btn { padding: 8px 12px; font-size: 0.75rem; }

        .custom-input { width: 100% !important; margin-bottom: 10px; }

        .health-circle { width: 100px; height: 100px; }
        .score-inner { font-size: 1.8rem; }

        .stat-numb { font-size: 1.4rem !important; }

        /* Ajustement des graphiques */
        .premium-card div[style*="height: 350px"] {
            height: 250px !important;
        }
    }

    @media (max-width: 576px) {
        .col-6 { padding-left: 8px; padding-right: 8px; }
        .premium-card { padding: 15px; }
        .stat-label { font-size: 0.7rem; }
        .stat-numb { font-size: 1.2rem !important; }

        .nav-tabs-premium .tab-link { padding: 10px 15px; font-size: 0.8rem; }

        .overlay-content { padding: 25px; }
    }
</style>

<div id="overlay-health" class="overlay"><div class="overlay-content"><span class="btn-close btn-close-white position-absolute top-0 end-0 m-3" onclick="closeHelp('health')"></span><h4 class="text-white fw-bold mb-3">Health Score</h4><p class="small text-muted">Analyse de la rentabilit√© et du flux.</p></div></div>
<div id="overlay-profit-latent" class="overlay"><div class="overlay-content"><span class="btn-close btn-close-white position-absolute top-0 end-0 m-3" onclick="closeHelp('profit-latent')"></span><h4 class="text-white fw-bold mb-3">Profit Latent</h4><p class="small text-muted">B√©n√©fice net contenu dans votre stock actuel.</p></div></div>

<div class="stats-container">

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-4">
        <div>
            <h1 class="fw-bold text-white mb-1">Rapport de Performance</h1>
            <p class="text-muted small">Suivi strat√©gique de votre activit√©.</p>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center bg-dark bg-opacity-25 p-2 rounded-4 border border-white border-opacity-10 w-100 w-md-auto justify-content-center">
            <div class="d-flex gap-1 justify-content-center w-100 w-md-auto">
                <a href="?period=day" class="period-btn {{ 'active' if period == 'day' }}">Jour</a>
                <a href="?period=week" class="period-btn {{ 'active' if period == 'week' }}">Sem.</a>
                <a href="?period=month" class="period-btn {{ 'active' if period == 'month' }}">Mois</a>
                <a href="?period=year" class="period-btn {{ 'active' if period == 'year' }}">An</a>
            </div>
            <form action="/statistics" method="GET" class="d-flex flex-wrap gap-1 align-items-center justify-content-center w-100 w-md-auto">
                <input type="hidden" name="period" value="custom">
                <input type="date" name="start_date" value="{{ start_date }}" class="custom-input flex-grow-1" required>
                <input type="date" name="end_date" value="{{ end_date }}" class="custom-input flex-grow-1" required>
                <button type="submit" class="period-btn"><i class="bi bi-search"></i></button>
            </form>
        </div>
    </div>

    <nav class="nav-tabs-premium">
        <button class="tab-link active" onclick="showTab(event, 'tab-dashboard')">Dashboard</button>
        <button class="tab-link" onclick="showTab(event, 'tab-finances')">Finances</button>
        <button class="tab-link" onclick="showTab(event, 'tab-goals')">Objectifs</button>
        <button class="tab-link" onclick="showTab(event, 'tab-stock')">Stock</button>
        <button class="tab-link" onclick="showTab(event, 'tab-history')">Historique</button>
    </nav>

    <div id="tab-dashboard" class="tab-pane active">
        <div class="row g-3 g-md-4 mb-5">
            <div class="col-6 col-md-3"><div class="premium-card text-center"><span class="stat-label">Health <i class="bi bi-question-circle help-icon" onclick="openHelp('health')"></i></span><div class="health-circle mt-3" style="border-color: {% if health_score > 7 %}var(--success-glow){% elif health_score > 4 %}var(--warning-glow){% else %}var(--danger-glow){% endif %};"><div class="score-inner text-white">{{ health_score }}<span style="font-size: 0.9rem; opacity: 0.5;">/10</span></div></div></div></div>
            <div class="col-6 col-md-3"><div class="premium-card"><span class="stat-label">CA P√©riode</span><div class="stat-numb text-white text-truncate">{{ "%.2f"|format(revenue) }}‚Ç¨</div><div class="text-muted small mt-2">{{ volume }} ventes</div></div></div>
            <div class="col-6 col-md-3"><div class="premium-card"><span class="stat-label">B√©n√©fice Brut</span><div class="stat-numb {% if profit >= 0 %}text-glow-green{% else %}text-glow-red{% endif %} text-truncate">{% if profit >= 0 %}+{% endif %}{{ "%.2f"|format(profit) }}‚Ç¨</div><div class="text-muted small mt-2">ROI: {{ "%.1f"|format(roi_avg) }}%</div></div></div>
            <div class="col-6 col-md-3"><div class="premium-card border-warning border-opacity-25"><span class="stat-label">Valeur Stock</span><div class="stat-numb text-truncate" style="color: var(--warning-glow)">{{ "%.0f"|format(stock_value) }}‚Ç¨</div><div class="text-muted small mt-2">{{ stock_qty }} paires</div></div></div>
        </div>
        <div class="row g-4">
            <div class="col-lg-8"><div class="premium-card"><h6 class="stat-label mb-4">√âvolution des Flux</h6><div style="height: 350px;"><canvas id="evolutionChart"></canvas></div></div></div>
            <div class="col-lg-4">
                <div class="premium-card" style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.15), transparent); border-left: 4px solid var(--primary-glow);">
                    <h5 class="text-white fw-bold mb-3 text-uppercase small"><i class="bi bi-robot me-2" style="color: var(--primary-glow)"></i>AVIS DE L'EXPERT</h5>
                    <p id="dashboard-expert-advice" class="expert-text text-white-50">Diagnostic strat√©gique en cours...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-finances" class="tab-pane">
        <h3 class="fw-bold text-white mb-4">√âtat Financier</h3>
        <div class="row g-3 mb-5">
            <div class="col-6 col-md-3"><div class="premium-card"><span class="stat-label">Liquidit√©s (Cash)</span><div class="mt-2"><div class="input-group input-group-sm"><input type="number" id="input-cash" value="{{ current_cash }}" class="form-control custom-input fw-bold fs-5 text-white" oninput="updateFinances()" style="background: rgba(255,255,255,0.05) !important;"><span class="input-group-text bg-transparent border-0 text-white-50">‚Ç¨</span></div></div></div></div>
            <div class="col-6 col-md-3"><div class="premium-card"><span class="stat-label">Stock (Achat)</span><div class="stat-numb text-truncate" style="font-size: 1.5rem">{{ "%.2f"|format(valeur_achat_stock) }}‚Ç¨</div></div></div>
            <div class="col-6 col-md-3"><div class="premium-card border-warning border-opacity-25"><span class="stat-label text-warning">En Attente</span><div class="stat-numb text-truncate" style="font-size: 1.5rem">{{ "%.2f"|format(pending_payments) }}‚Ç¨</div></div></div>
            <div class="col-6 col-md-3"><div class="premium-card border-primary border-opacity-50"><span class="stat-label text-glow-purple">Puissance Totale</span><div class="stat-numb text-glow-purple text-truncate" id="val-total-base" style="font-size: 1.5rem">{{ "%.2f"|format(total_base_cash) }}‚Ç¨</div></div></div>
        </div>
        <h3 class="fw-bold text-white mb-4">Projections de Croissance</h3>
        <div class="row g-3 mb-5 text-center">
            <div class="col-12 col-md-4"><div class="premium-card"><span class="stat-label">Horizon 7 Jours</span><div class="stat-numb text-white text-truncate" id="proj-7d">--‚Ç¨</div></div></div>
            <div class="col-12 col-md-4"><div class="premium-card border-success border-opacity-25"><span class="stat-label text-success">Horizon 30 Jours</span><div class="stat-numb text-white text-truncate" id="proj-30d">--‚Ç¨</div></div></div>
            <div class="col-12 col-md-4"><div class="premium-card border-warning border-opacity-25"><span class="stat-label text-warning">Horizon 1 An</span><div class="stat-numb text-white text-truncate" id="proj-365d">--‚Ç¨</div></div></div>
        </div>
        <div class="premium-card mb-5" style="background: rgba(138, 43, 226, 0.05); border-left: 4px solid var(--primary-glow);">
            <div class="d-flex align-items-center mb-3"><i class="bi bi-robot text-primary fs-3 me-3"></i><h5 class="text-white fw-bold m-0 text-uppercase small">AVIS DE L'EXPERT</h5></div>
            <p id="finance-expert-advice" class="expert-text text-white-50 mb-0">Analyse de la solvabilit√©...</p>
        </div>
    </div>

    <div id="tab-goals" class="tab-pane">
        <div class="d-flex flex-wrap justify-content-between align-items-end mb-4 gap-3">
            <div><h3 class="fw-bold text-white mb-1">Objectifs Performance</h3><p class="text-muted small">Analyse sur la p√©riode : <strong>{{ period|capitalize }}</strong></p></div>
            {% if has_ref %}<div class="bg-white bg-opacity-5 p-1 rounded-3 d-flex gap-1"><button onclick="setGoalCoef(1.2)" id="btn-low" class="period-btn active">Prudent (x1.2)</button><button onclick="setGoalCoef(1.8)" id="btn-high" class="period-btn">Aggressif (x1.8)</button></div>{% endif %}
        </div>
        <div class="row g-4">
            <div class="col-md-6"><div class="premium-card"><div class="d-flex justify-content-between mb-2"><span class="stat-label">Cible Chiffre d'Affaires</span><span id="badge-rev-reached" class="badge bg-success text-dark d-none">PALIER FRANCHI</span></div><div class="d-flex justify-content-between flex-wrap"><div class="stat-numb text-white text-truncate" id="goal-rev-val">-- ‚Ç¨</div><div class="text-end"><div class="text-primary fw-bold" id="goal-rev-percent">0%</div><div class="text-muted small" id="goal-rev-rem">Gap: -- ‚Ç¨</div></div></div><div class="progress-custom mt-3"><div id="progress-rev" class="progress-bar-glow h-100 bg-primary" style="width: 0%"></div></div></div></div>
            <div class="col-md-6"><div class="premium-card"><div class="d-flex justify-content-between mb-2"><span class="stat-label">Cible B√©n√©fice Net</span><span id="badge-prof-reached" class="badge bg-success text-dark d-none">RENTABILIT√â VALID√âE</span></div><div class="d-flex justify-content-between flex-wrap"><div class="stat-numb text-success text-truncate" id="goal-prof-val">-- ‚Ç¨</div><div class="text-end"><div class="text-success fw-bold" id="goal-prof-percent">0%</div><div class="text-muted small" id="goal-prof-rem">Gap: -- ‚Ç¨</div></div></div><div class="progress-custom mt-3"><div id="progress-prof" class="progress-bar-glow h-100 bg-success" style="width: 0%"></div></div></div></div>
        </div>
    </div>

    <div id="tab-stock" class="tab-pane">
        <h3 class="fw-bold text-white mb-4">Analyse de l'Inventaire</h3>
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-4"><div class="premium-card text-center"><span class="stat-label">Capital Immobilis√© (Achat)</span><div class="stat-numb text-truncate" style="font-size: 1.6rem">{{ "%.2f"|format(valeur_achat_stock) }}‚Ç¨</div></div></div>
            <div class="col-6 col-md-4"><div class="premium-card text-center border-success border-opacity-25"><span class="stat-label text-success">Plus-value Potentielle <i class="bi bi-question-circle help-icon" onclick="openHelp('profit-latent')"></i></span><div class="stat-numb text-success text-truncate" style="font-size: 1.6rem">+{{ "%.2f"|format(profit_latent) }}‚Ç¨</div></div></div>
            <div class="col-6 col-md-4"><div class="premium-card text-center border-primary border-opacity-25"><span class="stat-label text-glow-purple">Vente Latente (CA)</span><div class="stat-numb text-white text-truncate" style="font-size: 1.6rem">{{ "%.2f"|format(ca_latent) }}‚Ç¨</div></div></div>
        </div>
        <div class="row g-4">
            <div class="col-md-4"><div class="premium-card"><h6 class="stat-label mb-3">Sant√© du Stock</h6><div class="d-flex justify-content-between mb-3"><span class="small text-white-50">Temps de d√©tention :</span><span class="badge {% if stock_avg_age > 45 %}bg-danger{% else %}bg-success{% endif %} px-3">{{ stock_avg_age }}j</span></div><div class="d-flex justify-content-between"><span class="small text-white-50">R√©investissement :</span><span class="fw-bold text-white">{{ "%.0f"|format(ca_latent * 0.85) }}‚Ç¨</span></div></div></div>
            <div class="col-md-8"><div class="premium-card" style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.15), transparent); border-left: 4px solid var(--primary-glow);"><h5 class="text-white fw-bold mb-3 text-uppercase small"><i class="bi bi-robot me-2 text-primary"></i>AVIS DE L'EXPERT</h5><p id="stock-expert-advice" class="expert-text text-white-50 mb-0">Audit du catalogue...</p></div></div>
        </div>
    </div>

    <div id="tab-history" class="tab-pane">
        <h3 class="fw-bold text-white mb-4">D√©tails des transactions</h3>
        <div class="premium-card"><div class="table-responsive"><table class="table table-premium align-middle" style="min-width: 700px;"><thead><tr class="text-muted small uppercase"><th>DATE</th><th>ARTICLE</th><th>PRIX VENTE</th><th>PROFIT NET</th><th>ROI %</th></tr></thead><tbody>{% for sale in sales %}<tr><td class="text-muted small">{{ sale.sale_date.strftime('%d/%m/%Y') }}</td><td><div class="d-flex align-items-center"><div style="width: 45px; height: 45px; background: white; border-radius: 10px; padding: 4px; margin-right: 15px; flex-shrink: 0;"><img src="{{ sale.image_url }}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.src='/static/placeholder.png'"></div><div><div class="fw-bold small">{{ sale.item_name }}</div><div class="text-muted" style="font-size: 0.7rem;">{{ sale.sku }}</div></div></div></td><td class="fw-bold">{{ "%.2f"|format(sale.sale_price) }}‚Ç¨</td><td class="text-success fw-bold">+{{ "%.2f"|format(sale.profit) }}‚Ç¨</td><td><span class="badge bg-secondary bg-opacity-25 text-white">{{ "%.0f"|format((sale.profit / sale.purchase_price_at_sale * 100) if sale.purchase_price_at_sale > 0 else 0) }}%</span></td></tr>{% endfor %}</tbody></table></div></div>
    </div>
</div>

<script>
    function showTab(e, id) {
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).classList.add('active'); e.currentTarget.classList.add('active');
    }

    const staticStock = parseFloat("{{ valeur_achat_stock }}") || 0;
    const staticPending = parseFloat("{{ pending_payments }}") || 0;
    const dailyProf = parseFloat("{{ (profit / 7) if period == 'week' else (profit / 30) if period == 'month' else (profit / 365) if period == 'year' else profit }}") || 0;
    const hScore = parseInt("{{ health_score }}") || 0;
    const roiAvg = parseFloat("{{ roi_avg }}") || 0;
    const vol = parseInt("{{ volume }}") || 0;

    // --- LOGIQUE AVIS EXPERT : DASHBOARD (STRAT√âGIE GLOBALE) ---
    function updateDashboardAdvice() {
        let adv = "";
        if (hScore >= 9 && roiAvg >= 30) {
            adv = `üî• MOD√àLE √âLITE : Votre efficacit√© est redoutable. Avec un ROI de ${roiAvg}%, chaque euro investi travaille dur. Recommandation : Ne changez rien √† vos crit√®res d'achat, mais cherchez √† augmenter le volume de 20% pour d√©cupler vos profits sans sacrifier la marge.`;
        } else if (hScore >= 7 && vol < 3) {
            adv = `üíé BOUTIQUE DE LUXE : Vous avez l'≈ìil pour les p√©pites, mais votre activit√© manque de souffle. Votre s√©lection est ultra-qualitative mais trop rare. Pour passer au niveau sup√©rieur, vous devez accepter des marges l√©g√®rement plus faibles sur des mod√®les √† rotation plus rapide (Quick Flips).`;
        } else if (hScore >= 5 && roiAvg < 15) {
            adv = `‚öñÔ∏è LE GRINDER : Vous g√©n√©rez du volume, mais vos marges sont compress√©es. Vous travaillez probablement sur des mod√®les trop "mass market" o√π la concurrence est f√©roce. Strat√©gie : Allouez 30% de votre budget √† des paires plus exclusives pour faire remonter votre ROI moyen au-dessus de 20%.`;
        } else if (hScore < 4) {
            adv = `‚ö†Ô∏è AUDIT D'URGENCE : Votre score de sant√© est critique. Votre capital s'√©rode soit par des frais cach√©s, soit par un stock qui perd de la valeur. Arr√™tez tout achat imm√©diat. Vendez vos paires les moins rentables pour s√©curiser du cash et repartez sur une base saine.`;
        } else if (dailyProf < 0) {
            adv = `üìâ PHASE D'INVESTISSEMENT : Vos r√©sultats actuels sont dans le rouge, ce qui est normal si vous venez de constituer un gros stock. L'enjeu est maintenant la revente. Surveillez votre 'Break-even point' pour ne pas transformer ce stock en passif financier.`;
        } else {
            adv = `üìà CROISSANCE R√âGULI√àRE : Votre profil est √©quilibr√©. L'historique montre une gestion saine. C'est le moment id√©al pour tester un nouveau segment de march√© (ex: passer du lifestyle au performance) avec une petite partie de votre capital.`;
        }
        document.getElementById('dashboard-expert-advice').innerText = adv;
    }

    // --- LOGIQUE AVIS EXPERT : FINANCES (RISQUES & CASHFLOW) ---
    function updateFinances() {
        const cash = parseFloat(document.getElementById('input-cash').value) || 0;
        const total = cash + staticStock + staticPending;
        document.getElementById('val-total-base').innerText = total.toFixed(2) + "‚Ç¨";

        const p30 = total + (dailyProf * 30);
        document.getElementById('proj-7d').innerText = (total + (dailyProf * 7)).toFixed(2) + "‚Ç¨";
        document.getElementById('proj-30d').innerText = p30.toFixed(2) + "‚Ç¨";
        document.getElementById('proj-365d').innerText = Math.round(total + (dailyProf * 365)).toLocaleString() + "‚Ç¨";

        const growth = (dailyProf * 30 / total * 100).toFixed(1);
        const sWeight = (staticStock / total * 100).toFixed(0);
        let adv = "";

        if (sWeight > 85) {
            adv = `üö® RISQUE D'ASPHYXIE : ${sWeight}% de votre argent est bloqu√© dans des bo√Ætes. En cas de p√©pin personnel ou de baisse du march√©, vous n'avez aucune marge de man≈ìuvre. Vendez 3 paires "faciles" d√®s demain pour remonter votre cash disponible √† au moins 25%.`;
        } else if (cash > total * 0.6 && dailyProf < 1) {
            adv = `üí§ CAPITAL DORMAN–¢ : Vous avez trop de cash (${cash.toFixed(0)}‚Ç¨) qui ne produit rien. Votre argent perd de la valeur chaque jour. C'est le moment d'√™tre agressif sur les achats, vous avez le "war chest" n√©cessaire pour √©craser la concurrence sur les ench√®res.`;
        } else if (dailyProf > 0 && growth > 15) {
            adv = `üöÄ HYPER-CROISSANCE : Votre rythme de ${growth}% par mois est exceptionnel. √Ä ce stade, le danger est l'erreur humaine. Automatisez vos processus (suivi, listings, envois) pour que votre structure puisse supporter cette mont√©e en puissance financi√®re.`;
        } else if (staticPending > total * 0.3) {
            adv = `‚è≥ EXPOSITION AUX PLATEFORMES : Une trop grande partie de votre argent (${staticPending.toFixed(0)}‚Ç¨) est bloqu√©e en attente de paiement. Diversifiez vos canaux de vente (Vinted, Main propre) pour recevoir votre argent plus rapidement.`;
        } else {
            adv = `üõ°Ô∏è GESTION PRUDENTE : Votre ratio cash/stock est optimal. Vous pouvez encaisser une baisse du march√© tout en gardant une capacit√© d'achat. C'est la configuration parfaite pour durer sur le long terme.`;
        }
        document.getElementById('finance-expert-advice').innerText = adv;
    }

    // --- LOGIQUE AVIS EXPERT : STOCK (ROTATION & VALEUR) ---
    function updateStockAdvice() {
        const age = parseInt("{{ stock_avg_age }}") || 0;
        const pLat = parseFloat("{{ profit_latent }}") || 0;
        const vAch = parseFloat("{{ valeur_achat_stock }}") || 0;
        const pot = vAch > 0 ? (pLat / vAch * 100).toFixed(1) : 0;
        let adv = "";

        if (age > 50 && pot < 15) {
            adv = `üèöÔ∏è STOCK MORT : Vos paires stagnent depuis ${age} jours pour une marge d√©risoire. Elles prennent de la place et bloquent votre capital. Liquidez tout au prix co√ªtant. Utilisez cet argent pour acheter des mod√®les qui tournent en moins de 15 jours.`;
        } else if (age < 20 && pot > 25) {
            adv = `‚ö° THE TURBO-FLIPPER : Vous achetez des paires qui s'arrachent instantan√©ment avec une marge √©norme. C'est le Graal du resell. Analyse : Vous avez trouv√© une niche ou un fournisseur sous-estim√©. Doublez la mise sur ce segment pr√©cis.`;
        } else if (age > 60 && pot > 40) {
            adv = `üç∑ L'INVESTISSEUR PATIENT : Votre stock est ancien mais sa valeur explose avec le temps. Vous faites du 'Holding'. C'est rentable, mais attention : si vous avez besoin de cash rapidement, vous devrez brader vos p√©pites. Gardez toujours 20% de stock √† rotation rapide √† c√¥t√©.`;
        } else if (pot < 5) {
            adv = `‚ö†Ô∏è DANGER DE MARGE : Votre profit latent est de seulement ${pot}%. Entre les frais d'envoi, les plateformes et les √©ventuels retours, vous risquez de travailler gratuitement. Rehaussez vos prix de vente ou n√©gociez mieux vos prix d'achat.`;
        } else {
            adv = `üì¶ INVENTAIRE SAIN : Rotation moyenne de ${age} jours avec un potentiel de +${pLat.toFixed(0)}‚Ç¨ de b√©n√©fice. Votre stock est √©quilibr√©. Pensez simplement √† v√©rifier si certaines paires ne commencent pas √† "prendre la poussi√®re".`;
        }
        document.getElementById('stock-expert-advice').innerText = adv;
    }

    // --- LOGIQUE OBJECTIFS ---
    let currentGoalCoef = 1.2;
    const baseRefRev = parseFloat("{{ ref_rev }}") || 0;
    const baseRefProf = parseFloat("{{ ref_prof }}") || 0;
    const actualRevenue = parseFloat("{{ revenue }}") || 0;
    const actualProfit = parseFloat("{{ profit }}") || 0;

    function setGoalCoef(c) { currentGoalCoef = c; updateGoalsUI(); }
    function updateGoalsUI() {
        if (!{{ has_ref|tojson }}) return;
        const targetRev = baseRefRev * currentGoalCoef;
        const targetProf = baseRefProf * currentGoalCoef;
        const revP = Math.min(100, (actualRevenue / targetRev) * 100);
        document.getElementById('goal-rev-val').innerText = Math.round(targetRev).toLocaleString() + " ‚Ç¨";
        document.getElementById('goal-rev-percent').innerText = Math.round(revP) + "%";
        document.getElementById('goal-rev-rem').innerText = (targetRev - actualRevenue) > 0 ? `Gap: ${Math.round(targetRev - actualRevenue)}‚Ç¨` : "Quota franchi";
        document.getElementById('progress-rev').style.width = revP + "%";
        document.getElementById('badge-rev-reached').classList.toggle('d-none', actualRevenue < targetRev);
        const profP = Math.min(100, (actualProfit / targetProf) * 100);
        document.getElementById('goal-prof-val').innerText = Math.round(targetProf).toLocaleString() + " ‚Ç¨";
        document.getElementById('goal-prof-percent').innerText = Math.round(profP) + "%";
        document.getElementById('goal-prof-rem').innerText = (targetProf - actualProfit) > 0 ? `Gap: ${Math.round(targetProf - actualProfit)}‚Ç¨` : "Objectif valid√©";
        document.getElementById('progress-prof').style.width = profP + "%";
        document.getElementById('badge-prof-reached').classList.toggle('d-none', actualProfit < targetProf);
        document.getElementById('btn-low').classList.toggle('active', currentGoalCoef === 1.2);
        document.getElementById('btn-high').classList.toggle('active', currentGoalCoef === 1.8);
    }

    function openHelp(id) { document.getElementById('overlay-' + id).style.display = 'flex'; }
    function closeHelp(id) { document.getElementById('overlay-' + id).style.display = 'none'; }

    const ctx = document.getElementById('evolutionChart').getContext('2d');
    new Chart(ctx, { type: 'line', data: { labels: [{% for s in sales %}"{{ s.sale_date.strftime('%d/%m') }}",{% endfor %}], datasets: [{ label: 'Ventes', data: [{% for s in sales %}{{ s.sale_price }},{% endfor %}], borderColor: '#8a2be2', backgroundColor: 'rgba(138, 43, 226, 0.1)', fill: true, tension: 0.4, borderWidth: 3 }, { label: 'B√©n√©fice', data: [{% for s in sales %}{{ s.profit }},{% endfor %}], borderColor: '#00ffa3', borderDash: [5, 5], fill: false, tension: 0.4, borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8e9297' } }, x: { grid: { display: false }, ticks: { color: '#8e9297' } } } } });

    updateDashboardAdvice(); updateFinances(); updateGoalsUI(); updateStockAdvice();
</script>
{% endblock %}