{% extends 'base.html' %}

{% block title %}Statistiques | ResellNotion{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        --glass-bg: rgba(255, 255, 255, 0.03);
        --glass-border: rgba(255, 255, 255, 0.08);
        --primary-glow: #8a2be2;
        --success-glow: #00ffa3;
        --danger-glow: #ff4d4d;
        --warning-glow: #ffcc00;
    }

    body {
        background: #0b0e14;
        background-image:
            radial-gradient(circle at 0% 0%, rgba(138, 43, 226, 0.1) 0%, transparent 35%),
            radial-gradient(circle at 100% 100%, rgba(0, 255, 163, 0.05) 0%, transparent 35%);
        color: #f8f9fa;
        font-family: 'Plus Jakarta Sans', sans-serif;
        min-height: 100vh;
    }

    .stats-container { padding: 30px; }

    /* --- NAVIGATION PAR ONGLETS --- */
    .nav-tabs-premium {
        display: flex; gap: 10px; margin-bottom: 30px; padding: 5px;
        background: rgba(255,255,255,0.03); border-radius: 18px;
        border: 1px solid var(--glass-border);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }
    .nav-tabs-premium::-webkit-scrollbar { display: none; }

    .nav-tabs-premium .tab-link {
        padding: 12px 24px; border-radius: 14px; color: #8e9297; font-weight: 600;
        font-size: 0.9rem; cursor: pointer; transition: 0.3s; white-space: nowrap;
        border: none; background: transparent;
    }
    .nav-tabs-premium .tab-link.active { background: var(--primary-glow); color: white; box-shadow: 0 0 15px rgba(138, 43, 226, 0.3); }

    .tab-pane { display: none; }
    .tab-pane.active { display: block; animation: fadeInUp 0.4s ease-out forwards; }

    /* --- CARDS & STATS --- */
    .premium-card {
        background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 24px;
        padding: 24px; transition: 0.4s all; height: 100%; backdrop-filter: blur(10px);
    }
    .stat-label { color: #8e9297; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .stat-numb { font-size: 2rem; font-weight: 700; margin-top: 5px; color: #fff; }
    .text-glow-purple { color: #fff; text-shadow: 0 0 15px rgba(138, 43, 226, 0.4); }
    .text-glow-green { color: var(--success-glow); text-shadow: 0 0 15px rgba(0, 255, 163, 0.3); }
    .text-glow-red { color: var(--danger-glow); text-shadow: 0 0 15px rgba(255, 77, 77, 0.4); }

    .period-btn {
        background: var(--glass-bg); border: 1px solid var(--glass-border); color: #8e9297;
        padding: 10px 18px; border-radius: 14px; text-decoration: none; transition: 0.3s;
        font-size: 0.85rem; font-weight: 600; cursor: pointer;
    }
    .period-btn.active { background: var(--primary-glow); color: white; border: none; }
    .custom-input { background: var(--glass-bg) !important; border: 1px solid var(--glass-border) !important; color: #fff !important; border-radius: 12px; padding: 8px 12px; }

    .progress-custom { height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; position: relative; }
    .progress-bar-glow { box-shadow: 0 0 10px currentColor; transition: width 1s ease-in-out; }
    .health-circle { width: 120px; height: 120px; border-radius: 50%; border: 6px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; margin: 0 auto; position: relative; }

    .table-premium { border-collapse: separate; border-spacing: 0 8px; }
    .table-premium tr { background: var(--glass-bg); }
    .table-premium td, .table-premium th { border: none !important; padding: 16px !important; color: #f8f9fa; }

    .expert-text { font-size: 1.15rem; line-height: 1.7; font-weight: 400; }
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center; }
    .overlay-content { background: #161a2b; padding: 35px; border-radius: 24px; max-width: 600px; width: 90%; border: 1px solid var(--glass-border); position: relative; max-height: 90vh; overflow-y: auto; }

    /* --- CARDS STOCK INDIVIDUELLES (OVERLAY) --- */
    .stock-focus-card {
        background: rgba(255, 255, 255, 0.02); border: 1px solid var(--glass-border); border-radius: 20px;
        padding: 16px; display: flex; align-items: center; gap: 18px; transition: 0.3s;
        margin-bottom: 15px;
    }
    .stock-img-box { width: 85px; height: 85px; background: #fff; border-radius: 14px; padding: 8px; flex-shrink: 0; }
    .stock-img-box img { width: 100%; height: 100%; object-fit: contain; }
    .stock-info-box { flex-grow: 1; min-width: 0; }
    .stock-tag { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 800; margin-bottom: 4px; display: block; }
    .stock-name { font-size: 1rem; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .stock-meta { font-size: 0.75rem; color: #8e9297; display: flex; gap: 12px; margin-top: 4px; }
    .stock-price-tag { font-size: 1.2rem; font-weight: 800; color: #fff; margin-left: auto; }

    .btn-focus-trigger {
        background: rgba(138, 43, 226, 0.1); border: 1px dashed var(--primary-glow); color: #fff;
        padding: 12px; border-radius: 16px; font-size: 0.8rem; font-weight: 700; cursor: pointer;
        width: 100%; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-focus-trigger:hover { background: var(--primary-glow); border-style: solid; box-shadow: 0 0 15px var(--primary-glow); }

    /* --- ANALYTIQUE SUB-NAV --- */
    .analytique-nav { display: flex; gap: 10px; margin-bottom: 25px; }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    h1 { font-size: clamp(1.5rem, 5vw, 2.5rem); }
    @media (max-width: 768px) { .stats-container { padding: 15px; } .stat-numb { font-size: 1.4rem !important; } }
</style>

<div id="overlay-health" class="overlay"><div class="overlay-content"><span class="btn-close btn-close-white position-absolute top-0 end-0 m-3" onclick="closeHelp('health')"></span><h4 class="text-white fw-bold mb-3">Health Score</h4><p class="small text-muted">Analyse de la rentabilité et du flux.</p></div></div>
<div id="overlay-profit-latent" class="overlay"><div class="overlay-content"><span class="btn-close btn-close-white position-absolute top-0 end-0 m-3" onclick="closeHelp('profit-latent')"></span><h4 class="text-white fw-bold mb-3">Profit Latent</h4><p class="small text-muted">Bénéfice net contenu dans votre stock actuel.</p></div></div>
<div id="overlay-stock-focus" class="overlay">
    <div class="overlay-content">
        <span class="btn-close btn-close-white position-absolute top-0 end-0 m-3" onclick="closeHelp('stock-focus')"></span>
        <h4 class="text-white fw-bold mb-4"><i class="bi bi-bullseye me-2 text-primary"></i>Focus Actifs Spécifiques</h4>
        <div class="mb-4">
            {% if oldest_pair %}
            <div class="stock-focus-card">
                <div class="stock-img-box"><img src="{{ oldest_pair.image_url }}" onerror="this.src='/static/placeholder.png'"></div>
                <div class="stock-info-box">
                    <span class="stock-tag text-danger">Unité la plus ancienne</span>
                    <div class="stock-name">{{ oldest_pair.name }}</div>
                    <div class="stock-meta"><span>SKU: {{ oldest_pair.sku }}</span><span>Taille: {{ oldest_pair.size }}</span></div>
                    <div class="mt-2"><span class="badge bg-danger bg-opacity-25 text-danger">{{ oldest_pair.age }} JOURS</span></div>
                </div>
                <div class="stock-price-tag">{{ "%.0f"|format(oldest_pair.purchase_price) }}€</div>
            </div>
            {% endif %}
            {% for p in expensive_pairs %}
            <div class="stock-focus-card">
                <div class="stock-img-box"><img src="{{ p.image_url }}" onerror="this.src='/static/placeholder.png'"></div>
                <div class="stock-info-box">
                    <span class="stock-tag" style="color: var(--primary-glow);">Actif haute valeur</span>
                    <div class="stock-name">{{ p.name }}</div>
                    <div class="stock-meta"><span>SKU: {{ p.sku }}</span><span>Taille: {{ p.size }}</span></div>
                    <div class="mt-2"><span class="badge bg-white bg-opacity-10 text-white-50">{{ p.age }} JOURS</span></div>
                </div>
                <div class="stock-price-tag">{{ "%.0f"|format(p.purchase_price) }}€</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="stats-container">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-4">
        <div>
            <h1 class="fw-bold text-white mb-1">Rapport de Performance</h1>
            <p class="text-muted small">Intelligence de Marché & Flux Financiers</p>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center bg-dark bg-opacity-25 p-2 rounded-4 border border-white border-opacity-10 w-100 w-md-auto justify-content-center">
            <div class="d-flex gap-1 justify-content-center w-100 w-md-auto">
                <a href="?period=day" class="period-btn {{ 'active' if period == 'day' }}">Jour</a>
                <a href="?period=week" class="period-btn {{ 'active' if period == 'week' }}">Sem.</a>
                <a href="?period=month" class="period-btn {{ 'active' if period == 'month' }}">Mois</a>
                <a href="?period=year" class="period-btn {{ 'active' if period == 'year' }}">An</a>
            </div>
            <form action="/statistics" method="GET" class="d-flex flex-wrap gap-1 align-items-center justify-content-center w-100 w-md-auto">
                <input type="hidden" name="period" value="custom">
                <input type="date" name="start_date" value="{{ start_date }}" class="custom-input flex-grow-1" required>
                <input type="date" name="end_date" value="{{ end_date }}" class="custom-input flex-grow-1" required>
                <button type="submit" class="period-btn"><i class="bi bi-search"></i></button>
            </form>
        </div>
    </div>

    <nav class="nav-tabs-premium">
        <button class="tab-link active" onclick="showTab(event, 'tab-dashboard')">Dashboard</button>
        <button class="tab-link" onclick="showTab(event, 'tab-finances')">Finances</button>
        <button class="tab-link" onclick="showTab(event, 'tab-goals')">Objectifs</button>
        <button class="tab-link" onclick="showTab(event, 'tab-stock')">Stock</button>
        <button class="tab-link" onclick="showTab(event, 'tab-analytique')">Analytique</button>
        <button class="tab-link" onclick="showTab(event, 'tab-history')">Historique</button>
    </nav>

    <div id="tab-dashboard" class="tab-pane active">
        <div class="row g-3 g-md-4 mb-5">
            <div class="col-6 col-md-3"><div class="premium-card text-center"><span class="stat-label">Health <i class="bi bi-question-circle help-icon" onclick="openHelp('health')"></i></span><div class="health-circle mt-3" style="border-color: {% if health_score > 7 %}var(--success-glow){% elif health_score > 4 %}var(--warning-glow){% else %}var(--danger-glow){% endif %};"><div class="score-inner text-white">{{ health_score }}<span style="font-size: 0.9rem; opacity: 0.5;">/10</span></div></div></div></div>
            <div class="col-6 col-md-3"><div class="premium-card"><span class="stat-label">CA Période</span><div class="stat-numb text-white text-truncate">{{ "%.2f"|format(revenue) }}€</div><div class="text-muted small mt-2">{{ volume }} ventes</div></div></div>
            <div class="col-6 col-md-3"><div class="premium-card"><span class="stat-label">Bénéfice Brut</span><div class="stat-numb {% if profit >= 0 %}text-glow-green{% else %}text-glow-red{% endif %} text-truncate">{% if profit >= 0 %}+{% endif %}{{ "%.2f"|format(profit) }}€</div><div class="text-muted small mt-2">ROI: {{ "%.1f"|format(roi_avg) }}%</div></div></div>
            <div class="col-6 col-md-3"><div class="premium-card border-warning border-opacity-25"><span class="stat-label">Valeur Stock</span><div class="stat-numb text-truncate" style="color: var(--warning-glow)">{{ "%.0f"|format(stock_value) }}€</div><div class="text-muted small mt-2">{{ stock_qty }} paires</div></div></div>
        </div>
        <div class="row g-4">
            <div class="col-lg-8"><div class="premium-card"><h6 class="stat-label mb-4">Évolution des Flux</h6><div style="height: 350px;"><canvas id="evolutionChart"></canvas></div></div></div>
            <div class="col-lg-4"><div class="premium-card" style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.15), transparent); border-left: 4px solid var(--primary-glow);"><h5 class="text-white fw-bold mb-3 text-uppercase small"><i class="bi bi-robot me-2" style="color: var(--primary-glow)"></i>AVIS DE L'EXPERT</h5><p id="dashboard-expert-advice" class="expert-text text-white-50">Diagnostic stratégique en cours...</p></div></div>
        </div>
    </div>

    <div id="tab-finances" class="tab-pane">
        <h3 class="fw-bold text-white mb-4">État Financier</h3>
        <div class="row g-3 mb-5">
            <div class="col-6 col-md-3"><div class="premium-card"><span class="stat-label">Liquidités (Cash)</span><div class="mt-2"><div class="input-group input-group-sm"><input type="number" id="input-cash" value="{{ current_cash }}" class="form-control custom-input fw-bold fs-5 text-white" oninput="updateFinances()" style="background: rgba(255,255,255,0.05) !important;"><span class="input-group-text bg-transparent border-0 text-white-50">€</span></div></div></div></div>
            <div class="col-6 col-md-3"><div class="premium-card"><span class="stat-label">Stock (Achat)</span><div class="stat-numb text-truncate" style="font-size: 1.5rem">{{ "%.2f"|format(valeur_achat_stock) }}€</div></div></div>
            <div class="col-6 col-md-3"><div class="premium-card border-warning border-opacity-25"><span class="stat-label text-warning">En Attente</span><div class="stat-numb text-truncate" style="font-size: 1.5rem">{{ "%.2f"|format(pending_payments) }}€</div></div></div>
            <div class="col-6 col-md-3"><div class="premium-card border-primary border-opacity-50"><span class="stat-label text-glow-purple">Puissance Totale</span><div class="stat-numb text-glow-purple text-truncate" id="val-total-base" style="font-size: 1.5rem">{{ "%.2f"|format(total_base_cash) }}€</div></div></div>
        </div>

        <h3 class="fw-bold text-white mb-4">Projections de Capital (ROI Global)</h3>
        <div class="row g-3 mb-5 text-center">
            <div class="col-12 col-md-4"><div class="premium-card"><span class="stat-label">Projection 1 Mois</span><div class="stat-numb text-white text-truncate" id="proj-roi-1m">--€</div></div></div>
            <div class="col-12 col-md-4"><div class="premium-card border-success border-opacity-25"><span class="stat-label text-success">Projection 3 Mois</span><div class="stat-numb text-white text-truncate" id="proj-roi-3m">--€</div></div></div>
            <div class="col-12 col-md-4"><div class="premium-card border-warning border-opacity-25"><span class="stat-label text-warning">Projection 1 An</span><div class="stat-numb text-white text-truncate" id="proj-roi-1y">--€</div></div></div>
        </div>

        <div class="premium-card mb-5" style="background: rgba(138, 43, 226, 0.05); border-left: 4px solid var(--primary-glow);"><h5 class="text-white fw-bold mb-3 text-uppercase small"><i class="bi bi-robot text-primary me-2"></i>AVIS DE L'EXPERT</h5><p id="finance-expert-advice" class="expert-text text-white-50 mb-0">Analyse de la solvabilité...</p></div>
    </div>

    <div id="tab-goals" class="tab-pane">
        <div class="d-flex flex-wrap justify-content-between align-items-end mb-4 gap-3">
            <div><h3 class="fw-bold text-white mb-1">Objectifs Performance</h3><p class="text-muted small">Analyse sur la période : <strong>{{ period|capitalize }}</strong></p></div>
            {% if has_ref %}<div class="bg-white bg-opacity-5 p-1 rounded-3 d-flex gap-1"><button onclick="setGoalCoef(1.2)" id="btn-low" class="period-btn active">Prudent (x1.2)</button><button onclick="setGoalCoef(1.8)" id="btn-high" class="period-btn">Aggressif (x1.8)</button></div>{% endif %}
        </div>
        <div class="row g-4">
            <div class="col-md-6"><div class="premium-card"><div class="d-flex justify-content-between mb-2"><span class="stat-label">Cible Chiffre d'Affaires</span><span id="badge-rev-reached" class="badge bg-success text-dark d-none">PALIER FRANCHI</span></div><div class="d-flex justify-content-between flex-wrap"><div class="stat-numb text-white text-truncate" id="goal-rev-val">-- €</div><div class="text-end"><div class="text-primary fw-bold" id="goal-rev-percent">0%</div><div class="text-muted small" id="goal-rev-rem">Gap: -- €</div></div></div><div class="progress-custom mt-3"><div id="progress-rev" class="progress-bar-glow h-100 bg-primary" style="width: 0%"></div></div></div></div>
            <div class="col-md-6"><div class="premium-card"><div class="d-flex justify-content-between mb-2"><span class="stat-label">Cible Bénéfice Net</span><span id="badge-prof-reached" class="badge bg-success text-dark d-none">RENTABILITÉ VALIDÉE</span></div><div class="d-flex justify-content-between flex-wrap"><div class="stat-numb text-success text-truncate" id="goal-prof-val">-- €</div><div class="text-end"><div class="text-success fw-bold" id="goal-prof-percent">0%</div><div class="text-muted small" id="goal-prof-rem">Gap: -- €</div></div></div><div class="progress-custom mt-3"><div id="progress-prof" class="progress-bar-glow h-100 bg-success" style="width: 0%"></div></div></div></div>
        </div>
    </div>

    <div id="tab-stock" class="tab-pane">
        <h3 class="fw-bold text-white mb-4">Analyse de l'Inventaire</h3>
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-4"><div class="premium-card text-center"><span class="stat-label">Capital Immobilisé (Achat)</span><div class="stat-numb text-truncate" style="font-size: 1.6rem">{{ "%.2f"|format(valeur_achat_stock) }}€</div></div></div>
            <div class="col-6 col-md-4"><div class="premium-card text-center border-success border-opacity-25"><span class="stat-label text-success">Plus-value Potentielle <i class="bi bi-question-circle help-icon" onclick="openHelp('profit-latent')"></i></span><div class="stat-numb text-success text-truncate" style="font-size: 1.6rem">+{{ "%.2f"|format(profit_latent) }}€</div></div></div>
            <div class="col-6 col-md-4"><div class="premium-card text-center border-primary border-opacity-25"><span class="stat-label text-glow-purple">Vente Latente (CA)</span><div class="stat-numb text-white text-truncate" style="font-size: 1.6rem">{{ "%.2f"|format(ca_latent) }}€</div></div></div>
        </div>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="premium-card d-flex flex-column justify-content-between">
                    <div>
                        <h6 class="stat-label mb-3">Santé du Stock</h6>
                        <div class="d-flex justify-content-between mb-3"><span class="small text-white-50">Temps de détention :</span><span class="badge {% if stock_avg_age > 45 %}bg-danger{% else %}bg-success{% endif %} px-3">{{ stock_avg_age }}j</span></div>
                        <div class="d-flex justify-content-between mb-4"><span class="small text-white-50">Réinvestissement :</span><span class="fw-bold text-white">{{ "%.0f"|format(ca_latent * 0.85) }}€</span></div>
                    </div>
                    <button class="btn-focus-trigger" onclick="openHelp('stock-focus')"><i class="bi bi-eye-fill"></i> VOIR LES ACTIFS CRITIQUES</button>
                </div>
            </div>
            <div class="col-md-8"><div class="premium-card" style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.15), transparent); border-left: 4px solid var(--primary-glow);"><h5 class="text-white fw-bold mb-3 text-uppercase small"><i class="bi bi-robot me-2 text-primary"></i>AVIS DE L'EXPERT</h5><p id="stock-expert-advice" class="expert-text text-white-50 mb-0">Audit du catalogue...</p></div></div>
        </div>
    </div>

    <div id="tab-analytique" class="tab-pane">
        <h3 class="fw-bold text-white mb-4">Analytique de Distribution</h3>
        <div class="analytique-nav">
            <button class="period-btn active" onclick="switchAnalytique(this, 'days')">Par Jour</button>
            <button class="period-btn" onclick="switchAnalytique(this, 'sizes')">Par Taille</button>
            <button class="period-btn" onclick="switchAnalytique(this, 'platforms')">Par Plateforme</button>
        </div>
        <div class="row g-4">
            <div class="col-lg-8"><div class="premium-card"><h6 class="stat-label mb-4" id="analytique-chart-title">Répartition par Jour</h6><div style="height: 380px;"><canvas id="analytiqueChart"></canvas></div></div></div>
            <div class="col-lg-4">
                <div class="premium-card" style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.15), transparent); border-left: 4px solid var(--primary-glow);">
                    <h5 class="text-white fw-bold mb-3 text-uppercase small"><i class="bi bi-robot me-2 text-primary"></i>ANALYSE SECTORIELLE</h5>
                    <p id="analytique-expert-advice" class="expert-text text-white-50">Sélectionnez un segment pour analyse...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-history" class="tab-pane">
        <h3 class="fw-bold text-white mb-4">Historique</h3>
        <div class="premium-card"><div class="table-responsive"><table class="table table-premium align-middle"><thead><tr class="text-muted small uppercase"><th>DATE</th><th>ARTICLE</th><th>PRIX VENTE</th><th>PROFIT</th><th>ROI</th></tr></thead><tbody>{% for sale in sales %}<tr><td class="small">{{ sale.sale_date.strftime('%d/%m/%Y') }}</td><td><div class="d-flex align-items-center"><div style="width: 45px; height: 45px; background: white; border-radius: 10px; padding: 4px; margin-right: 15px;"><img src="{{ sale.image_url }}" style="width: 100%; height: 100%; object-fit: contain;"></div><div><div class="fw-bold small">{{ sale.item_name }}</div><div class="text-muted small">{{ sale.sku }}</div></div></div></td><td class="fw-bold">{{ "%.2f"|format(sale.sale_price) }}€</td><td class="text-success fw-bold">+{{ "%.2f"|format(sale.profit) }}€</td><td><span class="badge bg-secondary bg-opacity-25 text-white">{{ "%.0f"|format((sale.profit / sale.purchase_price_at_sale * 100) if sale.purchase_price_at_sale > 0 else 0) }}%</span></td></tr>{% endfor %}</tbody></table></div></div>
    </div>
</div>

<script>
    function showTab(e, id) {
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).classList.add('active'); e.currentTarget.classList.add('active');
        if (id === 'tab-analytique' && !analytiqueChart) initAnalytique();
        if (id === 'tab-goals') updateGoalsUI();
    }

    const staticStock = {{ stock_value|default(0)|tojson }};
    const staticPending = {{ pending_payments|default(0)|tojson }};
    const dailyProf = {{ profit|default(0)|tojson }} / ({{ 7 if period == 'week' else 30 if period == 'month' else 365 if period == 'year' else 1 }});
    const hScore = {{ health_score|default(0)|tojson }};
    const roiAvg = {{ roi_avg|default(0)|tojson }};
    const vol = {{ volume|default(0)|tojson }};

    const daysData = {{ days_dist|tojson }};
    const sizesData = {{ sizes_dist|tojson }};
    const platformsData = {{ platforms_dist|tojson }};

    let currentGoalCoef = 1.2;
    const baseRefRev = {{ ref_rev|default(0)|tojson }};
    const baseRefProf = {{ ref_prof|default(0)|tojson }};
    const actualRevenue = {{ revenue|default(0)|tojson }};
    const actualProfit = {{ profit|default(0)|tojson }};

    function setGoalCoef(c) { currentGoalCoef = c; updateGoalsUI(); }
    function updateGoalsUI() {
        if (!{{ has_ref|default(false)|tojson }}) return;
        const targetRev = baseRefRev * currentGoalCoef;
        const targetProf = baseRefProf * currentGoalCoef;

        const revP = Math.min(100, (actualRevenue / targetRev) * 100);
        const goalRevVal = document.getElementById('goal-rev-val');
        if(goalRevVal) goalRevVal.innerText = Math.round(targetRev).toLocaleString() + " €";
        const goalRevPercent = document.getElementById('goal-rev-percent');
        if(goalRevPercent) goalRevPercent.innerText = Math.round(revP) + "%";
        const goalRevRem = document.getElementById('goal-rev-rem');
        if(goalRevRem) goalRevRem.innerText = (targetRev - actualRevenue) > 0 ? `Gap: ${Math.round(targetRev - actualRevenue)}€` : "Quota franchi";
        const progressRev = document.getElementById('progress-rev');
        if(progressRev) progressRev.style.width = revP + "%";
        const badgeRev = document.getElementById('badge-rev-reached');
        if(badgeRev) badgeRev.classList.toggle('d-none', actualRevenue < targetRev);

        const profP = Math.min(100, (actualProfit / targetProf) * 100);
        const goalProfVal = document.getElementById('goal-prof-val');
        if(goalProfVal) goalProfVal.innerText = Math.round(targetProf).toLocaleString() + " €";
        const goalProfPercent = document.getElementById('goal-prof-percent');
        if(goalProfPercent) goalProfPercent.innerText = Math.round(profP) + "%";
        const goalProfRem = document.getElementById('goal-prof-rem');
        if(goalProfRem) goalProfRem.innerText = (targetProf - actualProfit) > 0 ? `Gap: ${Math.round(targetProf - actualProfit)}€` : "Objectif validé";
        const progressProf = document.getElementById('progress-prof');
        if(progressProf) progressProf.style.width = profP + "%";
        const badgeProf = document.getElementById('badge-prof-reached');
        if(badgeProf) badgeProf.classList.toggle('d-none', actualProfit < targetProf);

        const btnLow = document.getElementById('btn-low');
        const btnHigh = document.getElementById('btn-high');
        if(btnLow) btnLow.classList.toggle('active', currentGoalCoef === 1.2);
        if(btnHigh) btnHigh.classList.toggle('active', currentGoalCoef === 1.8);
    }

    function updateDashboardAdvice() {
        let adv = "";
        if (hScore >= 9 && roiAvg >= 30) adv = `OPTIMISATION DE LA RENTABILITÉ : Performance exceptionnelle avec un ROI moyen de ${roiAvg}% et un Health Score de ${hScore}/10. Recommandation : Visez une augmentation du volume de 20% pour décupler vos profits sans sacrifier la marge.`;
        else if (hScore >= 7 && vol < 3) adv = `ANALYSE DU VOLUME : Bien que qualitatif (Health Score ${hScore}/10), votre volume (${vol} ventes) limite votre croissance. Diversifiez votre inventaire avec des modèles à rotation plus rapide.`;
        else if (hScore >= 5 && roiAvg < 15) adv = `RESTRUCTURATION DES MARGES : Volume soutenu mais ROI de ${roiAvg}% inférieur aux standards. Allouez une part plus importante de votre budget à des actifs à plus forte valeur ajoutée (ROI > 20%).`;
        else if (hScore < 4) adv = `AUDIT DE VIABILITÉ : Alerte : Health Score de ${hScore}/10 indique une fragilité structurelle. Suspendez toute nouvelle acquisition et liquidez les actifs les moins performants.`;
        else adv = `STABILITÉ STRATÉGIQUE : Activité saine et équilibrée. Avec un ROI de ${roiAvg}% et une gestion cohérente, votre structure est prête pour explorer de nouveaux segments de marché.`;
        const adviceBox = document.getElementById('dashboard-expert-advice');
        if(adviceBox) adviceBox.innerText = adv;
    }

    function updateFinances() {
        const inputCash = document.getElementById('input-cash');
        const cash = inputCash ? parseFloat(inputCash.value) || 0 : 0;
        const total = cash + staticStock + staticPending;
        const valTotalBase = document.getElementById('val-total-base');
        if(valTotalBase) valTotalBase.innerText = total.toFixed(2) + "€";

        // LOGIQUE DE PROJECTION CAPITAL (ROI)
        const roi = roiAvg / 100;
        const proj1m = total * (1 + roi);
        const proj3m = total * Math.pow((1 + roi), 3);
        const proj1y = total * Math.pow((1 + roi), 12);

        const el1m = document.getElementById('proj-roi-1m');
        const el3m = document.getElementById('proj-roi-3m');
        const el1y = document.getElementById('proj-roi-1y');
        if(el1m) el1m.innerText = proj1m.toFixed(2) + "€";
        if(el3m) el3m.innerText = proj3m.toFixed(2) + "€";
        if(el1y) el1y.innerText = Math.round(proj1y).toLocaleString() + "€";

        const financeAdvice = document.getElementById('finance-expert-advice');
        if(financeAdvice) financeAdvice.innerText = `CONTRÔLE DE TRÉSORERIE : Votre capital total s'élève à ${total.toFixed(2)}€. Vos projections prévoient une capitalisation de ${(total + (dailyProf * 30)).toFixed(2)}€ d'ici 30 jours, basée sur l'ajout linéaire de votre profit journalier moyen.`;
    }

    function updateStockAdvice() {
        const age = {{ stock_avg_age|tojson }};
        const pLat = {{ profit_latent|tojson }};
        const stockAdvice = document.getElementById('stock-expert-advice');
        if(stockAdvice) stockAdvice.innerText = `AUDIT D'INVENTAIRE : Rotation moyenne de ${age} jours avec un profit latent de +${pLat.toFixed(2)}€. Votre structure est cohérente avec les standards. Un suivi des unités approchant les 45 jours est conseillé.`;
    }

    let analytiqueChart = null;
    function initAnalytique() {
        const ctx = document.getElementById('analytiqueChart');
        if(!ctx) return;
        analytiqueChart = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'Profit (€)', data: [], backgroundColor: 'rgba(138, 43, 226, 0.4)', borderColor: '#8a2be2', borderWidth: 2 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8e9297' } }, x: { ticks: { color: '#8e9297' } } } }
        });
        const firstBtn = document.querySelector('.analytique-nav .period-btn');
        if(firstBtn) switchAnalytique(firstBtn, 'days');
    }

    function switchAnalytique(btn, type) {
        document.querySelectorAll('.analytique-nav .period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        let labels = [], profits = [], counts = [], advice = "", title = "";
        const dayNames = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];

        if (type === 'days') {
            title = "Répartition par Jour"; labels = dayNames;
            for(let i=0; i<7; i++) { profits.push(daysData[i].profit); counts.push(daysData[i].count); }
            const bestDay = labels[profits.indexOf(Math.max(...profits))];
            advice = `ANALYSE DE SAISONNALITÉ : Votre pic de rentabilité est observé le ${bestDay}. Stratégie : Concentrez vos publications d'annonces 24h avant ce pic pour maximiser la visibilité lors de la phase d'achat critique.`;
        } else if (type === 'sizes') {
            title = "Répartition par Taille"; labels = Object.keys(sizesData);
            labels.forEach(k => { profits.push(sizesData[k].profit); counts.push(sizesData[k].count); });
            const bestSize = labels[profits.indexOf(Math.max(...profits))];
            advice = `OPTIMISATION DU CATALOGUE : La taille ${bestSize} génère votre plus fort profit net. Recommandation : Allouez 40% de votre capital sur ce segment pour sécuriser une rotation à haute vélocité.`;
        } else {
            title = "Répartition par Plateforme"; labels = Object.keys(platformsData);
            labels.forEach(k => { profits.push(platformsData[k].profit); counts.push(platformsData[k].count); });
            const bestPlat = labels[profits.indexOf(Math.max(...profits))];
            advice = `EFFICIENCE DES CANAUX : ${bestPlat} s'impose comme votre canal dominant. Analyse : Ce canal offre le meilleur ratio visibilité/frais. Priorisez-y vos actifs 'Haute Valeur' pour optimiser votre marge nette.`;
        }
        const chartTitle = document.getElementById('analytique-chart-title');
        if(chartTitle) chartTitle.innerText = title;
        const analytiqueAdvice = document.getElementById('analytique-expert-advice');
        if(analytiqueAdvice) analytiqueAdvice.innerText = advice;
        if(analytiqueChart) {
            analytiqueChart.data.labels = labels; analytiqueChart.data.datasets[0].data = profits; analytiqueChart.update();
        }
    }

    function openHelp(id) { document.getElementById('overlay-' + id).style.display = 'flex'; }
    function closeHelp(id) { document.getElementById('overlay-' + id).style.display = 'none'; }
    const ctxEv = document.getElementById('evolutionChart');
    if(ctxEv) {
        new Chart(ctxEv.getContext('2d'), { type: 'line', data: { labels: [{% for s in sales %}"{{ s.sale_date.strftime('%d/%m') }}",{% endfor %}], datasets: [{ label: 'Ventes', data: [{% for s in sales %}{{ s.sale_price }},{% endfor %}], borderColor: '#8a2be2', backgroundColor: 'rgba(138, 43, 226, 0.1)', fill: true, tension: 0.4, borderWidth: 3 }, { label: 'Bénéfice', data: [{% for s in sales %}{{ s.profit }},{% endfor %}], borderColor: '#00ffa3', borderDash: [5, 5], fill: false, tension: 0.4, borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8e9297' } }, x: { grid: { display: false }, ticks: { color: '#8e9297' } } } } });
    }

    updateDashboardAdvice(); updateFinances(); updateStockAdvice(); updateGoalsUI();
</script>
{% endblock %}