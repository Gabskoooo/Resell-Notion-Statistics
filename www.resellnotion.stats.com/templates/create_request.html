{% extends "base.html" %}

{% block title %}Cr√©er une demande | ResellNotion{% endblock %}

{% block content %}
<style>
    /* --- DESIGN SYSTEM (H√âRIT√â) --- */
    :root {
        --glass-bg: rgba(255, 255, 255, 0.03);
        --glass-border: rgba(255, 255, 255, 0.08);
        --primary-glow: #8a2be2;
        --success-glow: #00ffa3; /* */
    }

    /* --- AUTO-COMPL√âTION --- */
    .search-results {
        position: absolute; width: 100%; z-index: 1000;
        background: #161a2b; border: 1px solid var(--glass-border);
        border-radius: 12px; max-height: 250px; overflow-y: auto; display: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .search-item {
        padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s;
        border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .search-item:hover { background: rgba(255, 255, 255, 0.05); }
    .search-item img { width: 45px; height: 45px; object-fit: contain; border-radius: 8px; background: #000; }

    /* --- LISTE DE R√âCAPITULATIF --- */
    .request-line {
        background: var(--glass-bg); border: 1px solid var(--glass-border);
        border-radius: 18px; padding: 18px; margin-bottom: 12px;
        backdrop-filter: blur(10px);
    }

    /* --- OVERLAY DE VALIDATION COURT --- */
    .validation-toast {
        position: fixed; top: 25px; left: 50%; transform: translateX(-50%) translateY(-150%);
        background: rgba(0, 255, 163, 0.1); border: 1px solid var(--success-glow);
        color: var(--success-glow); padding: 16px 32px; border-radius: 14px;
        backdrop-filter: blur(15px); z-index: 3000; font-weight: 700;
        box-shadow: 0 0 30px rgba(0, 255, 163, 0.2);
        transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex; align-items: center; gap: 10px;
    }
    .validation-toast.show { transform: translateX(-50%) translateY(0); }
</style>

<div id="validationToast" class="validation-toast">
    <i class="bi bi-check2-all fs-4"></i>
    Demandes enregistr√©es avec succ√®s !
</div>

<div class="container py-5">
    <div class="header-section animate-in mb-5">
        <h2 class="fw-bold text-white mb-1">Cr√©er une demande WTB üìù</h2>
        <p class="subtitle">D√©taillez les produits que vous recherchez pour le r√©seau.</p>
    </div>

    <div class="filter-card animate-in" style="animation-delay: 0.1s;">
        <div class="row g-3 align-items-end">
            <div class="col-md-4 position-relative">
                <label class="stat-label mb-2 d-block">Mod√®le / SKU</label>
                <input type="text" id="skuInput" class="form-control filter-input" placeholder="Tapez le SKU ou nom..." autocomplete="off">
                <div id="skuResults" class="search-results"></div>
            </div>
            <div class="col-md-2">
                <label class="stat-label mb-2 d-block">Taille</label>
                <input type="text" id="sizeInput" class="form-control filter-input" placeholder="Ex: 44">
            </div>
            <div class="col-md-2">
                <label class="stat-label mb-2 d-block">Prix Max (‚Ç¨)</label>
                <input type="number" id="priceInput" class="form-control filter-input" placeholder="0.00">
            </div>
            <div class="col-md-2">
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input shadow-none" type="checkbox" id="negoInput">
                    <label class="stat-label ms-1" style="cursor:pointer" for="negoInput">N√©gociable</label>
                </div>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100 py-3 rounded-4 fw-bold" onclick="addRequestLine()">AJOUTER</button>
            </div>
        </div>
    </div>

    <div id="recapSection" style="display: none;" class="mt-5 animate-in">
        <h5 class="stat-label mb-4">VOTRE R√âCAPITULATIF</h5>
        <div id="requestList"></div>
        <div class="text-center mt-5">
            <button id="finalBtn" class="btn btn-submit px-5 py-3 rounded-pill" onclick="finalizeRequests()">
                ENREGISTRER MES DEMANDES
            </button>
        </div>
    </div>
</div>

<script>
let pendingItems = [];
let searchTimeout;

// 1. AUTO-COMPL√âTION SKU
const skuInput = document.getElementById('skuInput');
const skuResults = document.getElementById('skuResults');

skuInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    const query = skuInput.value.trim();
    if (query.length < 2) { skuResults.style.display = 'none'; return; }

    searchTimeout = setTimeout(async () => {
        const response = await fetch(`/get_sku_suggestions?query=${query}`);
        const suggestions = await response.json();

        if (suggestions.length > 0) {
            skuResults.innerHTML = suggestions.map(s => `
                <div class="search-item" onclick="selectSku('${s.sku}')">
                    <img src="${s.image_url}" onerror="this.src='https://placehold.co/100x100/0b0e14/ffffff?text=?'">
                    <div>
                        <div class="fw-bold text-white">${s.sku}</div>
                        <div style="font-size:0.7rem; color:#8e9297">${s.product_name}</div>
                    </div>
                </div>
            `).join('');
            skuResults.style.display = 'block';
        } else { skuResults.style.display = 'none'; }
    }, 300);
});

function selectSku(sku) {
    skuInput.value = sku;
    skuResults.style.display = 'none';
}

// 2. GESTION DE LA LISTE TEMPORAIRE
function addRequestLine() {
    const sku = skuInput.value;
    const size = document.getElementById('sizeInput').value;
    const price = document.getElementById('priceInput').value;
    const negotiable = document.getElementById('negoInput').checked;

    if (!sku || !size || !price) {
        alert("Champs manquants !");
        return;
    }

    pendingItems.push({ id: Date.now(), sku, size, price, negotiable });
    renderRecap();

    // Reset
    skuInput.value = '';
    document.getElementById('sizeInput').value = '';
    document.getElementById('priceInput').value = '';
    document.getElementById('negoInput').checked = false;
}

function renderRecap() {
    const list = document.getElementById('requestList');
    const section = document.getElementById('recapSection');
    section.style.display = pendingItems.length > 0 ? 'block' : 'none';

    list.innerHTML = pendingItems.map(item => `
        <div class="request-line d-flex justify-content-between align-items-center animate-in">
            <div class="d-flex align-items-center gap-3">
                <span class="badge-premium" style="color:var(--primary-glow)">${item.sku}</span>
                <span class="text-white fw-bold">Taille: ${item.size}</span>
                <span class="text-success fw-bold ms-2">${item.price}‚Ç¨</span>
                ${item.negotiable ? '<small class="text-muted opacity-50">(N√©go. OK)</small>' : ''}
            </div>
            <button class="btn btn-link text-danger p-0" onclick="removeItem(${item.id})">
                <i class="bi bi-trash-fill fs-5"></i>
            </button>
        </div>
    `).join('');
}

function removeItem(id) {
    pendingItems = pendingItems.filter(i => i.id !== id);
    renderRecap();
}

// 3. ENREGISTREMENT FINAL & OVERLAY DE VALIDATION
async function finalizeRequests() {
    const btn = document.getElementById('finalBtn');
    btn.disabled = true;
    btn.innerText = "ENREGISTREMENT...";

    try {
        const response = await fetch('/api/save-wtb-requests', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ items: pendingItems })
        });

        if (response.ok) {
            // Afficher le toast court
            const toast = document.getElementById('validationToast');
            toast.classList.add('show');

            // Redirection apr√®s 2 secondes
            setTimeout(() => {
                window.location.href = '/find-product';
            }, 2000);
        } else {
            alert("Erreur serveur.");
            btn.disabled = false;
            btn.innerText = "ENREGISTRER MES DEMANDES";
        }
    } catch (e) {
        alert("Erreur de connexion.");
        btn.disabled = false;
    }
}
</script>
{% endblock %}