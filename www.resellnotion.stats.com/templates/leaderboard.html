{# templates/leaderboard.html #}
{% extends 'base.html' %}

{% block title %}Classement des Utilisateurs{% endblock %}

{% block content %}
<h1 class="mb-4 text-white">Classement des Utilisateurs</h1>

<p class="text-white mb-4">Afin de reconnaître l'excellence et la performance, le participant se classant premier chaque mois sera gratifié de journées d'accès offertes sur le serveur Discord de Resell Notion.</p>

<ul class="nav nav-tabs mb-3" id="leaderboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="ca-tab" data-bs-toggle="tab" data-bs-target="#ca-ranking" type="button" role="tab" aria-controls="ca-ranking" aria-selected="true">Par Chiffre d'Affaires</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="profit-tab" data-bs-toggle="tab" data-bs-target="#profit-ranking" type="button" role="tab" aria-controls="profit-ranking" aria-selected="false">Par Bénéfice</button>
    </li>
</ul>

<div class="tab-content" id="leaderboardTabsContent">
    {# Contenu de l'onglet "Par Chiffre d'Affaires" #}
    <div class="tab-pane fade show active" id="ca-ranking" role="tabpanel" aria-labelledby="ca-tab">
        <div class="leaderboard-card">
            <div class="table-responsive">
                <table class="table leaderboard-table text-white mb-0">
                    <thead>
                        <tr>
                            <th>Rang</th>
                            <th>Utilisateur</th>
                            <th>Chiffre d'Affaires Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set current_user_in_ca_top = false %}
                        {% for user in leaderboard %}
                            <tr class="{% if current_user.is_authenticated and user.user_id == current_user.id %}current-user-row{% endif %}">
                                <td>
                                    {% if user.rank_ca == 1 %}<i class="bi bi-trophy-fill trophy-icon gold-trophy"></i>
                                    {% elif user.rank_ca == 2 %}<i class="bi bi-trophy-fill trophy-icon silver-trophy"></i>
                                    {% elif user.rank_ca == 3 %}<i class="bi bi-trophy-fill trophy-icon bronze-trophy"></i>
                                    {% endif %}
                                    {{ user.rank_ca }}
                                </td>
                                <td>
                                    {% if current_user.is_authenticated and user.user_id == current_user.id %}Vous (Rang {{ user.rank_ca }}){% else %}User #{{ user.rank_ca }}{% endif %}
                                </td>
                                <td>{{ "{:,.2f} €".format(user.total_ca) }}</td>
                            </tr>
                            {% if current_user.is_authenticated and user.user_id == current_user.id %}
                                {% set current_user_in_ca_top = true %}
                            {% endif %}
                        {% endfor %}
                        {% if not leaderboard %}
                            <tr>
                                <td colspan="3" class="text-center">Aucune donnée de classement disponible pour le moment.</td>
                            </tr>
                        {% endif %}
                        {% if current_user.is_authenticated and not current_user_in_ca_top %}
                            {% set current_user_entry = leaderboard | selectattr('user_id', 'equalto', current_user.id) | first %}
                            {% if current_user_entry and current_user_entry.rank_ca > leaderboard|length %}
                                <tr class="current-user-row">
                                    <td>{{ current_user_entry.rank_ca }}</td>
                                    <td>Vous (Rang {{ current_user_entry.rank_ca }})</td>
                                    <td>{{ "{:,.2f} €".format(current_user_entry.total_ca) }}</td>
                                </tr>
                            {% endif %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {# Contenu de l'onglet "Par Bénéfice" #}
    <div class="tab-pane fade" id="profit-ranking" role="tabpanel" aria-labelledby="profit-tab">
        <div class="leaderboard-card">
            <div class="table-responsive">
                <table class="table leaderboard-table text-white mb-0">
                    <thead>
                        <tr>
                            <th>Rang</th>
                            <th>Utilisateur</th>
                            <th>Bénéfice Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set current_user_in_profit_top = false %}
                        {% for user in leaderboard %}
                            <tr class="{% if current_user.is_authenticated and user.user_id == current_user.id %}current-user-row{% endif %}">
                                <td>
                                    {% if user.rank_benefice == 1 %}<i class="bi bi-trophy-fill trophy-icon gold-trophy"></i>
                                    {% elif user.rank_benefice == 2 %}<i class="bi bi-trophy-fill trophy-icon silver-trophy"></i>
                                    {% elif user.rank_benefice == 3 %}<i class="bi bi-trophy-fill trophy-icon bronze-trophy"></i>
                                    {% endif %}
                                    {{ user.rank_benefice }}
                                </td>
                                <td>
                                    {% if current_user.is_authenticated and user.user_id == current_user.id %}Vous (Rang {{ user.rank_benefice }}){% else %}User #{{ user.rank_benefice }}{% endif %}
                                </td>
                                <td>{{ "{:,.2f} €".format(user.total_benefice) }}</td>
                            </tr>
                            {% if current_user.is_authenticated and user.user_id == current_user.id %}
                                {% set current_user_in_profit_top = true %}
                            {% endif %}
                        {% endfor %}
                        {% if not leaderboard %}
                            <tr>
                                <td colspan="3" class="text-center">Aucune donnée de classement disponible pour le moment.</td>
                            </tr>
                        {% endif %}
                        {% if current_user.is_authenticated and not current_user_in_profit_top %}
                             {% set current_user_entry = leaderboard | selectattr('user_id', 'equalto', current_user.id) | first %}
                             {% if current_user_entry and current_user_entry.rank_benefice > leaderboard|length %}
                                <tr class="current-user-row">
                                    <td>{{ current_user_entry.rank_benefice }}</td>
                                    <td>Vous (Rang {{ current_user_entry.rank_benefice }})</td>
                                    <td>{{ "{:,.2f} €".format(current_user_entry.total_benefice) }}</td>
                                </tr>
                            {% endif %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}