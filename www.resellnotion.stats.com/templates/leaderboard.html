{% extends 'base.html' %}

{% block title %}Classement des Utilisateurs{% endblock %}

{% block content %}
<h1 class="mb-4 text-white">Classement des Utilisateurs</h1>

<p class="text-white mb-4">Afin de reconnaître l'excellence et la performance, le participant se classant premier chaque mois sera gratifié de journées d'accès offertes sur le serveur Discord de Resell Notion.</p>

{# Trouver l'entrée de l'utilisateur actuel dans le classement #}
{% set current_user_entry = none %}
{% if current_user.is_authenticated %}
    {% for user_data in leaderboard %}
        {% if user_data.user_id == current_user.id %}
            {% set current_user_entry = user_data %}
        {% endif %}
    {% endfor %}
{% endif %}

<ul class="nav nav-tabs mb-3" id="leaderboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="ca-tab" data-bs-toggle="tab" data-bs-target="#ca-ranking" type="button" role="tab" aria-controls="ca-ranking" aria-selected="true">Par Chiffre d'Affaires</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="profit-tab" data-bs-toggle="tab" data-bs-target="#profit-ranking" type="button" role="tab" aria-controls="profit-ranking" aria-selected="false">Par Bénéfice</button>
    </li>
</ul>
<div class="tab-content" id="leaderboardTabsContent">
    {# Contenu de l'onglet "Par Chiffre d'Affaires" #}
    <div class="tab-pane fade show active" id="ca-ranking" role="tabpanel" aria-labelledby="ca-tab">
        <div class="card mb-3" style="background-color: rgba(0, 0, 0, 0.5); color: white; border: none;">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table text-white" style="background-color: transparent;">
                        <thead>
                            <tr>
                                <th class="text-white" style="background-color: transparent;">Rang</th>
                                <th class="text-white" style="background-color: transparent;">Utilisateur</th>
                                <th class="text-white" style="background-color: transparent;">Chiffre d'Affaires Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set user_in_top_3_ca_displayed = false %}
                            {% for user in leaderboard %}
                                {% if current_user.is_authenticated and user.user_id == current_user.id and user.rank_ca <= 3 %}
                                    {% set user_in_top_3_ca_displayed = true %}
                                {% endif %}
                                <tr style="background-color: transparent; {% if current_user.is_authenticated and user.user_id == current_user.id %}background-color: rgba(60, 179, 113, 0.7);{% endif %}">
                                    <td style="background-color: transparent; color: white;">{{ user.rank_ca }}</td>
                                    <td style="background-color: transparent; color: white;">
                                        {# MODIFIÉ ICI : Affiche "Vous (Rang #X)" #}
                                        {% if current_user.is_authenticated and user.user_id == current_user.id %}Vous (Rang {{ user.rank_ca }}){% else %}User #{{ user.rank_ca }}{% endif %}
                                    </td>
                                    <td style="background-color: transparent; color: white;">{{ "{:,.2f} €".format(user.total_ca) }}</td>
                                </tr>
                            {% endfor %}
                            {% if not leaderboard %}
                                <tr style="background-color: transparent;">
                                    <td colspan="3" style="background-color: transparent; color: white;">Aucune donnée de classement disponible pour le moment.</td>
                                </tr>
                            {% elif current_user.is_authenticated and current_user_entry and current_user_entry.rank_ca > 3 and not user_in_top_3_ca_displayed %}
                                <tr style="background-color: rgba(60, 179, 113, 0.7);">
                                    <td style="background-color: transparent; color: white;">{{ current_user_entry.rank_ca }}</td>
                                    {# MODIFIÉ ICI : Affiche "Vous (Rang #X)" pour la ligne séparée #}
                                    <td style="background-color: transparent; color: white;">Vous (Rang {{ current_user_entry.rank_ca }})</td>
                                    <td style="background-color: transparent; color: white;">{{ "{:,.2f} €".format(current_user_entry.total_ca) }}</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {# Contenu de l'onglet "Par Bénéfice" #}
    <div class="tab-pane fade" id="profit-ranking" role="tabpanel" aria-labelledby="profit-tab">
        <div class="card mb-3" style="background-color: rgba(0, 0, 0, 0.5); color: white; border: none;">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table text-white" style="background-color: transparent;">
                        <thead>
                            <tr>
                                <th class="text-white" style="background-color: transparent;">Rang</th>
                                <th class="text-white" style="background-color: transparent;">Utilisateur</th>
                                <th class="text-white" style="background-color: transparent;">Bénéfice Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set user_in_top_3_benefice_displayed = false %}
                            {% for user in leaderboard | sort(attribute='rank_benefice') %}
                                {% if current_user.is_authenticated and user.user_id == current_user.id and user.rank_benefice <= 3 %}
                                    {% set user_in_top_3_benefice_displayed = true %}
                                {% endif %}
                                <tr style="background-color: transparent; {% if current_user.is_authenticated and user.user_id == current_user.id %}background-color: rgba(60, 179, 113, 0.7);{% endif %}">
                                    <td style="background-color: transparent; color: white;">{{ user.rank_benefice }}</td>
                                    <td style="background-color: transparent; color: white;">
                                        {# MODIFIÉ ICI : Affiche "Vous (Rang #X)" #}
                                        {% if current_user.is_authenticated and user.user_id == current_user.id %}Vous (Rang {{ user.rank_benefice }}){% else %}User #{{ user.rank_benefice }}{% endif %}
                                    </td>
                                    <td style="background-color: transparent; color: white;">{{ "{:,.2f} €".format(user.total_benefice) }}</td>
                                </tr>
                            {% endfor %}
                            {% if current_user.is_authenticated and current_user_entry and current_user_entry.rank_benefice > 3 and not user_in_top_3_benefice_displayed %}
                                <tr style="background-color: rgba(60, 179, 113, 0.7);">
                                    <td style="background-color: transparent; color: white;">{{ current_user_entry.rank_benefice }}</td>
                                    {# MODIFIÉ ICI : Affiche "Vous (Rang #X)" pour la ligne séparée #}
                                    <td style="background-color: transparent; color: white;">Vous (Rang {{ current_user_entry.rank_benefice }})</td>
                                    <td style="background-color: transparent; color: white;">{{ "{:,.2f} €".format(current_user_entry.total_benefice) }}</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}