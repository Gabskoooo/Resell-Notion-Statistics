{% extends 'base.html' %}

{% block content %}
<style>
    /* --- CONFIGURATION DA CYBER PREMIUM --- */
    :root {
        --cyber-purple: #8a2be2;
        --cyber-cyan: #00ffa3;
        --cyber-bg: #0a0b10;
        --glass-bg: rgba(255, 255, 255, 0.03);
        --glass-border: rgba(255, 255, 255, 0.08);
        --neon-shadow: 0 0 15px rgba(138, 43, 226, 0.4);
    }

    /* --- OVERLAYS (GUIDE & VERROUILLAGE) --- */
    #lockOverlay, #guideOverlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle at center, rgba(13, 17, 28, 0.98) 0%, #050608 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        transition: all 0.5s ease;
    }

    #lockOverlay { display: none; }

    .guide-box {
        background: var(--glass-bg);
        border: 1px solid var(--cyber-cyan);
        border-radius: 28px;
        padding: 45px;
        max-width: 550px;
        text-align: center;
        box-shadow: 0 0 40px rgba(0, 255, 163, 0.15);
        backdrop-filter: blur(10px);
    }

    /* --- PROGRESSION & CONSOLE --- */
    .progress-container {
        width: 85%;
        max-width: 650px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 100px;
        height: 10px;
        margin: 30px 0;
        overflow: hidden;
        border: 1px solid var(--glass-border);
    }

    #progressBar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, var(--cyber-purple), var(--cyber-cyan));
        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 0 20px rgba(138, 43, 226, 0.6);
    }

    #miniLogConsole {
        width: 85%;
        max-width: 650px;
        height: 180px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 16px;
        padding: 20px;
        font-family: 'Fira Code', monospace;
        font-size: 0.8rem;
        overflow-y: auto;
        border: 1px solid var(--cyber-purple);
        margin-top: 30px;
    }

    /* --- CARTE PRINCIPALE --- */
    .premium-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 32px;
        padding: 50px;
        backdrop-filter: blur(15px);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
        transition: opacity 0.5s ease;
    }

    .filter-input {
        background: rgba(0, 0, 0, 0.2) !important;
        border: 1px solid var(--glass-border) !important;
        color: #fff !important;
        border-radius: 14px !important;
        padding: 12px 18px !important;
        transition: all 0.3s ease !important;
    }

    .filter-input:focus {
        border-color: var(--cyber-cyan) !important;
        box-shadow: 0 0 15px rgba(0, 255, 163, 0.2) !important;
    }

    /* --- BOUTONS --- */
    .btn-cyber {
        background: linear-gradient(135deg, var(--cyber-purple) 0%, #6a11cb 100%);
        border: none; color: white; text-transform: uppercase; letter-spacing: 2px;
        padding: 15px 30px; border-radius: 50px; font-weight: bold;
        transition: all 0.4s ease; box-shadow: 0 10px 20px rgba(106, 17, 203, 0.3);
    }

    .btn-cyber:hover { transform: translateY(-3px); filter: brightness(1.1); box-shadow: 0 15px 30px rgba(106, 17, 203, 0.5); }

    .btn-guide {
        background: transparent;
        border: 1px solid var(--cyber-cyan);
        color: var(--cyber-cyan);
        padding: 14px 35px;
        border-radius: 50px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s;
        cursor: pointer;
    }

    .btn-guide:hover {
        background: var(--cyber-cyan);
        color: #000;
        box-shadow: 0 0 25px var(--cyber-cyan);
    }

    .label-caps { text-transform: uppercase; letter-spacing: 1.5px; font-size: 0.7rem; color: rgba(255,255,255,0.4); margin-bottom: 8px; display: block; }
</style>

<div id="guideOverlay">
    <div class="guide-box">
        <h2 id="guideTitle" class="fw-bold mb-3" style="color: var(--cyber-cyan);">ÉTAPE 1</h2>
        <p id="guideText" class="mb-4" style="font-size: 1.1rem; color: #cbd5e1;">
            Importez votre fichier excel ici, veuillez à ce que la première ligne contienne le nom de vos colonnes.<br>
            <span style="color: var(--cyber-purple); font-weight: bold;">Format accepté : .xlsx uniquement.</span>
        </p>
        <button id="guideBtn" class="btn-guide" onclick="nextGuideStep()">Démarrer la synchronisation</button>
    </div>
</div>

<div id="lockOverlay">
    <h2 class="fw-bold mb-1" style="letter-spacing: 2px; background: linear-gradient(90deg, #fff, var(--cyber-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SYNCHRONISATION EN COURS</h2>
    <div class="progress-container">
        <div id="progressBar"></div>
    </div>
    <div class="d-flex gap-5 mb-3">
        <div class="text-center">
            <small class="label-caps">Status</small>
            <span id="progressPercent" class="fw-bold" style="color: var(--cyber-cyan);">0%</span>
        </div>
        <div class="text-center">
            <small class="label-caps">Estimation</small>
            <span id="etaTimer" class="fw-bold">Calcul...</span>
        </div>
    </div>
    <div id="miniLogConsole"><div id="miniLogLines"></div></div>
</div>

<div class="container py-5">
    <div class="premium-card" id="mainCard" style="opacity: 0; pointer-events: none;">
        <div class="d-flex align-items-center mb-5">
            <div style="width: 55px; height: 55px; background: var(--cyber-purple); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin-right: 20px; box-shadow: var(--neon-shadow);">
                <i class="fas fa-cloud-upload-alt text-white fs-4"></i>
            </div>
            <div>
                <h2 class="text-white fw-bold mb-0">Importation de Ventes</h2>
                <p class="text-muted small mb-0">Propulsez vos données Excel vers votre base PostgreSQL.</p>
            </div>
        </div>

        <div id="fileSection">
            <label class="label-caps">FICHIER SOURCE (.XLSX)</label>
            <input type="file" id="excelFile" class="form-control filter-input">
        </div>

        <div id="mappingSection" style="display:none;" class="mt-5 animate__animated animate__fadeIn">
            <h4 class="label-caps mb-4" style="color: var(--cyber-cyan) !important;">Association des métadonnées</h4>
            <div class="row g-4" id="mappingFields"></div>
            <button class="btn btn-cyber mt-5 w-100 py-3 fw-bold rounded-pill" onclick="startImport()">
                Confirmer l'importation
            </button>
        </div>
    </div>
</div>

<script>
let tempFilePath = "";
let totalRows = 0;
let startTime = 0;
let currentStep = 1;

// --- GESTION DU GUIDE (CORRECTION POINTER-EVENTS) ---
function nextGuideStep() {
    if (currentStep === 1) {
        document.getElementById('guideOverlay').style.display = 'none';
        const mainCard = document.getElementById('mainCard');
        mainCard.style.opacity = '1';
        mainCard.style.pointerEvents = 'auto'; // Correction appliquée ici
    } else if (currentStep === 2) {
        document.getElementById('guideOverlay').style.display = 'none';
        document.getElementById('mappingSection').style.display = 'block';
    }
}

// --- LOGIQUE D'IMPORTATION ---
document.getElementById('excelFile').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('excel_file', file);

    const resp = await fetch("{{ url_for('import_excel_page') }}", { method: 'POST', body: formData });
    const data = await resp.json();

    if (data.error) { alert(data.error); return; }

    tempFilePath = data.temp_path;
    const fields = [
        { id: 'item_name', label: 'Nom Article' },
        { id: 'sku', label: 'SKU' },
        { id: 'size', label: 'Taille' },
        { id: 'sale_date', label: 'Date Vente' },
        { id: 'sale_price', label: 'Prix Vente' },
        { id: 'profit', label: 'Bénéfice' }
    ];

    document.getElementById('mappingFields').innerHTML = fields.map(f => `
        <div class="col-md-6">
            <label class="label-caps">${f.label}</label>
            <select id="map_${f.id}" class="form-select filter-input">
                <option value="">${f.id === 'sku' ? 'Auto-detect SKU' : '-- Ignorer --'}</option>
                ${data.columns.map(col => `<option value="${col}">${col}</option>`).join('')}
            </select>
        </div>
    `).join('');

    // DECLENCHEMENT ETAPE 2
    currentStep = 2;
    document.getElementById('guideTitle').innerText = "ÉTAPE 2";
    document.getElementById('guideTitle').style.color = "var(--cyber-purple)";
    document.getElementById('guideText').innerHTML = "Associez les colonnes de votre fichier au informations demandées. <br><b>Ne vous trompez pas</b>, il ne sera pas possible de revenir en arrière après.";
    document.getElementById('guideBtn').innerText = "Associer les colonnes";
    document.getElementById('guideOverlay').style.display = 'flex';
});

async function startImport() {
    const mapping = {
        item_name: document.getElementById('map_item_name').value,
        sku: document.getElementById('map_sku').value,
        size: document.getElementById('map_size').value,
        sale_date: document.getElementById('map_sale_date').value,
        sale_price: document.getElementById('map_sale_price').value,
        profit: document.getElementById('map_profit').value
    };

    document.getElementById('lockOverlay').style.display = 'flex';
    window.onbeforeunload = () => "Importation en cours...";

    const response = await fetch("{{ url_for('process_import_logic') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ mapping, temp_path: tempFilePath })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    startTime = Date.now();

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');

        lines.forEach(line => {
            if (line.startsWith('data: ')) {
                const data = JSON.parse(line.replace('data: ', ''));

                if (data.type === 'start') {
                    totalRows = data.total;
                } else if (data.index) {
                    const progress = (data.index / totalRows) * 100;
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressPercent').innerText = Math.round(progress) + '%';

                    const elapsed = (Date.now() - startTime) / 1000;
                    const speed = data.index / elapsed;
                    const remaining = (totalRows - data.index) / speed;
                    document.getElementById('etaTimer').innerText = Math.round(remaining) + 's';
                }

                if (data.msg) {
                    const p = document.createElement('div');
                    p.className = `text-${data.type === 'success' ? 'success' : (data.type === 'danger' ? 'danger' : 'info')}`;
                    p.innerHTML = `<span style="opacity:0.3; margin-right: 8px;">[SYSTEM]</span> ${data.msg}`;
                    document.getElementById('miniLogLines').appendChild(p);
                    document.getElementById('miniLogConsole').scrollTop = document.getElementById('miniLogConsole').scrollHeight;
                }

                if (data.type === 'finish') {
                    window.onbeforeunload = null;
                    setTimeout(() => { window.location.href = "{{ url_for('sales') }}"; }, 1500);
                }
            }
        });
    }
}
</script>
{% endblock %}