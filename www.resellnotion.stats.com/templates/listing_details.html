{% extends 'marketplace_base.html' %}

{% block title %}{{ listing.name }}{% endblock %}

{% block content %}
<style>
    .listing-details-container {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        padding: 2.5rem;
    }
    .carousel-item img {
        height: 500px;
        object-fit: contain;
    }
    .carousel-inner {
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    .product-details h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    .product-details h2 {
        font-size: 1.25rem;
        color: #6c757d;
        font-weight: 400;
    }
    .product-price {
        font-size: 2rem;
        font-weight: 700;
        color: #007bff;
        margin-top: 1rem;
    }
    .btn-buy {
        font-size: 1.25rem;
        padding: 0.75rem 1.5rem;
    }
    .description-section {
        margin-top: 2rem;
    }
    .offer-price-input {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: right;
        border: 2px solid #007bff;
    }
</style>

<div class="container mt-5">
    <a href="{{ url_for('marketplace') }}" class="btn btn-outline-secondary mb-4">&larr; Retour au marché</a>

    <div class="listing-details-container">
        <div class="row">
            <div class="col-md-7">
                {% set images = listing.image_urls.split(',') %}
                {% if images|length > 1 %}
                <div id="listingCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        {% for image in images %}
                        <div class="carousel-item {% if loop.first %}active{% endif %}">
                            <img src="{{ image }}" class="d-block w-100 rounded" alt="{{ listing.name }}">
                        </div>
                        {% endfor %}
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Précédent</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Suivant</span>
                    </button>
                </div>
                {% elif images and images[0] %}
                <img src="{{ images[0] }}" class="img-fluid rounded" alt="{{ listing.name }}">
                {% else %}
                <img src="{{ url_for('static', filename='placeholder.png') }}" class="img-fluid rounded" alt="Image non disponible">
                {% endif %}
            </div>
            <div class="col-md-5 product-details">
                <h1>{{ listing.name }}</h1>
                <h2 class="text-muted">{{ listing.brand }}</h2>
                <hr>
                <div class="product-info">
                    <p class="product-price">{{ "%.2f"|format(listing.price) }} €</p>
                    <p><strong>Référence :</strong> {{ listing.sku }}</p>
                    <p><strong>Tailles :</strong> {{ listing.sizes }}</p>
                </div>
                <div class="d-grid gap-2 mt-4">
                    <button type="button" class="btn btn-primary btn-lg btn-buy" data-bs-toggle="modal" data-bs-target="#requestModal">
                        Envoyer une demande au vendeur
                    </button>
                </div>
                <div class="description-section">
                    <h4>Description</h4>
                    <p>{{ listing.description }}</p>
                </div>
                <small class="text-muted mt-auto d-block">Posté le {{ listing.date_posted.strftime('%d/%m/%Y') }}</small>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="requestModal" tabindex="-1" aria-labelledby="requestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requestModalLabel">Demande pour {{ listing.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('send_request') }}" method="POST">
                    <input type="hidden" name="listing_id" value="{{ listing.id }}">
                    <div class="mb-3">
                        <label for="clientName" class="form-label">Nom Complet</label>
                        <input type="text" class="form-control" id="clientName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="clientEmail" class="form-label">Adresse Email</label>
                        <input type="email" class="form-control" id="clientEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="clientPhone" class="form-label">Numéro de Téléphone (optionnel)</label>
                        <input type="tel" class="form-control" id="clientPhone" name="phone_number">
                    </div>
                    <div class="mb-3">
                        <label for="offerPrice" class="form-label">Faire une offre</label>
                        <div class="input-group">
                            <input type="number" class="form-control offer-price-input" id="offerPrice" name="offer_price" placeholder="Saisir votre prix" step="0.01" min="0">
                            <span class="input-group-text offer-price-symbol">€</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="clientMessage" class="form-label">Votre message</label>
                        <textarea class="form-control" id="clientMessage" name="message" rows="4" required></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Envoyer la demande</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}