{% extends 'base.html' %}

{% block title %}Historique des Ventes | ResellNotion{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    :root {
        --glass-bg: rgba(255, 255, 255, 0.03);
        --glass-border: rgba(255, 255, 255, 0.08);
        --primary-glow: #8a2be2;
        --success-glow: #00ffa3;
        --danger-glow: #ff4d4d;
        --warning-glow: #ffcc00;
    }

    body {
        background: #0b0e14;
        background-image:
            radial-gradient(circle at 0% 0%, rgba(138, 43, 226, 0.1) 0%, transparent 35%),
            radial-gradient(circle at 100% 100%, rgba(0, 255, 163, 0.05) 0%, transparent 35%);
        color: #f8f9fa;
        font-family: 'Plus Jakarta Sans', sans-serif;
        min-height: 100vh;
    }

    .premium-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 24px;
        backdrop-filter: blur(10px);
    }
    .stat-label { color: #8e9297; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .stat-numb { font-size: 1.8rem; font-weight: 700; margin-top: 5px; color: #fff; }
    .text-glow-purple { color: #fff; text-shadow: 0 0 15px rgba(138, 43, 226, 0.4); }
    .text-glow-green { color: var(--success-glow); text-shadow: 0 0 15px rgba(0, 255, 163, 0.3); }

    .filter-input {
        background: var(--glass-bg) !important;
        border: 1px solid var(--glass-border) !important;
        color: #fff !important;
        border-radius: 12px !important;
    }

    .sale-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 24px;
        padding: 20px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        height: 100%;
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-width: 0;
    }
    .sale-card:hover {
        background: rgba(255, 255, 255, 0.04);
        border-color: rgba(138, 43, 226, 0.3);
        transform: translateY(-4px);
    }
    .selected-sale-card {
        border-color: var(--primary-glow) !important;
        background: rgba(138, 43, 226, 0.08) !important;
    }

    /* MENTIONS LIVRAISON */
    .mention-badge { padding: 4px 10px; border-radius: 30px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.1); }
    .mention-livre { background: rgba(0, 255, 163, 0.1); color: #00ffa3; }
    .mention-transit { background: rgba(138, 43, 226, 0.1); color: #8a2be2; }

    .progress-track { height: 8px; background: #161625; border-radius: 10px; margin: 20px 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
    .progress-bar-neon { height: 100%; background: linear-gradient(90deg, #8a2be2, #00ffa3); box-shadow: 0 0 15px rgba(138, 43, 226, 0.5); transition: width 1s ease-in-out; }
    .timeline-item { position: relative; padding-left: 25px; margin-bottom: 15px; border-left: 2px solid rgba(138, 43, 226, 0.3); }
    .timeline-dot { position: absolute; left: -7px; top: 0; width: 12px; height: 12px; background: #8a2be2; border-radius: 50%; box-shadow: 0 0 10px #8a2be2; }
    .log-console { background: #000; color: #00ff41; font-family: 'Courier New', monospace; padding: 15px; border-radius: 8px; font-size: 0.85rem; height: 180px; overflow-y: auto; text-align: left; border: 1px solid #333; }

    .card-header-flex { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 12px; }
    .sale-title { font-size: 0.95rem; font-weight: 700; color: #fff; line-height: 1.3; flex: 1; }
    .card-meta { display: flex; flex-direction: column; gap: 6px; margin-bottom: 20px; }
    .meta-item { font-size: 0.75rem; color: #8e9297; display: flex; align-items: center; font-weight: 500; }
    .meta-item i { margin-right: 8px; width: 14px; text-align: center; opacity: 0.7; }
    .card-footer-flex { display: flex; justify-content: space-between; align-items: flex-end; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.05); gap: 5px; }
    .sale-price-large { font-size: 1.2rem; font-weight: 800; color: #fff; }

    .status-badge { padding: 5px 10px; border-radius: 30px; font-size: 0.6rem; font-weight: 700; text-transform: uppercase; white-space: nowrap; }
    .status-re√ßu { background: rgba(0, 255, 163, 0.15); color: #00ffa3; }
    .status-attente { background: rgba(255, 204, 0, 0.15); color: #ffcc00; }
    .profit-pill { padding: 6px 10px; border-radius: 30px; font-weight: 700; font-size: 0.75rem; display: flex; align-items: center; white-space: nowrap; }
    .profit-pos { background: rgba(0, 255, 163, 0.1); color: var(--success-glow); }
    .profit-neg { background: rgba(255, 77, 77, 0.1); color: var(--danger-glow); }

    #actionPanel {
        position: fixed; top: 0; right: -100%; width: 400px; max-width: 100%; height: 100vh;
        background: rgba(11, 14, 20, 0.98); backdrop-filter: blur(20px);
        border-left: 1px solid var(--glass-border); padding: 30px; z-index: 1050;
        transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    #actionPanel.show { right: 0; }
    .cashback-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1050; padding: 15px; }
    .cashback-modal-content { background: #2a2a4a; padding: 30px; border-radius: 20px; width: 100%; max-width: 500px; color: #e0e0e0; position: relative; }
    .cashback-modal-close { position: absolute; top: 15px; right: 20px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-in { animation: fadeInUp 0.6s ease-out forwards; }
</style>

<div class="container py-5">
    <div class="mb-5 animate-in">
        <h1 class="text-white fw-bold">üìâ Historique des Ventes</h1>
        <p class="text-muted">Suivez vos performances et exp√©ditions.</p>
    </div>

    <div class="row g-3 g-md-4 mb-5 animate-in" style="animation-delay: 0.1s">
        <div class="col-6 col-md-3"><div class="premium-card"><div class="stat-label">Ventes</div><div class="stat-numb" id="total-sales-count">0</div></div></div>
        <div class="col-6 col-md-3"><div class="premium-card"><div class="stat-label">B√©n√©fice</div><div class="stat-numb text-glow-green" id="total-profit" style="font-size: 1.2rem;">0,00 ‚Ç¨</div></div></div>
        <div class="col-6 col-md-3"><div class="premium-card"><div class="stat-label">CA Total</div><div class="stat-numb text-glow-purple" id="total-revenue" style="font-size: 1.2rem;">0,00 ‚Ç¨</div></div></div>
        <div class="col-6 col-md-3"><div class="premium-card"><div class="stat-label">En Transit</div><div class="stat-numb text-info" style="font-size: 1.2rem;">{{ "%.2f"|format(total_transit_value) }} ‚Ç¨</div></div></div>
    </div>

    <div class="premium-card mb-5 animate-in" style="padding: 15px;">
        <div class="row g-3">
            <div class="col-12 col-md-4"><input type="text" id="salesSearch" class="form-control filter-input" placeholder="Recherche..."></div>
            <div class="col-6 col-md-4">
                <select id="periodFilter" class="form-select filter-input">
                    <option value="all">Toutes les p√©riodes</option>
                    <option value="today">Aujourd'hui</option>
                    <option value="this_week">Cette semaine</option>
                    <option value="this_month">Ce mois-ci</option>
                </select>
            </div>
            <div class="col-6 col-md-4">
                <select id="paymentStatusFilter" class="form-select filter-input">
                    <option value="all">Tous les paiements</option>
                    <option value="re√ßu">Re√ßu</option>
                    <option value="en_attente">Attente</option>
                </select>
            </div>
        </div>
    </div>

    {% if sales %}
    <div class="row g-3" id="salesGrid">
        {% for sale in sales %}
        <div class="col-6 col-lg-3 animate-in"
             style="animation-delay: {{ 0.3 + loop.index0 * 0.05 }}s;"
             data-sale-id="{{ sale.id }}"
             data-sale-name="{{ sale.item_name }}"
             data-sale-sku="{{ sale.sku | lower }}"
             data-sale-date="{{ sale.sale_date.strftime('%Y-%m-%d') }}"
             data-sale-price="{{ sale.sale_price }}"
             data-profit="{{ sale.profit }}"
             data-payment-status="{{ sale.payment_status }}"
             data-tracking="{{ sale.tracking_number or '' }}">

            <div class="sale-card">
                <div>
                    <div class="card-header-flex">
                        <h6 class="sale-title text-truncate" title="{{ sale.item_name }}">{{ sale.item_name }}</h6>
                    </div>

                    <div class="d-flex flex-wrap gap-2 mb-2">
                        <span class="status-badge {% if sale.payment_status == 're√ßu' %}status-re√ßu{% else %}status-attente{% endif %}">
                            {{ 'Re√ßu' if sale.payment_status == 're√ßu' else 'Attente' }}
                        </span>

                        {% if sale.tracking_number %}
                            {% if 'livr√©' in (sale.shipping_status|lower) or sale.shipping_status == 'DELIVERED' %}
                                <span class="mention-badge mention-livre">Livr√©</span>
                            {% else %}
                                <span class="mention-badge mention-transit">En transit</span>
                            {% endif %}
                        {% endif %}
                    </div>

                    <div class="card-meta">
                        <div class="meta-item text-truncate"><i class="bi bi-upc-scan"></i><span>{{ sale.sku }}</span></div>
                        <div class="meta-item"><i class="bi bi-rulers"></i><span>Taille: {{ sale.size }}</span></div>
                        <div class="meta-item"><i class="bi bi-calendar2-event"></i><span>{{ sale.sale_date.strftime('%d %b %Y') }}</span></div>
                    </div>
                </div>

                <div class="card-footer-flex">
                    <div class="sale-price-large">{{ "%.2f"|format(sale.sale_price) }} ‚Ç¨</div>
                    <div class="profit-pill {% if sale.profit >= 0 %}profit-pos{% else %}profit-neg{% endif %}">
                         {{ "%.2f"|format(sale.profit) }} ‚Ç¨
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div id="actionPanel">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="text-white fw-bold mb-0">Gestion Vente</h4>
            <button id="hideActionPanelBtn" class="btn btn-link text-muted p-0"><i class="bi bi-x-lg fs-5"></i></button>
        </div>
        <div class="premium-card mb-4">
            <h5 id="selected-sale-name-display" class="text-primary fw-bold mb-2" style="font-size: 1.1rem; word-break: break-word;"></h5>
            <button id="openTrackingBtn" class="btn btn-outline-info w-100 btn-sm fw-bold"><i class="bi bi-truck me-2"></i>Suivre l'exp√©dition</button>
        </div>
        <div class="d-grid gap-2 mb-4">
            <button type="button" class="btn btn-success py-3 fw-bold" id="setReceivedBtn">Marquer comme Re√ßu</button>
            <button type="button" class="btn btn-warning py-3 text-dark fw-bold" id="setPendingBtn">Mettre en attente</button>
        </div>
        <div class="d-grid gap-2">
            <a id="editSaleLink" href="#" class="btn btn-outline-info py-2">Modifier</a>
            <form id="deleteSaleForm" method="post">
                <button type="submit" class="btn btn-outline-danger w-100 py-2" onclick="return confirm('Supprimer ?');">Supprimer</button>
            </form>
        </div>
    </div>
</div>

<div id="trackingModal" class="cashback-modal-overlay">
    <div class="cashback-modal-content shadow-lg">
        <button class="cashback-modal-close" onclick="closeTrackingModal()">&times;</button>
        <div id="trackingInputSection">
            <h4 class="fw-bold mb-3"><i class="bi bi-radar me-2"></i>Suivi Vente</h4>
            <div class="form-group mb-3 text-start">
                <label class="small text-uppercase">Num√©ro de suivi</label>
                <input type="text" id="trackNumberInput" class="form-control bg-dark border-secondary text-white" placeholder="Ex: XW305613635TS">
            </div>
            <button onclick="startTracking()" class="btn btn-primary w-100 fw-bold">Lancer le scan</button>
        </div>

        <div id="trackingLogSection" style="display: none;">
            <div class="log-console mb-3" id="logConsole"></div>
            <div class="text-center"><div class="spinner-border text-primary spinner-border-sm" role="status"></div></div>
        </div>

        <div id="uiResultSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold m-0" id="uiStatusTitle">Exp√©di√©</h4>
                <span class="courier-badge" id="uiCourierName">Transporteur</span>
            </div>
            <p class="text-white-50 small mb-1" id="uiStatusLabel">Recherche du statut...</p>
            <div class="progress-track"><div class="progress-bar-neon" id="uiProgressBar" style="width: 0%"></div></div>
            <div class="row g-2 mb-4">
                <div class="col-6"><div class="info-box"><div class="info-label">Transit</div><div class="info-value" id="uiTransitDays">0 Jours</div></div></div>
                <div class="col-6"><div class="info-box"><div class="info-label">Livraison Est.</div><div class="info-value" id="uiEstDelivery">N/A</div></div></div>
            </div>
            <div id="uiTimeline" style="max-height: 180px; overflow-y: auto;"></div>
            <button class="btn btn-primary w-100 fw-bold mt-4" onclick="location.reload()">ACTUALISER</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const salesSearchInput = document.getElementById('salesSearch');
        const periodFilterSelect = document.getElementById('periodFilter');
        const paymentStatusFilterSelect = document.getElementById('paymentStatusFilter');
        const allCards = document.querySelectorAll('[data-sale-id]');
        const actionPanel = document.getElementById('actionPanel');
        const hideActionPanelBtn = document.getElementById('hideActionPanelBtn');
        const setReceivedBtn = document.getElementById('setReceivedBtn');
        const setPendingBtn = document.getElementById('setPendingBtn');
        const openTrackingBtn = document.getElementById('openTrackingBtn');
        const trackingModal = document.getElementById('trackingModal');
        const baseUrl = "{{ url_for('sales') }}";

        let currentSaleId = null, currentSaleCard = null;

        // --- TRACKING CLICK ---
        openTrackingBtn.addEventListener('click', () => {
            const trackingNum = currentSaleCard.dataset.tracking;
            document.getElementById('trackNumberInput').value = trackingNum || '';
            document.getElementById('trackingInputSection').style.display = 'block';
            document.getElementById('trackingLogSection').style.display = 'none';
            document.getElementById('uiResultSection').style.display = 'none';
            trackingModal.style.display = 'flex';
        });

        window.closeTrackingModal = () => { trackingModal.style.display = 'none'; }

        // --- APPEL √Ä LA ROUTE UNIVERSELLE ---
        window.startTracking = async () => {
            const num = document.getElementById('trackNumberInput').value;
            if(!num) return;
            document.getElementById('trackingInputSection').style.display = 'none';
            document.getElementById('trackingLogSection').style.display = 'block';
            const console = document.getElementById('logConsole');
            console.innerHTML = '> Scan Quantum Vente en cours...';

            try {
                // Utilisation de la route centralis√©e /api/track-live avec item_type: 'sale'
                const res = await fetch('/api/track-live', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        tracking_number: num,
                        save: true,
                        item_id: currentSaleId,
                        item_type: 'sale' // Indique qu'il s'agit d'une vente
                    })
                });
                const result = await res.json();
                if (result.success) {
                    const data = result.full_data;
                    document.getElementById('trackingLogSection').style.display = 'none';
                    document.getElementById('uiResultSection').style.display = 'block';
                    document.getElementById('uiStatusTitle').innerText = data.statusPlaceholder || "Transit";
                    document.getElementById('uiProgressBar').style.width = (data.statusProgressPercentage || 0) + "%";
                    const timeline = document.getElementById('uiTimeline');
                    timeline.innerHTML = '';
                    (data.steps || []).forEach(step => {
                        const item = document.createElement('div');
                        item.className = 'timeline-item';
                        item.innerHTML = `<div class=\"timeline-dot\"></div><div class=\"timeline-date\">${step.humanReadableTime}</div><div class=\"timeline-content\">${step.lines?.[0] || ''}</div>`;
                        timeline.appendChild(item);
                    });
                }
            } catch (e) { console.innerHTML += '<br>> Erreur r√©seau.'; }
        }

        // --- FILTRES ---
        function applyFilters() {
            const searchTerm = salesSearchInput.value.toLowerCase();
            const selectedPeriod = periodFilterSelect.value;
            const selectedStatus = paymentStatusFilterSelect.value;
            const today = new Date(); today.setHours(0,0,0,0);
            let count = 0, revenue = 0, profit = 0;

            allCards.forEach(card => {
                const name = card.dataset.saleName.toLowerCase(), sku = card.dataset.saleSku.toLowerCase(), status = card.dataset.paymentStatus, date = new Date(card.dataset.saleDate);
                date.setHours(0,0,0,0);
                const isSearch = name.includes(searchTerm) || sku.includes(searchTerm), isStatus = selectedStatus === 'all' || status === selectedStatus;
                let isPeriod = selectedPeriod === 'all' || (selectedPeriod === 'today' && date.getTime() === today.getTime());

                if (isSearch && isStatus && isPeriod) {
                    card.style.display = 'block'; count++;
                    revenue += parseFloat(card.dataset.salePrice); profit += parseFloat(card.dataset.profit);
                } else card.style.display = 'none';
            });
            document.getElementById('total-sales-count').textContent = count;
            document.getElementById('total-revenue').textContent = revenue.toLocaleString('fr-FR', {style:'currency', currency:'EUR'});
            document.getElementById('total-profit').textContent = profit.toLocaleString('fr-FR', {style:'currency', currency:'EUR'});
        }

        allCards.forEach(card => {
            card.addEventListener('click', function() {
                currentSaleId = this.dataset.saleId; currentSaleCard = this;
                document.getElementById('selected-sale-name-display').innerText = this.dataset.saleName;
                document.getElementById('editSaleLink').href = `${baseUrl}/${currentSaleId}/edit`;
                document.getElementById('deleteSaleForm').action = `${baseUrl}/${currentSaleId}/delete`;
                actionPanel.classList.add('show');
            });
        });

        hideActionPanelBtn.addEventListener('click', () => actionPanel.classList.remove('show'));
        salesSearchInput.addEventListener('input', applyFilters);
        [periodFilterSelect, paymentStatusFilterSelect].forEach(el => el.addEventListener('change', applyFilters));
        applyFilters();
    });
</script>
{% endblock %}