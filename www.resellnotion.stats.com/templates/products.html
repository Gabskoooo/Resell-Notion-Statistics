{# Dans templates/products.html #}
{% extends 'base.html' %}

{% block title %}Mes Produits{% endblock %}

{% block content %}
<style>
    /* Styles généraux de la page */
    body {
        background-color: #1a1a2e;
        color: #e0e0e0;
    }

    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }

    h1, h5, h6, p, .text-muted {
        color: #e0e0e0 !important;
    }

    /* KPI Summary Cards */
    .kpi-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
    }
    .kpi-label { color: #848e9c; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    .kpi-value { font-size: 1.5rem; font-weight: 700; color: #8a2be2; }

    /* Styles des cartes de produits */
    .product-card-item .card {
        background-color: #2a2a4a;
        border: none;
        border-radius: 12px;
        overflow: visible;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        position: relative;
    }

    .product-card-item .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
    }

    /* Badge Âge du stock */
    .age-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        color: #fff;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        z-index: 5;
        border: 1px solid rgba(255,255,255,0.1);
    }

    /* Menu Actions (...) */
    .product-options-menu {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }

    .options-btn {
        background: rgba(0, 0, 0, 0.3);
        border: none;
        color: #e0e0e0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.2s;
    }

    .options-btn:hover { background: rgba(138, 43, 226, 0.5); }

    .dropdown-menu-custom {
        background-color: #1e1e36;
        border: 1px solid #3a3a5a;
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }

    .dropdown-menu-custom .dropdown-item {
        color: #e0e0e0;
        padding: 8px 16px;
        font-size: 0.9rem;
    }

    .dropdown-menu-custom .dropdown-item:hover {
        background-color: #3a3a5a;
        color: #ffffff;
    }

    .product-card-img {
        width: 100%;
        height: 150px;
        object-fit: contain;
        background-color: #3a3a5a;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        padding: 10px;
    }

    .product-card-placeholder {
        width: 100%;
        height: 150px;
        background-color: #3a3a5a;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #5a5a7a;
        font-size: 3rem;
    }

    .product-card-item .card-body {
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
    }

    .product-card-item .card-title {
        font-size: 1.4rem;
        font-weight: bold;
        color: #8a2be2 !important;
        margin-bottom: 0.25rem;
        flex-grow: 1;
    }

    .product-card-item .card-subtitle {
        font-size: 0.9rem;
        color: #b0b0b0 !important;
        margin-bottom: 0.5rem;
    }

    .product-card-item .card-text {
        font-size: 1rem;
        color: #e0e0e0 !important;
        margin-bottom: 0.25rem;
    }

    /* Modal Styles */
    .cashback-modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none; justify-content: center; align-items: center; z-index: 1050;
    }
    .cashback-modal-content {
        background-color: #2a2a4a; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; color: #e0e0e0; text-align: center; position: relative;
    }
    .cashback-modal-close { position: absolute; top: 10px; right: 10px; background: transparent; border: none; font-size: 1.5rem; color: #e0e0e0; cursor: pointer; }
</style>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-white">Mes Produits</h1>
        <a href="{{ url_for('add_product') }}" class="btn btn-primary">Ajouter un produit</a>
    </div>

    <div class="row g-3 mb-4 animate__animated animate__fadeIn">
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-label">Stock Actuel</div>
                <div class="kpi-value text-white">{{ products|length }} <span style="font-size: 0.9rem; opacity: 0.6;">items</span></div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-label">Valeur d'Achat</div>
                {% set total_purchase = products | sum(attribute='purchase_price') %}
                <div class="kpi-value">{{ "%.2f"|format(total_purchase) }}€</div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="Rechercher par nom ou SKU...">
        </div>
        <div class="col-md-3 mb-3">
            <select id="sizeFilter" class="form-select">
                <option value="all">Toutes les tailles</option>
                {% for size in available_sizes %}
                    <option value="{{ size }}">{{ size }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3 mb-3">
            <select id="dateFilter" class="form-select">
                <option value="all">Toutes les dates</option>
                <option value="last7days">Derniers 7 jours</option>
                <option value="last30days">Derniers 30 jours</option>
                <option value="thismonth">Ce mois-ci</option>
                <option value="thisyear">Cette année</option>
            </select>
        </div>
    </div>

    {% if products %}
    <div id="productGrid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for product in products %}
        <div class="col product-card-item" data-date="{{ product.date_added.strftime('%Y-%m-%d') }}" data-product-size="{{ product.size }}">
            <div class="card h-100">

                {% set age = (product.date_added.utcnow() - product.date_added).days %}
                <div class="age-badge">
                    <i class="bi bi-clock-history me-1"></i>{{ age if age >= 0 else 0 }}j
                </div>

                <div class="dropdown product-options-menu">
                    <button class="options-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-custom">
                        <li><a class="dropdown-item cashback-btn" href="#" data-product-id="{{ product.id }}"><i class="bi bi-coin me-2"></i>Cashback</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('add_sale', product_id=product.id) }}"><i class="bi bi-tag me-2"></i>Vendre</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('edit_product', id=product.id) }}"><i class="bi bi-pencil me-2"></i>Modifier</a></li>
                        <li><hr class="dropdown-divider" style="border-color: rgba(255,255,255,0.1);"></li>
                        <li>
                            <form action="{{ url_for('delete_product', id=product.id) }}" method="post" onsubmit="return confirm('Êtes-vous sûr ?');">
                                <button type="submit" class="dropdown-item text-danger"><i class="bi bi-trash me-2"></i>Supprimer</button>
                            </form>
                        </li>
                    </ul>
                </div>

                {% if product.image_url %}
                    <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-card-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="product-card-placeholder" style="display: none;"><i class="bi bi-box-seam"></i></div>
                {% else %}
                    <div class="product-card-placeholder"><i class="bi bi-box-seam"></i></div>
                {% endif %}

                <div class="card-body">
                    <h5 class="card-title">{{ product.name | truncate(20, True, '...') }}</h5>
                    <p class="card-subtitle mb-1">SKU: {{ product.sku }}</p>
                    <p class="card-text mb-1">Taille: {{ product.size }}</p>
                    <p class="card-text mb-3">Prix d'achat: <strong>{{ "%.2f"|format(product.purchase_price) }}€</strong></p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center text-white mt-5">
        <h3>Aucun produit en stock.</h3>
    </div>
    {% endif %}

    <div id="no-products-found" class="text-center text-muted mt-5" style="display: none;">
        <h3>Aucun résultat trouvé.</h3>
    </div>
</div>

<div id="cashbackModal" class="cashback-modal-overlay">
    <div class="cashback-modal-content">
        <button class="cashback-modal-close">&times;</button>
        <h4>Ajouter du Cashback</h4>
        <p id="cashbackProductInfo"></p>
        <form id="cashbackForm">
            <input type="hidden" id="cashbackProductId" name="product_id">
            <div class="form-group mb-3">
                <label class="form-label">Montant du Cashback (€)</label>
                <input type="number" id="cashbackAmount" name="amount" class="form-control" step="0.01" min="0" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Valider</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const sizeFilter = document.getElementById('sizeFilter');
        const dateFilter = document.getElementById('dateFilter');
        const noProductsFound = document.getElementById('no-products-found');
        const allProductCards = document.querySelectorAll('.product-card-item');

        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedSize = sizeFilter.value;
            const selectedDateFilter = dateFilter.value;
            let found = false;

            allProductCards.forEach(cardItem => {
                const productName = cardItem.querySelector('.card-title').textContent.toLowerCase();
                const productSku = cardItem.querySelector('.card-subtitle').textContent.toLowerCase();
                const productSize = cardItem.dataset.productSize;
                const productDate = cardItem.dataset.date;

                const isSearchMatch = productName.includes(searchTerm) || productSku.includes(searchTerm);
                const isSizeMatch = selectedSize === 'all' || productSize === selectedSize;

                let isDateMatch = true;
                if (selectedDateFilter !== 'all') {
                    const today = new Date();
                    const dateAdded = new Date(productDate);
                    let filterDate = new Date();
                    switch(selectedDateFilter) {
                        case 'last7days': filterDate.setDate(today.getDate() - 7); isDateMatch = dateAdded >= filterDate; break;
                        case 'last30days': filterDate.setDate(today.getDate() - 30); isDateMatch = dateAdded >= filterDate; break;
                        case 'thismonth': isDateMatch = dateAdded.getMonth() === today.getMonth(); break;
                        case 'thisyear': isDateMatch = dateAdded.getFullYear() === today.getFullYear(); break;
                    }
                }

                if (isSearchMatch && isSizeMatch && isDateMatch) {
                    cardItem.style.display = "";
                    found = true;
                } else {
                    cardItem.style.display = "none";
                }
            });
            noProductsFound.style.display = found ? 'none' : 'block';
        }

        if (searchInput) searchInput.addEventListener('keyup', applyFilters);
        if (sizeFilter) sizeFilter.addEventListener('change', applyFilters);
        if (dateFilter) dateFilter.addEventListener('change', applyFilters);
    });

    const cashbackModal = document.getElementById('cashbackModal');
    const cashbackModalCloseBtn = document.querySelector('.cashback-modal-close');
    const cashbackForm = document.getElementById('cashbackForm');

    document.addEventListener('click', function(e) {
        if (e.target.closest('.cashback-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.cashback-btn');
            const card = btn.closest('.product-card-item');
            document.getElementById('cashbackProductId').value = btn.getAttribute('data-product-id');
            document.getElementById('cashbackProductInfo').textContent = `Produit: ${card.querySelector('.card-title').textContent.trim()}`;
            cashbackModal.style.display = 'flex';
        }
    });

    cashbackModalCloseBtn.addEventListener('click', () => cashbackModal.style.display = 'none');
</script>
{% endblock %}