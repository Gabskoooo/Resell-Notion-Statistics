{# Dans templates/products.html #}
{% extends 'base.html' %}

{% block title %}Mes Produits{% endblock %}

{% block content %}
<style>
    /* --- STYLES GÉNÉRAUX CONSERVÉS --- */
    body {
        background-color: #1a1a2e;
        color: #e0e0e0;
    }

    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }

    h1, h5, h6, p, .text-muted {
        color: #e0e0e0 !important;
    }

    /* --- TITRES & KPI --- */
    h1 { font-size: clamp(1.5rem, 5vw, 2.5rem); font-weight: 700; }
    .kpi-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        height: 100%;
    }
    .kpi-label { color: #848e9c; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    .kpi-value { font-size: 1.5rem; font-weight: 700; color: #8a2be2; }

    /* --- PRODUCT CARDS --- */
    .product-card-item .card {
        background-color: #2a2a4a;
        border: none;
        border-radius: 12px;
        overflow: visible;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        position: relative;
    }

    .product-card-item .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
    }

    /* --- TRACKING UI PREMIUM --- */
    .progress-track {
        height: 8px;
        background: #161625;
        border-radius: 10px;
        margin: 20px 0;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.05);
    }
    .progress-bar-neon {
        height: 100%;
        background: linear-gradient(90deg, #8a2be2, #00ffa3);
        box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
        transition: width 1s ease-in-out;
    }

    .timeline-item {
        position: relative;
        padding-left: 25px;
        margin-bottom: 15px;
        border-left: 2px solid rgba(138, 43, 226, 0.3);
    }
    .timeline-dot {
        position: absolute;
        left: -7px;
        top: 0;
        width: 12px;
        height: 12px;
        background: #8a2be2;
        border-radius: 50%;
        box-shadow: 0 0 10px #8a2be2;
    }
    .timeline-date { font-size: 0.65rem; color: #848e9c; text-transform: uppercase; }
    .timeline-content { font-size: 0.8rem; color: #fff; margin-top: 2px; line-height: 1.2; }

    .info-box {
        background: rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 10px;
        text-align: center;
    }
    .info-label { font-size: 0.6rem; color: #848e9c; text-transform: uppercase; margin-bottom: 2px; }
    .info-value { font-size: 0.85rem; font-weight: 700; color: #fff; }

    .courier-badge {
        background: rgba(138, 43, 226, 0.1);
        color: #8a2be2;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 700;
        border: 1px solid rgba(138, 43, 226, 0.3);
    }

    /* --- CYBER LOG CONSOLE --- */
    .log-console {
        background: #000;
        color: #00ff41;
        font-family: 'Courier New', monospace;
        padding: 15px;
        border-radius: 8px;
        font-size: 0.85rem;
        height: 180px;
        overflow-y: auto;
        text-align: left;
        border: 1px solid #333;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 50px;
        font-size: 0.65rem;
        font-weight: 800;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .status-pulse { width: 6px; height: 6px; border-radius: 50%; animation: status-blink 2s infinite; }
    @keyframes status-blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    /* Modals */
    .cashback-modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: none; justify-content: center; align-items: center; z-index: 1050;
        padding: 15px;
    }
    .cashback-modal-content {
        background-color: #2a2a4a; padding: 30px; border-radius: 20px; width: 100%; max-width: 500px; color: #e0e0e0; position: relative;
    }
    .cashback-modal-close {
        position: absolute; top: 15px; right: 20px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;
    }

    /* Images */
    .product-card-img { width: 100%; height: 180px; object-fit: contain; background-color: #3a3a5a; border-top-left-radius: 12px; border-top-right-radius: 12px; padding: 10px; }
    .product-card-placeholder { width: 100%; height: 180px; background-color: #3a3a5a; border-top-left-radius: 12px; border-top-right-radius: 12px; display: flex; align-items: center; justify-content: center; color: #5a5a7a; font-size: 3rem; }
</style>

<div class="container-fluid mt-4">
    <div class="header-section d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-white mb-0">Mes Produits</h1>
        <a href="{{ url_for('add_product') }}" class="btn btn-primary px-4 py-2 fw-bold rounded-pill">
            <i class="bi bi-plus-lg me-2"></i>Ajouter un produit
        </a>
    </div>

    <div class="row g-3 mb-4 animate__animated animate__fadeIn">
        <div class="col-12 col-md-4">
            <div class="kpi-card">
                <div class="kpi-label">Valeur Totale du Stock</div>
                <div class="kpi-value text-white">{{ "%.2f"|format(total_value) }}€</div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="kpi-card">
                <div class="kpi-label">Valeur du Stock Présent</div>
                <div class="kpi-value" style="color: #00ffa3;">{{ "%.2f"|format(present_value) }}€</div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="kpi-card">
                <div class="kpi-label">Valeur du Stock en Transit</div>
                <div class="kpi-value" style="color: #8a2be2;">{{ "%.2f"|format(transit_value) }}€</div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12 col-md-6">
            <input type="text" id="searchInput" class="form-control bg-dark border-secondary text-white" placeholder="Rechercher par nom ou SKU...">
        </div>
        <div class="col-6 col-md-3">
            <select id="sizeFilter" class="form-select bg-dark border-secondary text-white">
                <option value="all">Toutes les tailles</option>
                {% for size in available_sizes %}
                    <option value="{{ size }}">{{ size }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    {% if products %}
    <div id="productGrid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for product in products %}
        <div class="col product-card-item" data-date="{{ product.date_added.strftime('%Y-%m-%d') }}" data-product-size="{{ product.size }}">
            <div class="card">
                {% set age = (product.date_added.utcnow() - product.date_added).days %}
                <div class="age-badge" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; z-index: 5; border: 1px solid rgba(255,255,255,0.1);">
                    <i class="bi bi-clock-history me-1"></i>{{ age if age >= 0 else 0 }}j
                </div>

                <div class="dropdown product-options-menu" style="position: absolute; top: 10px; right: 10px; z-index: 10;">
                    <button class="btn btn-dark btn-sm rounded-circle options-btn" type="button" data-bs-toggle="dropdown" style="width: 32px; height: 32px; padding: 0;">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end bg-dark border-secondary">
                        <li>
                            <a class="dropdown-item text-white track-btn" href="#" data-product-id="{{ product.id }}" data-tracking="{{ product.tracking_number or '' }}">
                                <i class="bi bi-truck me-2 text-info"></i>{{ 'Suivre le colis' if product.tracking_number else 'Ajouter le suivi' }}
                            </a>
                        </li>
                        <li><a class="dropdown-item cashback-btn" href="#" data-product-id="{{ product.id }}"><i class="bi bi-coin me-2"></i>Cashback</a></li>
                        <li><hr class="dropdown-divider" style="border-color: rgba(255,255,255,0.1);"></li>
                        <li>
                            <form action="{{ url_for('delete_product', id=product.id) }}" method="post" onsubmit="return confirm('Êtes-vous sûr ?');">
                                <button type="submit" class="dropdown-item text-danger">Supprimer</button>
                            </form>
                        </li>
                    </ul>
                </div>

                {% if product.image_url %}
                    <img src="{{ product.image_url }}" class="product-card-img" onerror="this.src='https://placehold.co/200x200/3a3a5a/white?text=Box';">
                {% else %}
                    <div class="product-card-placeholder"><i class="bi bi-box-seam"></i></div>
                {% endif %}

                <div class="card-body">
                    <h5 class="card-title" style="color: #8a2be2 !important; font-weight: bold;">{{ product.name | truncate(25, True, '...') }}</h5>
                    {% if product.tracking_number %}
                    <div class="mb-2">
                        <span class="status-badge" style="color: {% if 'livré' in (product.shipping_status|lower) %}#00ffa3{% else %}#8a2be2{% endif %}; border-color: currentColor;">
                            <span class="status-pulse" style="background: currentColor;"></span>
                            {{ product.shipping_status }}
                        </span>
                    </div>
                    {% endif %}
                    <p class="card-text mb-0 mt-auto pt-3">Achat: <strong class="text-success">{{ "%.2f"|format(product.purchase_price) }}€</strong></p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<div id="trackingModal" class="cashback-modal-overlay">
    <div class="cashback-modal-content shadow-lg">
        <button class="cashback-modal-close" onclick="closeTrackingModal()">&times;</button>

        <div id="trackingInputSection">
            <h4 class="fw-bold mb-3"><i class="bi bi-radar me-2"></i>Tracking Système</h4>
            <div class="form-group mb-3 text-start">
                <label class="small text-uppercase">Numéro de suivi</label>
                <input type="text" id="trackNumberInput" class="form-control bg-dark border-secondary text-white" placeholder="Ex: XW305613635TS">
            </div>
            <button onclick="startTracking()" class="btn btn-primary w-100 fw-bold">Lancer le scan</button>
        </div>

        <div id="trackingLogSection" style="display: none;">
            <div class="log-console mb-3" id="logConsole"></div>
            <div class="text-center"><div class="spinner-border text-primary spinner-border-sm" role="status"></div></div>
        </div>

        <div id="uiResultSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold m-0" id="uiStatusTitle">Expédié</h4>
                <span class="courier-badge" id="uiCourierName">Transporteur</span>
            </div>
            <p class="text-white-50 small mb-1" id="uiStatusLabel">Recherche du statut...</p>
            <div class="progress-track"><div class="progress-bar-neon" id="uiProgressBar" style="width: 0%"></div></div>
            <div class="row g-2 mb-4">
                <div class="col-6"><div class="info-box"><div class="info-label">Transit</div><div class="info-value" id="uiTransitDays">0 Jours</div></div></div>
                <div class="col-6"><div class="info-box"><div class="info-label">Livraison Est.</div><div class="info-value" id="uiEstDelivery">N/A</div></div></div>
            </div>
            <div id="uiTimeline" style="max-height: 180px; overflow-y: auto;"></div>
            <button class="btn btn-primary w-100 fw-bold mt-4" onclick="location.reload()">ACTUALISER</button>
        </div>
    </div>
</div>

<script>
    let currentId = null;

    // --- FILTERS ---
    document.getElementById('searchInput').addEventListener('keyup', (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.product-card-item').forEach(card => {
            const name = card.querySelector('.card-title').textContent.toLowerCase();
            card.style.display = name.includes(term) ? "" : "none";
        });
    });

    // --- TRACKING CLICK ---
    document.addEventListener('click', e => {
        const btn = e.target.closest('.track-btn');
        if (btn) {
            e.preventDefault();
            currentId = btn.dataset.productId;
            document.getElementById('trackNumberInput').value = btn.dataset.tracking;
            document.getElementById('trackingModal').style.display = 'flex';
        }
    });

    function closeTrackingModal() { document.getElementById('trackingModal').style.display = 'none'; }

    async function startTracking() {
        const num = document.getElementById('trackNumberInput').value;
        if(!num) return;

        document.getElementById('trackingInputSection').style.display = 'none';
        document.getElementById('trackingLogSection').style.display = 'block';
        const console = document.getElementById('logConsole');
        console.innerHTML = '> Initialisation du tunnel Quantum...';

        try {
            // ADAPTATION À LA ROUTE UNIVERSELLE
            const res = await fetch('/api/track-live', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    tracking_number: num,
                    save: true,
                    item_id: currentId,
                    item_type: 'product' // Indique qu'il s'agit d'un produit
                })
            });
            const result = await res.json();

            if (result.success) {
                const data = result.full_data;
                document.getElementById('trackingLogSection').style.display = 'none';
                document.getElementById('uiResultSection').style.display = 'block';

                document.getElementById('uiStatusTitle').innerText = data.statusPlaceholder || "Expédié";
                document.getElementById('uiStatusLabel').innerText = result.status;
                document.getElementById('uiCourierName').innerText = data.couriers?.[0]?.name || "Inconnu";
                document.getElementById('uiProgressBar').style.width = (data.statusProgressPercentage || 0) + "%";
                document.getElementById('uiTransitDays').innerText = (data.daysInTransit || 0) + " Jours";
                document.getElementById('uiEstDelivery').innerText = data.humanReadableEstimatedDelivery || "Calcul...";

                const timeline = document.getElementById('uiTimeline');
                timeline.innerHTML = '';
                (data.steps || []).forEach(step => {
                    const item = document.createElement('div');
                    item.className = 'timeline-item';
                    item.innerHTML = `<div class="timeline-dot"></div><div class="timeline-date">${step.humanReadableTime}</div><div class="timeline-content">${step.lines?.[0] || ''}</div>`;
                    timeline.appendChild(item);
                });
            }
        } catch (e) { console.innerHTML += '<br>> Erreur technique.'; }
    }
</script>
{% endblock %}