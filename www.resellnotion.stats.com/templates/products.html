{# Dans templates/products.html #}
{% extends 'base.html' %}

{% block title %}Mes Produits{% endblock %}

{% block content %}
<style>
    /* Styles généraux */
    body {
        background-color: #1a1a2e;
        color: #e0e0e0;
    }

    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }

    h1, h5, h6, p, .text-muted {
        color: #e0e0e0 !important;
    }

    /* --- TITRES & KPI --- */
    h1 { font-size: clamp(1.5rem, 5vw, 2.5rem); font-weight: 700; }
    .kpi-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        height: 100%;
    }
    .kpi-label { color: #848e9c; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    .kpi-value { font-size: 1.5rem; font-weight: 700; color: #8a2be2; }

    /* --- PRODUCT CARDS --- */
    .product-card-item .card {
        background-color: #2a2a4a;
        border: none;
        border-radius: 12px;
        overflow: visible;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        position: relative;
    }

    .product-card-item .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
    }

    /* --- TRACKING UI (CYBER LOG) --- */
    .log-console {
        background: #000;
        color: #00ff41;
        font-family: 'Courier New', monospace;
        padding: 15px;
        border-radius: 8px;
        font-size: 0.85rem;
        height: 200px;
        overflow-y: auto;
        text-align: left;
        border: 1px solid var(--primary-glow);
    }
    .log-entry { margin-bottom: 5px; }
    .log-success { color: var(--success-glow); }

    .status-badge {
        padding: 4px 12px;
        border-radius: 50px;
        font-size: 0.65rem;
        font-weight: 800;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .status-pulse { width: 6px; height: 6px; border-radius: 50%; animation: status-blink 2s infinite; }
    @keyframes status-blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    /* Styles Modals */
    .cashback-modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: none; justify-content: center; align-items: center; z-index: 1050;
        padding: 15px;
    }
    .cashback-modal-content {
        background-color: #2a2a4a; padding: 30px; border-radius: 20px; width: 100%; max-width: 450px; color: #e0e0e0; position: relative;
    }
    .cashback-modal-close {
        position: absolute; top: 15px; right: 20px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;
    }

    /* Image Handling */
    .product-card-img { width: 100%; height: 180px; object-fit: contain; background-color: #3a3a5a; border-top-left-radius: 12px; border-top-right-radius: 12px; padding: 10px; }
    .product-card-placeholder { width: 100%; height: 180px; background-color: #3a3a5a; border-top-left-radius: 12px; border-top-right-radius: 12px; display: flex; align-items: center; justify-content: center; color: #5a5a7a; font-size: 3rem; }
</style>

<div class="container-fluid mt-4">
    <div class="header-section d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-white mb-0">Mes Produits</h1>
        <a href="{{ url_for('add_product') }}" class="btn btn-primary px-4 py-2 fw-bold rounded-pill">
            <i class="bi bi-plus-lg me-2"></i>Ajouter un produit
        </a>
    </div>

    <div class="row g-3 mb-4 animate__animated animate__fadeIn">
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-label">Stock Actuel</div>
                <div class="kpi-value text-white">{{ products|length }} <span style="font-size: 0.8rem; opacity: 0.6;">items</span></div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-label">Valeur d'Achat</div>
                {% set total_purchase = products | sum(attribute='purchase_price') %}
                <div class="kpi-value">{{ "%.2f"|format(total_purchase) }}€</div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12 col-md-6">
            <input type="text" id="searchInput" class="form-control bg-dark border-secondary text-white" placeholder="Rechercher par nom ou SKU...">
        </div>
        <div class="col-6 col-md-3">
            <select id="sizeFilter" class="form-select bg-dark border-secondary text-white">
                <option value="all">Toutes les tailles</option>
                {% for size in available_sizes %}
                    <option value="{{ size }}">{{ size }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-6 col-md-3">
            <select id="dateFilter" class="form-select bg-dark border-secondary text-white">
                <option value="all">Toutes les dates</option>
                <option value="last7days">Derniers 7 jours</option>
            </select>
        </div>
    </div>

    {% if products %}
    <div id="productGrid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for product in products %}
        <div class="col product-card-item" data-date="{{ product.date_added.strftime('%Y-%m-%d') }}" data-product-size="{{ product.size }}">
            <div class="card">
                {% set age = (product.date_added.utcnow() - product.date_added).days %}
                <div class="age-badge" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; z-index: 5; border: 1px solid rgba(255,255,255,0.1);">
                    <i class="bi bi-clock-history me-1"></i>{{ age if age >= 0 else 0 }}j
                </div>

                <div class="dropdown product-options-menu" style="position: absolute; top: 10px; right: 10px; z-index: 10;">
                    <button class="btn btn-dark btn-sm rounded-circle options-btn" type="button" data-bs-toggle="dropdown" style="width: 32px; height: 32px; padding: 0;">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-custom" style="background-color: #1e1e36; border: 1px solid #3a3a5a;">
                        <li>
                            {% if product.tracking_number %}
                                <a class="dropdown-item track-btn" href="#" data-product-id="{{ product.id }}" data-tracking="{{ product.tracking_number }}">
                                    <i class="bi bi-truck me-2 text-info"></i>Suivre le colis
                                </a>
                            {% else %}
                                <a class="dropdown-item track-btn" href="#" data-product-id="{{ product.id }}">
                                    <i class="bi bi-plus-circle me-2"></i>Ajouter le suivi
                                </a>
                            {% endif %}
                        </li>
                        <li><a class="dropdown-item cashback-btn" href="#" data-product-id="{{ product.id }}"><i class="bi bi-coin me-2"></i>Cashback</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('add_sale', product_id=product.id) }}"><i class="bi bi-tag me-2"></i>Vendre</a></li>
                        <li><hr class="dropdown-divider" style="border-color: rgba(255,255,255,0.1);"></li>
                        <li>
                            <form action="{{ url_for('delete_product', id=product.id) }}" method="post" onsubmit="return confirm('Êtes-vous sûr ?');">
                                <button type="submit" class="dropdown-item text-danger"><i class="bi bi-trash me-2"></i>Supprimer</button>
                            </form>
                        </li>
                    </ul>
                </div>

                {% if product.image_url %}
                    <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-card-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="product-card-placeholder" style="display: none;"><i class="bi bi-box-seam"></i></div>
                {% else %}
                    <div class="product-card-placeholder"><i class="bi bi-box-seam"></i></div>
                {% endif %}

                <div class="card-body">
                    <h5 class="card-title" style="color: #8a2be2 !important; font-weight: bold;">{{ product.name | truncate(25, True, '...') }}</h5>

                    {% if product.tracking_number %}
                    <div class="mb-2">
                        <span class="status-badge {% if product.shipping_status == 'DELIVERED' %}status-delivered{% else %}status-transit{% endif %}">
                            <span class="status-pulse" style="background: {% if product.shipping_status == 'DELIVERED' %}#00ffa3{% else %}#8a2be2{% endif %};"></span>
                            {{ product.shipping_status }}
                        </span>
                    </div>
                    {% endif %}

                    <p class="card-subtitle mb-1 small">SKU: <span class="text-white-50">{{ product.sku }}</span></p>
                    <p class="card-text mb-1 small">Taille: <span class="fw-bold">{{ product.size }}</span></p>
                    <p class="card-text mb-0 mt-auto pt-3">Achat: <strong class="text-success">{{ "%.2f"|format(product.purchase_price) }}€</strong></p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center text-white mt-5 py-5">
        <i class="bi bi-box-seam text-muted" style="font-size: 3rem; opacity: 0.3;"></i>
        <h3 class="mt-3">Aucun produit en stock.</h3>
    </div>
    {% endif %}
</div>

<div id="trackingModal" class="cashback-modal-overlay">
    <div class="cashback-modal-content shadow-lg">
        <button class="cashback-modal-close" onclick="closeTrackingModal()">&times;</button>
        <h4 class="fw-bold mb-3"><i class="bi bi-radar me-2"></i>Tracking Système</h4>

        <div id="trackingInputSection">
            <div class="form-group mb-3 text-start">
                <label class="small text-uppercase">Numéro de suivi</label>
                <input type="text" id="trackNumberInput" class="form-control bg-dark border-secondary text-white" placeholder="Ex: XW305613635TS">
            </div>
            <div class="form-check text-start mb-3" id="saveTrackingCheckSection">
                <input class="form-check-input" type="checkbox" id="saveTrackingCheck" checked>
                <label class="form-check-label small" for="saveTrackingCheck">Enregistrer dans l'inventaire</label>
            </div>
            <button onclick="startTracking()" class="btn btn-primary w-100 fw-bold">Lancer le scan</button>
        </div>

        <div id="trackingLogSection" style="display: none;">
            <div class="log-console mb-3" id="logConsole"></div>
            <div id="trackingResult"></div>
        </div>
    </div>
</div>

<div id="cashbackModal" class="cashback-modal-overlay">
    <div class="cashback-modal-content shadow-lg">
        <button class="cashback-modal-close" onclick="document.getElementById('cashbackModal').style.display='none'">&times;</button>
        <h4 class="fw-bold mb-3">Ajouter du Cashback</h4>
        <p id="cashbackProductInfo" class="small text-white-50 mb-4"></p>
        <form id="cashbackForm">
            <input type="hidden" id="cashbackProductId" name="product_id">
            <div class="form-group mb-4 text-start">
                <label class="form-label small text-uppercase">Montant (€)</label>
                <input type="number" id="cashbackAmount" name="amount" class="form-control bg-dark border-secondary text-white py-2" step="0.01" min="0" required>
            </div>
            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">Valider</button>
        </form>
    </div>
</div>



<script>
    let currentProductId = null;

    // --- FILTERS LOGIC ---
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const sizeFilter = document.getElementById('sizeFilter');
        const dateFilter = document.getElementById('dateFilter');

        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedSize = sizeFilter.value;
            const allProductCards = document.querySelectorAll('.product-card-item');

            allProductCards.forEach(cardItem => {
                const productName = cardItem.querySelector('.card-title').textContent.toLowerCase();
                const productSku = cardItem.querySelector('.card-subtitle').textContent.toLowerCase();
                const productSize = cardItem.dataset.productSize;

                const isSearchMatch = productName.includes(searchTerm) || productSku.includes(searchTerm);
                const isSizeMatch = selectedSize === 'all' || productSize === selectedSize;

                cardItem.style.display = (isSearchMatch && isSizeMatch) ? "" : "none";
            });
        }

        if (searchInput) searchInput.addEventListener('keyup', applyFilters);
        if (sizeFilter) sizeFilter.addEventListener('change', applyFilters);
    });

    // --- TRACKING LOGIC ---
    document.addEventListener('click', function(e) {
        if (e.target.closest('.track-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.track-btn');
            currentProductId = btn.getAttribute('data-product-id');
            const existingTrack = btn.getAttribute('data-tracking');

            document.getElementById('trackNumberInput').value = existingTrack || '';
            document.getElementById('trackingInputSection').style.display = 'block';
            document.getElementById('trackingLogSection').style.display = 'none';
            document.getElementById('logConsole').innerHTML = '';
            document.getElementById('trackingResult').innerHTML = '';
            document.getElementById('saveTrackingCheckSection').style.display = existingTrack ? 'none' : 'block';

            document.getElementById('trackingModal').style.display = 'flex';
        }

        if (e.target.closest('.cashback-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.cashback-btn');
            const card = btn.closest('.product-card-item');
            document.getElementById('cashbackProductId').value = btn.getAttribute('data-product-id');
            document.getElementById('cashbackProductInfo').textContent = `Produit: ${card.querySelector('.card-title').textContent.trim()}`;
            document.getElementById('cashbackModal').style.display = 'flex';
        }
    });

    function closeTrackingModal() {
        document.getElementById('trackingModal').style.display = 'none';
    }

    async function startTracking() {
        const num = document.getElementById('trackNumberInput').value;
        const save = document.getElementById('saveTrackingCheck').checked;
        if(!num) return;

        document.getElementById('trackingInputSection').style.display = 'none';
        document.getElementById('trackingLogSection').style.display = 'block';

        const console = document.getElementById('logConsole');
        const addLog = (text, type = '') => {
            console.innerHTML += `<div class="log-entry ${type}">> ${text}</div>`;
            console.scrollTop = console.scrollHeight;
        };

        addLog("Initialisation de la session sécurisée...");
        await new Promise(r => setTimeout(r, 1000));
        addLog("Rotation IP Quantum effectuée. Signature Chrome validée.");
        await new Promise(r => setTimeout(r, 600));
        addLog("Interrogation des serveurs de transit...");

        try {
            const response = await fetch('/api/track-live', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({tracking_number: num, save: save, product_id: currentProductId})
            });
            const result = await response.json();

            if (result.success) {
                addLog("Validation des paquets de données reçue.", "log-success");
                await new Promise(r => setTimeout(r, 400));

                // Utilisation de result.status (le statusLabel de l'API)
                addLog(`STATUT DÉTECTÉ : ${result.status}`, "log-success");

                // Affichage détaillé de l'historique dans la console Cyber
                const steps = result.full_data.steps || [];
                steps.forEach(step => {
                    addLog(`--- ${step.humanReadableTime} ---`, "text-info small");
                    if (step.lines) {
                        step.lines.forEach(line => addLog(line, "small opacity-75"));
                    }
                });

                document.getElementById('trackingResult').innerHTML = `
                    <div class="alert alert-info bg-dark border-info text-info small mb-3 mt-3">
                        <i class="bi bi-info-circle me-2"></i><strong>${result.status}</strong>
                    </div>
                    <button class="btn btn-primary btn-sm w-100 fw-bold" onclick="location.reload()">TERMINER ET ACTUALISER</button>
                `;
            } else {
                addLog("ERREUR : " + result.message, "text-danger");
            }
        } catch (err) {
            addLog("ERREUR SYSTÈME : Tunnel rompu.", "text-danger");
        }
    }
</script>
{% endblock %}