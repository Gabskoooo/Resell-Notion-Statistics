{% extends 'base.html' %}

{% block title %}Enregistrer Ventes | ResellNotion{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        --glass-bg: rgba(255, 255, 255, 0.03);
        --glass-border: rgba(255, 255, 255, 0.08);
        --primary-glow: #8a2be2;
        --success-glow: #00ffa3;
        --danger-glow: #ff4d4d;
        --warning-glow: #ffcc00;
    }

    body {
        background: #0b0e14;
        background-image:
            radial-gradient(circle at 0% 0%, rgba(138, 43, 226, 0.1) 0%, transparent 35%),
            radial-gradient(circle at 100% 100%, rgba(0, 255, 163, 0.05) 0%, transparent 35%);
        color: #f8f9fa;
        font-family: 'Plus Jakarta Sans', sans-serif;
        min-height: 100vh;
    }

    /* --- ANIMATION SUCCÈS --- */
    #success-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(11, 14, 20, 0.95); z-index: 10000;
        display: none; flex-direction: column; align-items: center; justify-content: center;
        backdrop-filter: blur(10px);
    }
    .checkmark__circle {
        stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 2;
        stroke-miterlimit: 10; stroke: var(--success-glow); fill: none;
        animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    .checkmark {
        width: 100px; height: 100px; border-radius: 50%; display: block;
        stroke-width: 2; stroke: #fff; stroke-miterlimit: 10;
        box-shadow: inset 0px 0px 0px var(--success-glow);
        animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s cubic-bezier(0.47, 0, 0.745, 0.715) forwards;
    }
    .checkmark__check {
        transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48;
        animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    @keyframes stroke { 100% { stroke-dashoffset: 0; } }
    @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
    @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 50px var(--success-glow); } }

    /* --- TITRES --- */
    .section-title { font-weight: 700; letter-spacing: -1px; text-transform: uppercase; }
    .section-title span { background: var(--glass-bg); padding: 2px 10px; border-radius: 8px; color: #8e9297; }

    /* --- STEP CARDS --- */
    .step-card {
        background: var(--glass-bg) !important;
        border: 1px solid var(--glass-border) !important;
        border-radius: 24px; padding: 30px; margin-bottom: 25px;
        backdrop-filter: blur(10px); display: none;
    }
    .step-card.active-step { display: block !important; animation: fadeIn 0.4s ease; border-color: rgba(255, 255, 255, 0.2) !important; }

    .step-header { margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; display: flex; align-items: center; gap: 15px; }
    .step-number { width: 32px; height: 32px; border-radius: 10px; background: var(--primary-glow); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; }
    .step-title { font-size: 1.1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0; }

    /* --- GRILLE & PRODUCT CARDS --- */
    .product-selection-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
        gap: 15px; max-height: 450px; overflow-y: auto; padding: 5px;
    }
    .product-card {
        background: rgba(255, 255, 255, 0.04); border: 1px solid var(--glass-border);
        border-radius: 18px; padding: 15px; text-align: center; cursor: pointer;
        transition: 0.3s all ease; display: flex !important; flex-direction: column; align-items: center;
    }
    .product-card:hover { background: rgba(255, 255, 255, 0.08); transform: translateY(-5px); border-color: var(--primary-glow); }
    .product-card.selected { border-color: var(--primary-glow); background: rgba(138, 43, 226, 0.15) !important; box-shadow: 0 0 20px rgba(138, 43, 226, 0.3); }

    .product-card-img { width: 100%; height: 100px; object-fit: contain; margin-bottom: 12px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); background: white; padding: 5px; border-radius: 10px; }
    .product-card h6 { font-size: 0.85rem; font-weight: 700; color: #fff; margin-bottom: 4px; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* --- INPUTS & BOUTONS --- */
    .form-control { background: rgba(0, 0, 0, 0.2) !important; border: 1px solid var(--glass-border) !important; color: #fff !important; border-radius: 12px !important; padding: 12px 15px !important; }
    .form-control:focus { border-color: var(--primary-glow) !important; box-shadow: 0 0 15px rgba(138, 43, 226, 0.2) !important; }
    .form-label { font-size: 0.75rem; font-weight: 700; color: #8e9297; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }

    .btn-choice {
        background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
        color: #8e9297; padding: 12px; border-radius: 14px; cursor: pointer; transition: 0.3s;
        text-align: center; font-size: 0.8rem; font-weight: 600;
    }
    .btn-choice:hover { background: rgba(255,255,255,0.08); color: #fff; }
    .btn-choice.selected { border-color: var(--primary-glow); background: rgba(138, 43, 226, 0.2); color: #fff; box-shadow: 0 0 10px rgba(138, 43, 226, 0.2); }

    .btn-primary { background: var(--primary-glow) !important; border: none !important; border-radius: 16px !important; font-weight: 700 !important; }
    .btn-success { background: var(--success-glow) !important; border: none !important; color: #0b0e14 !important; border-radius: 16px !important; font-weight: 700 !important; }

    #bulkSummary {
        background: rgba(0, 255, 163, 0.1); border: 1px solid rgba(0, 255, 163, 0.2);
        color: var(--success-glow); border-radius: 16px; font-weight: 600;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div id="success-overlay">
    <div class="success-animation">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
    </div>
    <h2 class="mt-4 text-white fw-bold">Vente enregistrée !</h2>
</div>

<div class="container py-5" style="max-width: 900px;">
    <h1 class="text-white text-center mb-5 section-title">Vente <span>MULTI-PAIRES</span></h1>

    <div id="bulkSummary" class="alert d-none mb-4 animate__animated animate__fadeIn">
        <div class="d-flex align-items-center">
            <i class="bi bi-cart-check-fill fs-4 me-3"></i>
            <div>
                <strong>Panier en attente :</strong> <span id="saleCount">0</span> paire(s) ajoutée(s).
            </div>
        </div>
    </div>

    <form id="multi-sale-form">
        {# Étape 1: Sélection du Produit #}
        <div class="step-card active-step" id="step-1">
            <div class="step-header">
                <div class="step-number text-white">1</div>
                <h3 class="step-title text-white">Sélectionner l'article</h3>
            </div>
            <div class="step-content">
                <div class="input-group mb-4">
                    <span class="input-group-text border-0 bg-transparent text-muted"><i class="bi bi-search"></i></span>
                    <input type="text" id="productSearch" class="form-control" placeholder="Rechercher par nom, taille ou SKU...">
                </div>
                <div class="product-selection-grid" id="productGrid">
                    {% for product in products %}
                    <div class="product-card"
                         data-id="{{ product.id }}"
                         data-name="{{ product.name }}"
                         data-sku="{{ product.sku }}"
                         data-size="{{ product.size }}">
                        {% if product.image_url %}
                            <img src="{{ product.image_url }}" class="product-card-img" onerror="this.src='/static/placeholder_product.png'">
                        {% else %}
                            <div style="height:100px; width:100%; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.3); border-radius:10px; margin-bottom:12px;">
                                <i class="bi bi-box-seam" style="font-size: 2rem; color: #4e5257;"></i>
                            </div>
                        {% endif %}
                        <h6>{{ product.name }}</h6>
                        <div class="text-muted" style="font-size: 0.7rem;">Taille: <span class="text-white">{{ product.size }}</span></div>
                        <div class="small fw-bold mt-1" style="color: var(--primary-glow)">{{ product.sku }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# Étape 2: Détails #}
        <div class="step-card mt-4" id="step-2">
            <div class="step-header">
                <div class="step-number text-white">2</div>
                <h3 class="step-title text-white">Détails de la vente</h3>
            </div>
            <div class="step-content">
                <div class="premium-card mb-4 p-3" style="background: rgba(138, 43, 226, 0.05); border: 1px solid rgba(138, 43, 226, 0.2); border-radius: 16px;">
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.6rem; letter-spacing: 1px;">Article sélectionné</small>
                    <h5 class="text-white fw-bold mb-0 mt-1" id="display-name">-</h5>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Prix de vente (€)</label>
                        <input type="number" step="0.01" class="form-control" id="sale_price" placeholder="0.00">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Date de transaction</label>
                        <input type="date" class="form-control" id="sale_date" value="{{ today }}">
                    </div>
                    <div class="col-12 mt-4">
                        <label class="form-label">Plateforme de vente</label>
                        <div class="row g-2">
                            {% set platform_list = ['StockX', 'Vinted', 'Alias', 'LBC', 'Ebay', 'Discord', 'Limited Resell', 'Laced', 'Units Supply', 'Wethenew', 'Autre'] %}
                            {% for p in platform_list %}
                            <div class="col-4 col-md-3">
                                <div class="btn-choice platform-opt" data-val="{{ p }}">{{ p }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-12 mt-4">
                        <label class="form-label">Statut du Règlement</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="btn-choice status-opt fw-bold" data-val="reçu" style="color: var(--success-glow);">REÇU</div>
                            </div>
                            <div class="col-6">
                                <div class="btn-choice status-opt fw-bold" data-val="en_attente" style="color: var(--warning-glow);">EN ATTENTE</div>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary w-100 mt-5 py-3 fw-bold shadow" id="btnNextTo3">VALIDER CETTE PAIRE <i class="bi bi-arrow-right ms-2"></i></button>
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-link text-muted text-decoration-none small" onclick="goToStep(1)"><i class="bi bi-chevron-left"></i> Retour à la sélection</button>
                </div>
            </div>
        </div>

        {# Étape 3: Choix Final #}
        <div class="step-card mt-4 text-center" id="step-3">
            <div class="step-header">
                <div class="step-number text-white">3</div>
                <h3 class="step-title text-white">Confirmation</h3>
            </div>
            <div class="step-content py-4">
                <div class="mb-4"><i class="bi bi-check-circle-fill" style="font-size: 5rem; color: var(--success-glow); filter: drop-shadow(0 0 15px rgba(0, 255, 163, 0.4));"></i></div>
                <h4 class="text-white fw-bold mb-4">Vente prête à être enregistrée !</h4>
                <div class="d-grid gap-3">
                    <button type="button" class="btn btn-choice py-3" id="addAnother" style="background: rgba(255,255,255,0.05); color: #fff;">
                        <i class="bi bi-plus-circle me-2"></i> VENDRE UN AUTRE PRODUIT
                    </button>
                    <button type="button" class="btn btn-success py-4 fw-bold shadow-lg" id="saveAll" style="font-size: 1.1rem;">
                        <i class="bi bi-cloud-upload me-2"></i> ENREGISTRER TOUT ET TERMINER
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// LOGIQUE JS CONSERVÉE À L'IDENTIQUE
document.addEventListener('DOMContentLoaded', function() {
    let allSales = [];
    let currentSale = {};
    const cards = document.querySelectorAll('.product-card');

    function goToStep(n) {
        document.querySelectorAll('.step-card').forEach(s => s.classList.remove('active-step'));
        document.getElementById('step-' + n).classList.add('active-step');
        window.scrollTo(0, 0);
    }

    // 1. Sélection du produit
    cards.forEach(card => {
        card.addEventListener('click', function() {
            cards.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');

            currentSale = {
                product_id: this.dataset.id,
                item_name: this.dataset.name
            };
            document.getElementById('display-name').textContent = this.dataset.name;
            goToStep(2);
        });
    });

    // 2. Sélection Plateforme & Statut
    document.querySelectorAll('.platform-opt, .status-opt').forEach(opt => {
        opt.addEventListener('click', function() {
            const isPlat = this.classList.contains('platform-opt');
            document.querySelectorAll(isPlat ? '.platform-opt' : '.status-opt').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');

            if(isPlat) currentSale.platform = this.dataset.val;
            else currentSale.payment_status = this.dataset.val;
        });
    });

    // 3. Bouton Suivant
    document.getElementById('btnNextTo3').addEventListener('click', function() {
        currentSale.sale_price = document.getElementById('sale_price').value;
        currentSale.sale_date = document.getElementById('sale_date').value;

        if (!currentSale.sale_price || !currentSale.platform || !currentSale.payment_status) {
            alert("Veuillez remplir tous les champs.");
            return;
        }

        allSales.push({...currentSale});
        document.getElementById('bulkSummary').classList.remove('d-none');
        document.getElementById('saleCount').textContent = allSales.length;
        goToStep(3);
    });

    // 4. Vendre un autre
    document.getElementById('addAnother').addEventListener('click', () => {
        document.getElementById('sale_price').value = "";
        document.querySelectorAll('.platform-opt, .status-opt').forEach(s => s.classList.remove('selected'));
        currentSale = {};
        goToStep(1);
    });

    // 5. Envoi final avec animation
    document.getElementById('saveAll').addEventListener('click', async function() {
        this.disabled = true;
        const res = await fetch('/sales/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({sales: allSales})
        });
        const data = await res.json();

        if(data.success) {
            document.getElementById('success-overlay').style.display = 'flex';
            setTimeout(() => {
                window.location.href = data.redirect;
            }, 2500);
        } else {
            alert("Erreur: " + data.message);
            this.disabled = false;
        }
    });

    // Recherche multi-critères (Nom, SKU, Taille)
    document.getElementById('productSearch').addEventListener('input', function() {
        const term = this.value.toLowerCase().trim();
        cards.forEach(card => {
            const name = card.getAttribute('data-name').toLowerCase();
            const sku = card.getAttribute('data-sku').toLowerCase();
            const size = card.getAttribute('data-size').toLowerCase();

            if (name.includes(term) || sku.includes(term) || size.includes(term)) {
                card.style.setProperty('display', 'flex', 'important');
            } else {
                card.style.setProperty('display', 'none', 'important');
            }
        });
    });
});
</script>
{% endblock %}