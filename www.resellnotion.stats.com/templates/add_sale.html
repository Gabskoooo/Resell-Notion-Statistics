{% extends 'base.html' %}

{% block title %}Enregistrer Vente{% endblock %}

{% block content %}
<style>
    /* Règle temporaire pour forcer l'affichage des cartes de produits */
    .product-card {
        opacity: 1 !important;
        visibility: visible !important;
    }
    /* Styles pour les boutons de statut de paiement */
    .status-button {
        width: 100%;
        padding: 15px;
        font-size: 1.1em;
        font-weight: bold;
        border: 2px solid transparent;
        transition: all 0.2s ease-in-out;
        margin-bottom: 10px;
    }
    .status-button.selected {
        /* Encadrement et mise en évidence de la sélection */
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        transform: scale(1.02);
    }
    .status-button:hover:not(.selected) {
        opacity: 0.8;
    }
    .btn-received {
        background-color: #4CAF50; /* Vert */
        border-color: #4CAF50;
        color: white;
    }
    .btn-pending {
        background-color: #FFC107; /* Jaune/Orange */
        border-color: #FFC107;
        color: black;
    }
</style>

<div class="form-steps-container">
    <h1 class="text-white text-center mb-5 dashboard-section-fadein dashboard-card-delay-1">Enregistrer une nouvelle vente</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flashes mb-4 dashboard-section-fadein dashboard-card-delay-2">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <form method="post" id="add-sale-form">
        <input type="hidden" id="product_id" name="product_id" value="{{ sale.product_id if sale.product_id }}">
        <input type="hidden" id="product_name_hidden" name="product_name_hidden" value="">
        <input type="hidden" id="sku_hidden" name="sku_hidden" value="">
        <input type="hidden" id="payment_status_hidden" name="payment_status" value="{{ sale.payment_status if sale.payment_status }}">

        {# Étape 1: Sélectionner le produit #}
        <div class="step-card dashboard-card-delay-3" id="step-1">
            <div class="step-header" data-step="1">
                <div class="step-number">1</div>
                <h3 class="step-title">Sélectionner le produit</h3>
            </div>
            <div class="step-content">
                <div class="mb-3">
                    <input type="text" id="productSearch" class="form-control form-control-lg" placeholder="Rechercher un produit par nom ou SKU..." autocomplete="off">
                </div>

                {% if products %}
                <div class="product-selection-grid" id="productGrid">
                    {% for product in products %}
                    <div class="product-card animated-card"
                         data-product-id="{{ product.id }}"
                         data-product-name="{{ product.name }}"
                         data-product-sku="{{ product.sku }}"
                         data-product-price="{{ product.purchase_price }}"
                         data-product-image="{{ product.image_url }}"
                         data-product-size="{{ product.size }}"
                         data-animation-delay="{{ loop.index * 0.05 }}s">
                        <i class="bi bi-check-circle-fill selected-icon"></i>
                        {% if product.image_url %}
                        <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-card-img">
                        {% else %}
                        <i class="bi bi-box2" style="font-size: 3em; color: #8e9297; margin-bottom: 0.5rem;"></i>
                        {% endif %}
                        <h6 class="card-title mb-1">{{ product.name }}</h6>
                        <small class="text-muted">SKU: {{ product.sku }}</small>
                        <p class="text-muted mb-0"><small>Taille: {{ product.size }}</small></p>
                    </div>
                    {% endfor %}
                </div>
                <div id="no-products-found" class="text-center text-muted" style="display: none;">
                    Aucun produit ne correspond à votre recherche.
                </div>
                {% else %}
                <div class="text-center text-white p-4">
                    <h3>Aucun produit n'est disponible.</h3>
                    <p>Veuillez d'abord <a href="{{ url_for('add_product') }}">ajouter un produit</a>.</p>
                </div>
                {% endif %}
            </div>
        </div>

        {# Étape 2: Détails de la vente #}
        <div class="step-card mt-4 dashboard-card-delay-4" id="step-2">
            <div class="step-header" data-step="2">
                <div class="step-number">2</div>
                <h3 class="step-title">Détails de la vente</h3>
            </div>
            <div class="step-content">
                <div class="alert alert-info mt-3" id="selected-product-info-panel" style="display: none;">
                    <button type="button" class="btn btn-sm btn-dark float-end" id="changeProductBtn">Changer de produit</button>
                    <p class="mb-0"><strong>Produit sélectionné:</strong> <span id="selected-product-name"></span></p>
                    <p class="mb-0"><strong>SKU:</strong> <span id="selected-product-sku"></span></p>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="sale_price" class="form-label">Prix de vente (€):</label>
                        <input type="number" step="0.01" class="form-control" id="sale_price" name="sale_price" value="{{ sale.sale_price }}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="sale_date" class="form-label">Date de la vente:</label>
                        <input type="date" class="form-control" id="sale_date" name="sale_date" value="{{ sale.sale_date }}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="shipping_cost" class="form-label">Frais de port (€):</label>
                        <input type="number" step="0.01" class="form-control" id="shipping_cost" name="shipping_cost" value="{{ sale.shipping_cost }}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="fees" class="form-label">Frais de plateforme (€):</label>
                        <input type="number" step="0.01" class="form-control" id="fees" name="fees" value="{{ sale.fees }}" required>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary w-100 mt-4" id="goToStep3">Continuer vers le statut de paiement</button>
            </div>
        </div>

        {# Étape 3: Statut du paiement #}
        <div class="step-card mt-4 dashboard-card-delay-5" id="step-3">
            <div class="step-header" data-step="3">
                <div class="step-number">3</div>
                <h3 class="step-title">Statut du Paiement</h3>
            </div>
            <div class="step-content">
                <p class="text-white-50">Veuillez indiquer le statut de paiement de cette vente.</p>
                <div class="row g-3">
                    <div class="col-md-6">
                        <button type="button" class="btn status-button btn-received" data-status="reçu">
                            <i class="bi bi-check-circle-fill me-2"></i>Paiement Reçu
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn status-button btn-pending" data-status="en_attente">
                            <i class="bi bi-clock-fill me-2"></i>Paiement en Attente
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-4" id="submitSaleBtn" style="display: none;">Enregistrer la vente</button>
            </div>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form Elements
        const form = document.getElementById('add-sale-form');
        const productSearchInput = document.getElementById('productSearch');
        const productIdHiddenInput = document.getElementById('product_id');
        const productNameHiddenInput = document.getElementById('product_name_hidden');
        const skuHiddenInput = document.getElementById('sku_hidden');
        const paymentStatusHiddenInput = document.getElementById('payment_status_hidden'); // Nouveau champ
        const productGrid = document.getElementById('productGrid');
        const productCards = productGrid ? productGrid.querySelectorAll('.product-card') : [];
        const noProductsMessage = document.getElementById('no-products-found');

        // Step Containers
        const step1Card = document.getElementById('step-1');
        const step2Card = document.getElementById('step-2');
        const step3Card = document.getElementById('step-3'); // Nouvelle étape
        const allSteps = [step1Card, step2Card, step3Card];
        const selectedProductInfoPanel = document.getElementById('selected-product-info-panel');
        const changeProductBtn = document.getElementById('changeProductBtn');
        const goToStep3Btn = document.getElementById('goToStep3'); // Nouveau bouton
        const submitSaleBtn = document.getElementById('submitSaleBtn'); // Bouton de soumission

        // Status Buttons
        const statusButtons = document.querySelectorAll('.status-button');

        // --- Step & Status Logic ---

        function activateStep(stepCard) {
            allSteps.forEach(s => s.classList.remove('active-step'));
            stepCard.classList.add('active-step');
        }

        function completeStep(stepCard) {
            stepCard.classList.add('completed');
        }

        function uncompleteStep(stepCard) {
            stepCard.classList.remove('completed');
        }

        function selectStatus(button) {
            statusButtons.forEach(b => b.classList.remove('selected'));
            button.classList.add('selected');

            paymentStatusHiddenInput.value = button.dataset.status;
            completeStep(step3Card);
            submitSaleBtn.style.display = 'block'; // Afficher le bouton de soumission
        }

        // Product Selection
        function selectProduct(card) {
            productCards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');

            productIdHiddenInput.value = card.dataset.productId;
            productNameHiddenInput.value = card.dataset.productName;
            skuHiddenInput.value = card.dataset.productSku;
            document.getElementById('selected-product-name').textContent = card.dataset.productName;
            document.getElementById('selected-product-sku').textContent = card.dataset.productSku;

            selectedProductInfoPanel.style.display = 'block';

            completeStep(step1Card);
            activateStep(step2Card);
        }

        function clearProductSelection() {
            productCards.forEach(c => c.classList.remove('selected'));
            productIdHiddenInput.value = '';
            productNameHiddenInput.value = '';
            skuHiddenInput.value = '';
            paymentStatusHiddenInput.value = ''; // Réinitialiser le statut
            selectedProductInfoPanel.style.display = 'none';

            // Réinitialiser les étapes
            allSteps.forEach(uncompleteStep);
            statusButtons.forEach(b => b.classList.remove('selected'));
            submitSaleBtn.style.display = 'none';
            activateStep(step1Card);
        }

        // Product Search and Filter (inchangé)
        function filterProductCards() {
            const searchTerm = productSearchInput.value.toLowerCase();
            let hasVisibleProducts = false;
            productCards.forEach(card => {
                const productName = card.dataset.productName.toLowerCase();
                const productSku = card.dataset.productSku.toLowerCase();
                const productSize = card.dataset.productSize.toLowerCase(); // Ajout de la recherche par taille

                if (productName.includes(searchTerm) || productSku.includes(searchTerm) || productSize.includes(searchTerm)) {
                    card.style.display = 'block';
                    hasVisibleProducts = true;
                } else {
                    card.style.display = 'none';
                }
            });

            if (noProductsMessage) {
                if (hasVisibleProducts) {
                    noProductsMessage.style.display = 'none';
                } else {
                    noProductsMessage.style.display = 'block';
                }
            }
        }

        // --- Event Listeners ---

        productCards.forEach(card => {
            card.addEventListener('click', function() {
                selectProduct(this);
            });
        });

        changeProductBtn.addEventListener('click', clearProductSelection);
        productSearchInput.addEventListener('input', filterProductCards);

        // Listener pour aller à l'étape 3
        goToStep3Btn.addEventListener('click', function() {
            // Petite validation rapide avant de passer à l'étape suivante
            const salePrice = document.getElementById('sale_price').value;
            if (!productIdHiddenInput.value) {
                alert("Veuillez d'abord sélectionner un produit.");
            } else if (!salePrice || isNaN(parseFloat(salePrice))) {
                alert("Veuillez saisir un prix de vente valide.");
            } else {
                completeStep(step2Card);
                activateStep(step3Card);
            }
        });

        // Listeners pour les boutons de statut
        statusButtons.forEach(button => {
            button.addEventListener('click', function() {
                selectStatus(this);
            });
        });


        // --- Initial setup ---
        activateStep(step1Card);

        const initialProductId = productIdHiddenInput.value;
        const initialPaymentStatus = paymentStatusHiddenInput.value;

        if (initialProductId) {
            const initialSelectedCard = document.querySelector(`.product-card[data-product-id="${initialProductId}"]`);
            if (initialSelectedCard) {
                selectProduct(initialSelectedCard);

                // Si la vente a déjà des données (venant d'un POST raté), on avance
                completeStep(step2Card);
                activateStep(step3Card);
            }
        }

        // Si un statut est déjà défini (POST raté), le présélectionner
        if (initialPaymentStatus) {
            const initialStatusBtn = document.querySelector(`.status-button[data-status="${initialPaymentStatus}"]`);
            if (initialStatusBtn) {
                selectStatus(initialStatusBtn);
            }
        }

        filterProductCards();
    });
</script>
{% endblock %}