{% extends 'base.html' %}

{% block title %}Enregistrer Vente{% endblock %}

{% block content %}
<style>
    /* Règle temporaire pour forcer l'affichage des cartes de produits */
    .product-card {
        opacity: 1 !important;
        visibility: visible !important;
    }
</style>

<div class="form-steps-container">
    <h1 class="text-white text-center mb-5 dashboard-section-fadein dashboard-card-delay-1">Enregistrer une nouvelle vente</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flashes mb-4 dashboard-section-fadein dashboard-card-delay-2">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <form method="post" id="add-sale-form">
        <input type="hidden" id="product_id" name="product_id" value="{{ product_id if product_id }}">
        <input type="hidden" id="product_name_hidden" name="product_name_hidden" value="">
        <input type="hidden" id="sku_hidden" name="sku_hidden" value="">

        {# Étape 1: Sélectionner le produit #}
        <div class="step-card dashboard-card-delay-3" id="step-1">
            <div class="step-header" data-step="1">
                <div class="step-number">1</div>
                <h3 class="step-title">Sélectionner le produit</h3>
            </div>
            <div class="step-content">
                <div class="mb-3">
                    <input type="text" id="productSearch" class="form-control form-control-lg" placeholder="Rechercher un produit par nom ou SKU..." autocomplete="off">
                </div>

                {% if products %}
                <div class="product-selection-grid" id="productGrid">
                    {% for product in products %}
                    <div class="product-card animated-card"
                         data-product-id="{{ product.id }}"
                         data-product-name="{{ product.name }}"
                         data-product-sku="{{ product.sku }}"
                         data-product-price="{{ product.purchase_price }}"
                         data-product-image="{{ product.image_url }}"
                         data-animation-delay="{{ loop.index * 0.05 }}s">
                        <i class="bi bi-check-circle-fill selected-icon"></i>
                        {% if product.image_url %}
                        <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-card-img">
                        {% else %}
                        <i class="bi bi-box2" style="font-size: 3em; color: #8e9297; margin-bottom: 0.5rem;"></i>
                        {% endif %}
                        <h6 class="card-title mb-1">{{ product.name }}</h6>
                        <small class="text-muted">SKU: {{ product.sku }}</small>
                    </div>
                    {% endfor %}
                </div>
                <div id="no-products-found" class="text-center text-muted" style="display: none;">
                    Aucun produit ne correspond à votre recherche.
                </div>
                {% else %}
                <div class="text-center text-white p-4">
                    <h3>Aucun produit n'est disponible.</h3>
                    <p>Veuillez d'abord <a href="{{ url_for('add_product') }}">ajouter un produit</a>.</p>
                </div>
                {% endif %}
            </div>
        </div>

        {# Étape 2: Détails de la vente #}
        <div class="step-card mt-4 dashboard-card-delay-4" id="step-2">
            <div class="step-header" data-step="2">
                <div class="step-number">2</div>
                <h3 class="step-title">Détails de la vente</h3>
            </div>
            <div class="step-content">
                <div class="alert alert-info mt-3" id="selected-product-info-panel" style="display: none;">
                    <button type="button" class="btn btn-sm btn-dark float-end" id="changeProductBtn">Changer de produit</button>
                    <p class="mb-0"><strong>Produit sélectionné:</strong> <span id="selected-product-name"></span></p>
                    <p class="mb-0"><strong>SKU:</strong> <span id="selected-product-sku"></span></p>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="sale_price" class="form-label">Prix de vente (€):</label>
                        <input type="number" step="0.01" class="form-control" id="sale_price" name="sale_price" value="{{ sale_price if sale_price }}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="sale_date" class="form-label">Date de la vente:</label>
                        <input type="date" class="form-control" id="sale_date" name="sale_date" value="{{ sale_date if sale_date }}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="shipping_cost" class="form-label">Frais de port (€):</label>
                        <input type="number" step="0.01" class="form-control" id="shipping_cost" name="shipping_cost" value="{{ shipping_cost if shipping_cost }}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="fees" class="form-label">Frais de plateforme (€):</label>
                        <input type="number" step="0.01" class="form-control" id="fees" name="fees" value="{{ fees if fees }}" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-4">Enregistrer la vente</button>
            </div>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form Elements
        const form = document.getElementById('add-sale-form');
        const productSearchInput = document.getElementById('productSearch');
        const productIdHiddenInput = document.getElementById('product_id');
        const productNameHiddenInput = document.getElementById('product_name_hidden');
        const skuHiddenInput = document.getElementById('sku_hidden');
        const productGrid = document.getElementById('productGrid');
        const productCards = productGrid ? productGrid.querySelectorAll('.product-card') : [];
        const noProductsMessage = document.getElementById('no-products-found');

        // Step Containers
        const step1Card = document.getElementById('step-1');
        const step2Card = document.getElementById('step-2');
        const allSteps = [step1Card, step2Card];
        const selectedProductInfoPanel = document.getElementById('selected-product-info-panel');
        const changeProductBtn = document.getElementById('changeProductBtn');

        // Step Logic
        function activateStep(stepCard) {
            allSteps.forEach(s => s.classList.remove('active-step'));
            stepCard.classList.add('active-step');
        }

        function completeStep(stepCard) {
            stepCard.classList.add('completed');
        }

        function uncompleteStep(stepCard) {
            stepCard.classList.remove('completed');
        }

        // Product Selection
        function selectProduct(card) {
            // Remove 'selected' class from all cards
            productCards.forEach(c => c.classList.remove('selected'));
            // Add 'selected' class to the clicked card
            card.classList.add('selected');

            // Populate hidden fields and info panel
            productIdHiddenInput.value = card.dataset.productId;
            productNameHiddenInput.value = card.dataset.productName;
            skuHiddenInput.value = card.dataset.productSku;
            document.getElementById('selected-product-name').textContent = card.dataset.productName;
            document.getElementById('selected-product-sku').textContent = card.dataset.productSku;

            selectedProductInfoPanel.style.display = 'block';

            // Complete step 1 and activate step 2
            completeStep(step1Card);
            activateStep(step2Card);
        }

        function clearProductSelection() {
            productCards.forEach(c => c.classList.remove('selected'));
            productIdHiddenInput.value = '';
            productNameHiddenInput.value = '';
            skuHiddenInput.value = '';
            selectedProductInfoPanel.style.display = 'none';

            // Re-activate step 1
            uncompleteStep(step1Card);
            uncompleteStep(step2Card);
            activateStep(step1Card);
        }

        // Product Search and Filter
        function filterProductCards() {
            const searchTerm = productSearchInput.value.toLowerCase();
            let hasVisibleProducts = false;
            productCards.forEach(card => {
                const productName = card.dataset.productName.toLowerCase();
                const productSku = card.dataset.productSku.toLowerCase();

                if (productName.includes(searchTerm) || productSku.includes(searchTerm)) {
                    card.style.display = 'block';
                    hasVisibleProducts = true;
                } else {
                    card.style.display = 'none';
                }
            });

            if (noProductsMessage) {
                if (hasVisibleProducts) {
                    noProductsMessage.style.display = 'none';
                } else {
                    noProductsMessage.style.display = 'block';
                }
            }
        }

        // Event Listeners
        productCards.forEach(card => {
            card.addEventListener('click', function() {
                selectProduct(this);
            });
        });

        changeProductBtn.addEventListener('click', clearProductSelection);
        productSearchInput.addEventListener('input', filterProductCards);

        // Initial setup
        activateStep(step1Card);

        const initialProductId = productIdHiddenInput.value;
        if (initialProductId) {
            const initialSelectedCard = document.querySelector(`.product-card[data-product-id="${initialProductId}"]`);
            if (initialSelectedCard) {
                selectProduct(initialSelectedCard);
            }
        }

        // CORRECTION: Appeler la fonction de filtre au chargement de la page pour afficher les produits
        filterProductCards();
    });
</script>
{% endblock %}