{% extends 'base.html' %}

{% block title %}Enregistrer Ventes{% endblock %}

{% block content %}
<div id="success-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; flex-direction:column; align-items:center; justify-content:center;">
    <div class="success-animation">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
    </div>
    <h2 style="color:white; margin-top:20px; font-family:'Poppins', sans-serif; font-weight: 600;">Vente enregistrée !</h2>
</div>

<style>
    /* Animation du V vert */
    .checkmark__circle {
        stroke-dasharray: 166;
        stroke-dashoffset: 166;
        stroke-width: 2;
        stroke-miterlimit: 10;
        stroke: #7ac142;
        fill: none;
        animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    .checkmark {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: block;
        stroke-width: 2;
        stroke: #fff;
        stroke-miterlimit: 10;
        box-shadow: inset 0px 0px 0px #7ac142;
        animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s cubic-bezier(0.47, 0, 0.745, 0.715) forwards;
    }
    .checkmark__check {
        transform-origin: 50% 50%;
        stroke-dasharray: 48;
        stroke-dashoffset: 48;
        animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    @keyframes stroke { 100% { stroke-dashoffset: 0; } }
    @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
    @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 40px #7ac142; } }

    /* LOGIQUE DE FORÇAGE D'AFFICHAGE */
    .step-card {
        display: none;
    }
    .step-card.active-step {
        display: block !important;
    }

    /* GRILLE ET CARTES PRODUITS */
    .product-selection-grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 20px;
        max-height: 500px;
        overflow-y: auto;
        padding: 10px;
    }

    .product-card {
        background: rgba(255, 255, 255, 0.1) !important;
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    .product-card:hover {
        background: rgba(255, 255, 255, 0.2) !important;
        transform: translateY(-5px);
        border-color: #007bff;
    }

    .product-card.selected {
        border-color: #007bff;
        background: rgba(0, 123, 255, 0.2) !important;
        box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
    }

    .product-card-img {
        width: 100%;
        height: 120px;
        object-fit: contain;
        margin-bottom: 10px;
        border-radius: 8px;
    }

    /* BOUTONS ERGONOMIQUES POUR MULTI-VENTE */
    .btn-choice {
        background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1);
        color: white; padding: 12px; border-radius: 10px; cursor: pointer; transition: 0.2s;
        text-align: center; font-size: 0.85rem;
    }
    .btn-choice.selected { border-color: #007bff; background: rgba(0,123,255,0.2); }

    #bulkSummary {
        background: rgba(0, 123, 255, 0.2);
        border: 1px solid #007bff;
        color: white;
        border-radius: 10px;
    }
</style>

<div class="form-steps-container">
    <h1 class="text-white text-center mb-4">Vente Multi-Paires</h1>

    <div id="bulkSummary" class="alert d-none mb-4">
        <i class="bi bi-cart-check-fill me-2"></i>
        <strong>Ventes ajoutées :</strong> <span id="saleCount">0</span> paire(s)
    </div>

    <form id="multi-sale-form">
        {# Étape 1: Sélection du Produit #}
        <div class="step-card active-step" id="step-1">
            <div class="step-header">
                <div class="step-number">1</div>
                <h3 class="step-title">Sélectionner le produit</h3>
            </div>
            <div class="step-content">
                <input type="text" id="productSearch" class="form-control mb-4" placeholder="Rechercher par nom, taille ou SKU...">
                <div class="product-selection-grid" id="productGrid">
                    {% for product in products %}
                    <div class="product-card"
                         data-id="{{ product.id }}"
                         data-name="{{ product.name }}"
                         data-sku="{{ product.sku }}"
                         data-size="{{ product.size }}">
                        {% if product.image_url %}
                            <img src="{{ product.image_url }}" class="product-card-img" onerror="this.src='/static/placeholder_product.png'">
                        {% else %}
                            <div style="height:120px; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.2); border-radius:8px; margin-bottom:10px;">
                                <i class="bi bi-box-seam" style="font-size: 2.5rem; color: #6c757d;"></i>
                            </div>
                        {% endif %}
                        <h6 class="text-white mb-1" style="font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ product.name }}
                        </h6>
                        <div class="text-muted small">Taille: {{ product.size }}</div>
                        <div class="text-primary small fw-bold">{{ product.sku }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# Étape 2: Détails #}
        <div class="step-card mt-4" id="step-2">
            <div class="step-header">
                <div class="step-number">2</div>
                <h3 class="step-title">Détails de la vente</h3>
            </div>
            <div class="step-content">
                <div class="alert alert-info mb-4">
                    <strong>Modèle :</strong> <span id="display-name">-</span>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-white">Prix de vente (€)</label>
                        <input type="number" step="0.01" class="form-control" id="sale_price">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">Date</label>
                        <input type="date" class="form-control" id="sale_date" value="{{ today }}">
                    </div>
                    <div class="col-12">
                        <label class="form-label text-white">Plateforme</label>
                        <div class="row g-2">
                            {% set platform_list = ['StockX', 'Vinted', 'Alias', 'LBC', 'Ebay', 'Discord', 'Limited Resell', 'Laced', 'Units Supply', 'Wethenew', 'Autre'] %}
                            {% for p in platform_list %}
                            <div class="col-4 col-md-3">
                                <div class="btn-choice platform-opt" data-val="{{ p }}">{{ p }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label text-white">Statut du Paiement</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="btn-choice status-opt fw-bold" data-val="reçu" style="color:#4CAF50;">REÇU</div>
                            </div>
                            <div class="col-6">
                                <div class="btn-choice status-opt fw-bold" data-val="en_attente" style="color:#FFC107;">ATTENTE</div>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary w-100 mt-5 py-3 fw-bold" id="btnNextTo3">SUIVANT</button>
            </div>
        </div>

        {# Étape 3: Choix Final #}
        <div class="step-card mt-4 text-center" id="step-3">
            <div class="step-header">
                <div class="step-number">3</div>
                <h3 class="step-title">Vente prête !</h3>
            </div>
            <div class="step-content py-4">
                <div class="mb-4"><i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i></div>
                <div class="d-grid gap-3">
                    <button type="button" class="btn btn-outline-light py-3" id="addAnother">
                        <i class="bi bi-plus-circle me-2"></i> VENDRE UN AUTRE PRODUIT
                    </button>
                    <button type="button" class="btn btn-success py-3 fw-bold" id="saveAll">
                        <i class="bi bi-check-all me-2"></i> ENREGISTRER TOUT ET TERMINER
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let allSales = [];
    let currentSale = {};
    const cards = document.querySelectorAll('.product-card');

    function goToStep(n) {
        document.querySelectorAll('.step-card').forEach(s => s.classList.remove('active-step'));
        document.getElementById('step-' + n).classList.add('active-step');
        window.scrollTo(0, 0);
    }

    // 1. Sélection du produit
    cards.forEach(card => {
        card.addEventListener('click', function() {
            cards.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');

            currentSale = {
                product_id: this.dataset.id,
                item_name: this.dataset.name
            };
            document.getElementById('display-name').textContent = this.dataset.name;
            goToStep(2);
        });
    });

    // 2. Sélection Plateforme & Statut
    document.querySelectorAll('.platform-opt, .status-opt').forEach(opt => {
        opt.addEventListener('click', function() {
            const isPlat = this.classList.contains('platform-opt');
            document.querySelectorAll(isPlat ? '.platform-opt' : '.status-opt').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');

            if(isPlat) currentSale.platform = this.dataset.val;
            else currentSale.payment_status = this.dataset.val;
        });
    });

    // 3. Bouton Suivant
    document.getElementById('btnNextTo3').addEventListener('click', function() {
        currentSale.sale_price = document.getElementById('sale_price').value;
        currentSale.sale_date = document.getElementById('sale_date').value;

        if (!currentSale.sale_price || !currentSale.platform || !currentSale.payment_status) {
            alert("Veuillez remplir tous les champs.");
            return;
        }

        allSales.push({...currentSale});
        document.getElementById('bulkSummary').classList.remove('d-none');
        document.getElementById('saleCount').textContent = allSales.length;
        goToStep(3);
    });

    // 4. Vendre un autre
    document.getElementById('addAnother').addEventListener('click', () => {
        document.getElementById('sale_price').value = "";
        document.querySelectorAll('.platform-opt, .status-opt').forEach(s => s.classList.remove('selected'));
        currentSale = {};
        goToStep(1);
    });

    // 5. Envoi final avec animation
    document.getElementById('saveAll').addEventListener('click', async function() {
        this.disabled = true;
        const res = await fetch('/sales/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({sales: allSales})
        });
        const data = await res.json();

        if(data.success) {
            document.getElementById('success-overlay').style.display = 'flex';
            setTimeout(() => {
                window.location.href = data.redirect;
            }, 2500);
        } else {
            alert("Erreur: " + data.message);
            this.disabled = false;
        }
    });

    // Recherche multi-critères (Nom, SKU, Taille)
    document.getElementById('productSearch').addEventListener('input', function() {
        const term = this.value.toLowerCase().trim();
        cards.forEach(card => {
            const name = card.getAttribute('data-name').toLowerCase();
            const sku = card.getAttribute('data-sku').toLowerCase();
            const size = card.getAttribute('data-size').toLowerCase();

            if (name.includes(term) || sku.includes(term) || size.includes(term)) {
                card.style.setProperty('display', 'block', 'important');
            } else {
                card.style.setProperty('display', 'none', 'important');
            }
        });
    });
});
</script>
{% endblock %}