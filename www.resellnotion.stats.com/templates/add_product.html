{% extends 'base.html' %}

{% block title %}Ajouter Produit{% endblock %}

{% block content %}
<style>
    /* 1. FORCER LA VISIBILITÉ DU CONTENU */
    .step-card {
        background-color: #2a2a4a !important;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        display: none; /* Géré par JS */
    }

    /* Cette règle assure que le contenu est visible quand l'étape est active */
    .step-card.active-step, .step-card[style*="display: block"] {
        display: block !important;
    }

    .step-content {
        display: block !important; /* Force l'affichage du contenu interne */
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* 2. STYLES RECAPITULATIF */
    .recap-container { max-height: 400px; overflow-y: auto; margin-bottom: 20px; padding: 5px; }
    .recap-row {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .recap-img { width: 60px; height: 60px; object-fit: contain; border-radius: 8px; background: #fff; padding: 2px; }
    .recap-details { flex-grow: 1; }
    .recap-details h6 { margin: 0; color: #8a2be2; font-weight: bold; font-size: 0.9rem; }
    .recap-details small { color: #848e9c; }
    .recap-price-tag { background: rgba(138, 43, 226, 0.2); color: #fff; padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; }

    /* 3. ANIMATION FINALE */
    #success-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: #1a1a2e;
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .loader-container { position: relative; width: 160px; height: 160px; }
    .loader-circle-prog {
        fill: none; stroke: #28a745; stroke-width: 8;
        stroke-dasharray: 440; stroke-dashoffset: 440;
        transition: stroke-dashoffset 2s ease-out;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
</style>

<div id="success-overlay">
    <div class="loader-container">
        <svg width="160" height="160">
            <circle cx="80" cy="80" r="70" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"></circle>
            <circle id="progress-bar" class="loader-circle-prog" cx="80" cy="80" r="70"></circle>
        </svg>
        <i class="bi bi-box-seam" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; color: #fff;"></i>
    </div>
    <h2 class="mt-4 text-white">Produit(s) enregistré(s)</h2>
</div>

<div class="form-steps-container mt-4">
    <h1 class="text-center mb-5 text-white">Ajouter au stock</h1>

    <form method="post" id="add-product-form">
        {# Étape 1 #}
        <div class="step-card active-step" id="step-1" style="display: block;">
            <div class="step-header text-white mb-4">
                <h3 class="step-title"><span class="badge bg-primary me-2">1</span> Informations de base</h3>
            </div>
            <div class="step-content">
                <div class="mb-3 position-relative">
                    <label class="form-label text-white">SKU (Référence Unique):</label>
                    <input type="text" class="form-control" id="current_sku" autocomplete="off" placeholder="Ex: DD1391-100">
                    <div id="sku-suggestions" class="list-group position-absolute w-100" style="display:none; z-index:1000;"></div>
                </div>
                <div class="mb-3 position-relative">
                    <label class="form-label text-white">Nom du produit:</label>
                    <input type="text" class="form-control" id="current_name" autocomplete="off" placeholder="Ex: Dunk Low Panda">
                    <div id="name-suggestions" class="list-group position-absolute w-100" style="display:none; z-index:1000;"></div>
                </div>
                <input type="hidden" id="current_image_url">
                <div id="sku-preview-container" class="mt-3 text-center" style="display:none;">
                    <img id="sku-preview-img" src="" class="img-thumbnail" style="max-width: 150px; background:white;">
                </div>
                <div class="d-flex justify-content-end mt-4">
                    <button type="button" class="btn btn-primary px-4" onclick="validateStep1()">Suivant</button>
                </div>
            </div>
        </div>

        {# Étape 2 #}
        <div class="step-card" id="step-2">
            <div class="step-header text-white mb-4">
                <h3 class="step-title"><span class="badge bg-secondary me-2">2</span> Tailles et Prix</h3>
            </div>
            <div class="step-content">
                <div id="dynamic-sizes-container"></div>
                <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addSizeRow()">+ Ajouter une taille</button>
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-light" onclick="showStep(1)">Précédent</button>
                    <button type="button" class="btn btn-primary px-4" onclick="validateStep2()">Suivant</button>
                </div>
            </div>
        </div>

        {# Étape 3 #}
        <div class="step-card" id="step-3">
            <div class="step-header text-white mb-4">
                <h3 class="step-title"><span class="badge bg-success me-2">3</span> Récapitulatif</h3>
            </div>
            <div class="step-content">
                <div id="recap-list" class="recap-container"></div>
                <div class="d-flex flex-column gap-2 mt-4">
                    <button type="button" class="btn btn-outline-primary py-2" onclick="saveToMemoryAndReset()">Ajouter un autre produit</button>
                    <button type="submit" class="btn btn-success py-3 fw-bold">Terminer et enregistrer</button>
                    <button type="button" class="btn btn-link text-muted btn-sm" onclick="showStep(2)">Modifier le dernier produit</button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    let productsInMemory = [];
    let searchTimer;

    function showStep(n) {
        // Cacher tout et retirer la classe active
        document.querySelectorAll('.step-card').forEach(card => {
            card.style.display = 'none';
            card.classList.remove('active-step');
        });

        // Afficher l'étape cible
        const target = document.getElementById('step-' + n);
        if (target) {
            target.style.display = 'block';
            target.classList.add('active-step');
            window.scrollTo(0, 0);
        }
    }

    function validateStep1() {
        if (document.getElementById('current_sku').value.trim() && document.getElementById('current_name').value.trim()) {
            showStep(2);
        } else {
            alert("Remplissez le SKU et le Nom.");
        }
    }

    function validateStep2() {
        const sizes = document.querySelectorAll('.current-sizes');
        let hasValue = false;
        sizes.forEach(i => { if(i.value.trim() !== "") hasValue = true; });

        if (hasValue) {
            updateRecap();
            showStep(3);
        } else {
            alert("Ajoutez au moins une taille.");
        }
    }

    function addSizeRow(valS = '', valP = '') {
        const container = document.getElementById('dynamic-sizes-container');
        const div = document.createElement('div');
        div.className = 'row g-2 mb-2 align-items-center';
        div.innerHTML = `
            <div class="col-5"><input type="text" class="form-control current-sizes" placeholder="Taille" value="${valS}" required></div>
            <div class="col-5"><input type="number" step="0.01" class="form-control current-prices" placeholder="Prix" value="${valP}" required></div>
            <div class="col-2 text-end"><button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()"><i class="bi bi-trash"></i></button></div>
        `;
        container.appendChild(div);
    }

    function updateRecap() {
        const list = document.getElementById('recap-list');
        list.innerHTML = '';

        const current = {
            name: document.getElementById('current_name').value,
            sku: document.getElementById('current_sku').value,
            img: document.getElementById('current_image_url').value || '/static/sku_not_found.png',
            sizes: Array.from(document.querySelectorAll('.current-sizes')).map(i => i.value),
            prices: Array.from(document.querySelectorAll('.current-prices')).map(i => i.value)
        };

        const all = [...productsInMemory, current];
        all.forEach(p => {
            p.sizes.forEach((s, i) => {
                if(!s || !p.prices[i]) return;
                const row = document.createElement('div');
                row.className = 'recap-row';
                row.innerHTML = `
                    <img src="${p.img}" class="recap-img" onerror="this.src='/static/sku_not_found.png'">
                    <div class="recap-details"><h6>${p.name}</h6><small>SKU: ${p.sku} | Taille: ${s}</small></div>
                    <div class="recap-price-tag">${parseFloat(p.prices[i]).toFixed(2)}€</div>
                `;
                list.appendChild(row);
            });
        });
    }

    function saveToMemoryAndReset() {
        productsInMemory.push({
            name: document.getElementById('current_name').value,
            sku: document.getElementById('current_sku').value,
            img: document.getElementById('current_image_url').value,
            sizes: Array.from(document.querySelectorAll('.current-sizes')).map(i => i.value),
            prices: Array.from(document.querySelectorAll('.current-prices')).map(i => i.value)
        });
        document.getElementById('add-product-form').reset();
        document.getElementById('current_image_url').value = '';
        document.getElementById('sku-preview-container').style.display = 'none';
        document.getElementById('dynamic-sizes-container').innerHTML = '';
        addSizeRow();
        showStep(1);
    }

    // Recherche SKU & Nom avec Debounce
    function setupSearch(id, suggId) {
        const input = document.getElementById(id);
        const box = document.getElementById(suggId);
        input.addEventListener('input', () => {
            clearTimeout(searchTimer);
            if (input.value.length < 3) { box.style.display = 'none'; return; }
            searchTimer = setTimeout(() => {
                fetch(`/get_sku_suggestions?query=${encodeURIComponent(input.value)}`)
                .then(r => r.json()).then(data => {
                    box.innerHTML = '';
                    if(data.length > 0) {
                        data.forEach(item => {
                            const d = document.createElement('div');
                            d.className = 'list-group-item list-group-item-action bg-dark text-white border-secondary d-flex align-items-center';
                            d.innerHTML = `<img src="${item.image_url}" width="40" class="me-3" style="background:white; border-radius:4px;">
                                           <div><div class="fw-bold">${item.sku}</div><small>${item.product_name}</small></div>`;
                            d.onclick = () => {
                                document.getElementById('current_sku').value = item.sku;
                                document.getElementById('current_name').value = item.product_name;
                                document.getElementById('current_image_url').value = item.image_url;
                                document.getElementById('sku-preview-img').src = item.image_url;
                                document.getElementById('sku-preview-container').style.display = 'block';
                                box.style.display = 'none';
                            };
                            box.appendChild(d);
                        });
                        box.style.display = 'block';
                    }
                });
            }, 250);
        });
    }

    // Soumission
    document.getElementById('add-product-form').onsubmit = async function(e) {
        e.preventDefault();
        const lastName = document.getElementById('current_name').value;
        if(lastName) {
            productsInMemory.push({
                name: lastName,
                sku: document.getElementById('current_sku').value,
                img: document.getElementById('current_image_url').value,
                sizes: Array.from(document.querySelectorAll('.current-sizes')).map(i => i.value),
                prices: Array.from(document.querySelectorAll('.current-prices')).map(i => i.value)
            });
        }
        document.getElementById('success-overlay').style.display = 'flex';
        setTimeout(() => { document.getElementById('progress-bar').style.strokeDashoffset = '0'; }, 100);

        for (const p of productsInMemory) {
            const fd = new FormData();
            fd.append('sku', p.sku); fd.append('name', p.name); fd.append('image_url', p.img);
            p.sizes.forEach(s => fd.append('sizes[]', s));
            p.prices.forEach(pr => fd.append('prices[]', pr));
            await fetch("{{ url_for('add_product') }}", { method: 'POST', body: fd });
        }
        setTimeout(() => { window.location.href = "{{ url_for('products') }}"; }, 2200);
    };

    document.addEventListener('DOMContentLoaded', () => {
        addSizeRow();
        setupSearch('current_sku', 'sku-suggestions');
        setupSearch('current_name', 'name-suggestions');
        showStep(1);
    });
</script>
{% endblock %}