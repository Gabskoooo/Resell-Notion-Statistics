{% extends 'base.html' %}

{% block title %}Ajouter Produit{% endblock %}

{% block content %}
<div class="form-steps-container">
    <h1 class="text-center mb-5 text-white dashboard-section-fadein dashboard-card-delay-1">Ajouter un nouveau produit</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flashes">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <form method="post" id="add-product-form">
        {# Étape 1: Informations de base #}
        <div class="step-card dashboard-card-delay-2" id="step-1">
            <div class="step-header" data-step="1">
                <div class="step-number">1</div>
                <h3 class="step-title">Informations de base</h3>
            </div>
            <div class="step-content">
                <div class="form-group-item">
                    <label for="sku" class="form-label">SKU (Référence Unique):</label>
                    <input type="text" class="form-control" id="sku" name="sku" value="{{ sku if sku else '' }}" required autocomplete="off">
                    <div id="sku-suggestions" class="list-group position-absolute w-100" style="max-height: 200px; overflow-y: auto; display: none; z-index: 1000; border-radius: 0.25rem;">
                        <div id="no-sku-found-message" class="list-group-item text-center" style="display: none;">
                            Aucun SKU trouvé. Veuillez le renseigner manuellement.
                        </div>
                    </div>
                </div>

                <input type="hidden" id="image_url" name="image_url" value="{{ image_url if image_url else '' }}">

                <div class="form-group-item">
                    <label for="name" class="form-label">Nom du produit:</label>
                    <input type="text" class="form-control" id="name" name="name" value="{{ name if name else '' }}" required autocomplete="off">
                    <div id="name-suggestions" class="list-group position-absolute w-100" style="max-height: 200px; overflow-y: auto; display: none; z-index: 1000; border-radius: 0.25rem;">
                        <div id="no-name-found-message" class="list-group-item text-center" style="display: none;">
                            Aucun produit trouvé avec ce nom.
                        </div>
                    </div>
                </div>

                <div class="mb-3 d-flex align-items-center" id="sku-image-preview-container" style="display: {{ 'flex' if image_url else 'none' }}; margin-top: 10px;">
                    <label class="form-label me-3 mb-0">Image suggérée:</label>
                    <img id="sku-image-preview" src="{{ image_url if image_url else '' }}" alt="Image SKU" class="img-thumbnail border-0 bg-transparent" style="max-width: 150px; height: auto;">
                </div>
            </div>
        </div>

        {# Étape 2: Tailles et Prix #}
        <div class="step-card mt-4" id="step-2">
            <div class="step-header" data-step="2">
                <div class="step-number">2</div>
                <h3 class="step-title">Tailles et Prix</h3>
            </div>
            <div class="step-content">
                <div id="dynamic-fields-container">
                    {# Les champs de taille/prix seront insérés ici par JS #}
                </div>
                <button type="button" class="btn btn-secondary btn-sm mb-3" id="add-size-btn">Ajouter une taille</button>
            </div>
        </div>

        {# Étape 3: Détails et Finalisation #}
        <div class="step-card mt-4" id="step-3">
            <div class="step-header" data-step="3">
                <div class="step-number">3</div>
                <h3 class="step-title">Détails et Finalisation</h3>
            </div>
            <div class="step-content">
                <div class="form-group-item">
                    <label for="description" class="form-label">Description (optionnel):</label>
                    <textarea class="form-control" id="description" name="description" rows="3">{{ description if description else '' }}</textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-4">Enregistrer le(s) produit(s)</button>
            </div>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form Elements
        const form = document.getElementById('add-product-form');
        const skuInput = document.getElementById('sku');
        const skuSuggestions = document.getElementById('sku-suggestions');
        const skuImagePreviewContainer = document.getElementById('sku-image-preview-container');
        const skuImagePreview = document.getElementById('sku-image-preview');
        const imageUrlInput = document.getElementById('image_url');
        const productNameInput = document.getElementById('name');
        const nameSuggestions = document.getElementById('name-suggestions');
        const noNameFoundMessage = document.getElementById('no-name-found-message');
        const noSkuFoundMessage = document.getElementById('no-sku-found-message');

        // Step Containers
        const step1Card = document.getElementById('step-1');
        const step2Card = document.getElementById('step-2');
        const step3Card = document.getElementById('step-3');
        const allSteps = [step1Card, step2Card, step3Card];

        // Dynamic Fields
        const addSizeBtn = document.getElementById('add-size-btn');
        const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
        let sizeFieldCounter = 0; // Utiliser un nom plus spécifique
        const defaultImageUrl = "{{ url_for('static', filename='sku_not_found.png') }}";

        // Debounce for suggestions
        let debounceTimeoutSku;
        let debounceTimeoutName;

        // --- Step Logic ---
        function activateStep(stepCard) {
            allSteps.forEach(s => s.classList.remove('active-step'));
            stepCard.classList.add('active-step');
        }

        function completeStep(stepCard) {
            stepCard.classList.add('completed');
        }

        function uncompleteStep(stepCard) {
            stepCard.classList.remove('completed');
        }

        function checkStep1Completion() {
            if (skuInput.value.trim() !== '' && productNameInput.value.trim() !== '') {
                completeStep(step1Card);
                activateStep(step2Card);
            } else {
                uncompleteStep(step1Card);
                // Si l'étape 1 est incomplète, les étapes suivantes sont aussi considérées comme non complétées/actives
                uncompleteStep(step2Card);
                uncompleteStep(step3Card);
                activateStep(step1Card); // Rester sur l'étape 1
            }
        }

        function checkStep2Completion() {
             const sizeInputs = dynamicFieldsContainer.querySelectorAll('input[name="sizes[]"]');
             const priceInputs = dynamicFieldsContainer.querySelectorAll('input[name="prices[]"]');
             let isComplete = true;

             if (sizeInputs.length === 0) {
                 isComplete = false;
             } else {
                 sizeInputs.forEach(input => {
                     if (input.value.trim() === '') isComplete = false;
                 });
                 priceInputs.forEach(input => {
                     if (input.value.trim() === '') isComplete = false;
                 });
             }

             if (isComplete) {
                 completeStep(step2Card);
                 activateStep(step3Card);
             } else {
                 uncompleteStep(step2Card);
                 uncompleteStep(step3Card); // Si l'étape 2 est incomplète, l'étape 3 est aussi considérée comme non complétée/active
                 if (step1Card.classList.contains('completed')) {
                     activateStep(step2Card); // Rester sur l'étape 2 si l'étape 1 est complétée
                 } else {
                     activateStep(step1Card); // Sinon, revenir à l'étape 1
                 }
             }
        }

        // Event Listeners pour la validation des étapes
        skuInput.addEventListener('input', checkStep1Completion);
        productNameInput.addEventListener('input', checkStep1Completion);
        dynamicFieldsContainer.addEventListener('input', checkStep2Completion);
        dynamicFieldsContainer.addEventListener('DOMNodeRemoved', checkStep2Completion); // Pour quand un champ est supprimé

        // Écouteurs pour les clics sur les en-têtes d'étape pour la navigation arrière
        step1Card.querySelector('.step-header').addEventListener('click', () => activateStep(step1Card));
        step2Card.querySelector('.step-header').addEventListener('click', () => {
            if (step1Card.classList.contains('completed')) {
                activateStep(step2Card);
            } else {
                activateStep(step1Card); // Ne peut activer l'étape 2 que si la 1 est complétée
            }
        });
        step3Card.querySelector('.step-header').addEventListener('click', () => {
            if (step2Card.classList.contains('completed')) {
                activateStep(step3Card);
            } else if (step1Card.classList.contains('completed')) {
                activateStep(step2Card); // Ne peut activer l'étape 3 que si la 2 est complétée
            } else {
                activateStep(step1Card);
            }
        });


        // --- Dynamic Fields Logic ---
        function addSizeFields() {
            sizeFieldCounter++;
            const div = document.createElement('div');
            div.classList.add('row', 'mb-3', 'align-items-center', 'form-group-item', 'dynamic-field-row');
            div.innerHTML = `
                <div class="col-md-5">
                    <label for="size-${sizeFieldCounter}" class="form-label">Taille Produit ${sizeFieldCounter}</label>
                    <input type="text" class="form-control" id="size-${sizeFieldCounter}" name="sizes[]" required>
                </div>
                <div class="col-md-5">
                    <label for="price-${sizeFieldCounter}" class="form-label">Prix d'achat (${sizeFieldCounter}) (€)</label>
                    <input type="number" step="0.01" class="form-control" id="price-${sizeFieldCounter}" name="prices[]" required>
                </div>
                <div class="col-md-2 d-flex justify-content-end align-items-end">
                    <button type="button" class="btn btn-danger btn-sm remove-field-btn">Supprimer</button>
                </div>
            `;
            dynamicFieldsContainer.appendChild(div);

            const removeBtn = div.querySelector('.remove-field-btn');
            removeBtn.addEventListener('click', function() {
                div.remove();
                checkStep2Completion();
            });
        }

        addSizeBtn.addEventListener('click', addSizeFields);
        addSizeFields(); // Ajoute un champ par défaut au chargement

        // --- Suggestions Logic ---
        function handleSkuSuggestions() {
            clearTimeout(debounceTimeoutSku);
            const query = skuInput.value.trim();
            skuSuggestions.innerHTML = '';
            noSkuFoundMessage.style.display = 'none';
            skuSuggestions.style.display = 'none';

            if (query.length < 2) {
                imageUrlInput.value = '';
                skuImagePreview.src = defaultImageUrl;
                skuImagePreviewContainer.style.display = 'flex';
                checkStep1Completion(); // Re-check validity
                return;
            }

            debounceTimeoutSku = setTimeout(function() {
                fetch(`/get_sku_suggestions?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        skuSuggestions.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(item => {
                                const div = document.createElement('div');
                                div.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'align-items-center');
                                div.style.cursor = 'pointer';
                                div.style.backgroundColor = 'var(--card-bg)';
                                div.style.color = '#dcddde';
                                div.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                                div.addEventListener('mouseover', () => div.style.backgroundColor = 'rgba(255, 255, 255, 0.1)');
                                div.addEventListener('mouseout', () => div.style.backgroundColor = 'var(--card-bg)');


                                const img = document.createElement('img');
                                img.src = item.image_url;
                                img.alt = item.sku;
                                img.style.width = '50px';
                                img.style.height = '50px';
                                img.style.marginRight = '10px';
                                img.style.objectFit = 'contain';

                                const textContentDiv = document.createElement('div');
                                const skuSpan = document.createElement('span');
                                skuSpan.textContent = item.sku;
                                const nameSpan = document.createElement('small');
                                nameSpan.textContent = ` (${item.product_name})`;
                                nameSpan.style.marginLeft = '5px';
                                nameSpan.style.color = '#a0a0a0';

                                textContentDiv.appendChild(skuSpan);
                                textContentDiv.appendChild(nameSpan);

                                div.appendChild(img);
                                div.appendChild(textContentDiv);

                                div.addEventListener('click', function() {
                                    skuInput.value = item.sku;
                                    imageUrlInput.value = item.image_url;
                                    skuImagePreview.src = item.image_url;
                                    skuImagePreviewContainer.style.display = 'flex';
                                    productNameInput.value = item.product_name;
                                    skuSuggestions.style.display = 'none';
                                    skuSuggestions.innerHTML = '';
                                    checkStep1Completion();
                                });
                                skuSuggestions.appendChild(div);
                            });
                            skuSuggestions.style.display = 'block';
                        } else {
                            noSkuFoundMessage.style.display = 'block';
                            noSkuFoundMessage.style.backgroundColor = 'var(--card-bg)';
                            noSkuFoundMessage.style.color = '#dcddde';
                            noSkuFoundMessage.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                            skuSuggestions.appendChild(noSkuFoundMessage);
                            skuSuggestions.style.display = 'block';
                            imageUrlInput.value = '';
                            skuImagePreview.src = defaultImageUrl;
                            skuImagePreviewContainer.style.display = 'flex';
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la récupération des suggestions SKU :', error);
                    });
            }, 300);
        }

        function handleProductNameSuggestions() {
            clearTimeout(debounceTimeoutName);
            const query = productNameInput.value.trim();
            nameSuggestions.innerHTML = '';
            noNameFoundMessage.style.display = 'none';
            nameSuggestions.style.display = 'none';

            if (query.length < 2) return;

            debounceTimeoutName = setTimeout(function() {
                fetch(`/get_product_name_suggestions?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        nameSuggestions.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(item => {
                                const div = document.createElement('div');
                                div.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'align-items-center');
                                div.style.cursor = 'pointer';
                                div.style.backgroundColor = 'var(--card-bg)';
                                div.style.color = '#dcddde';
                                div.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                                div.addEventListener('mouseover', () => div.style.backgroundColor = 'rgba(255, 255, 255, 0.1)');
                                div.addEventListener('mouseout', () => div.style.backgroundColor = 'var(--card-bg)');

                                const img = document.createElement('img');
                                img.src = item.image_url;
                                img.alt = item.name;
                                img.style.width = '50px';
                                img.style.height = '50px';
                                img.style.marginRight = '10px';
                                img.style.objectFit = 'contain';

                                const textContentDiv = document.createElement('div');
                                const nameSpan = document.createElement('span');
                                nameSpan.textContent = item.name;
                                const skuSpan = document.createElement('small');
                                skuSpan.textContent = ` (SKU: ${item.sku})`;
                                skuSpan.style.marginLeft = '5px';
                                skuSpan.style.color = '#a0a0a0';

                                textContentDiv.appendChild(nameSpan);
                                textContentDiv.appendChild(skuSpan);

                                div.appendChild(img);
                                div.appendChild(textContentDiv);

                                div.addEventListener('click', function() {
                                    productNameInput.value = item.name;
                                    skuInput.value = item.sku;
                                    imageUrlInput.value = item.image_url;
                                    skuImagePreview.src = item.image_url;
                                    skuImagePreviewContainer.style.display = 'flex';
                                    nameSuggestions.style.display = 'none';
                                    nameSuggestions.innerHTML = '';
                                    checkStep1Completion();
                                });
                                nameSuggestions.appendChild(div);
                            });
                            nameSuggestions.style.display = 'block';
                        } else {
                            noNameFoundMessage.style.display = 'block';
                            noNameFoundMessage.style.backgroundColor = 'var(--card-bg)';
                            noNameFoundMessage.style.color = '#dcddde';
                            noNameFoundMessage.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                            nameSuggestions.appendChild(noNameFoundMessage);
                            nameSuggestions.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la récupération des suggestions de nom de produit :', error);
                    });
            }, 300);
        }

        // Event Listeners
        skuInput.addEventListener('input', handleSkuSuggestions);
        productNameInput.addEventListener('input', handleProductNameSuggestions);

        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!skuSuggestions.contains(event.target) && event.target !== skuInput) {
                skuSuggestions.style.display = 'none';
            }
            if (!nameSuggestions.contains(event.target) && event.target !== productNameInput) {
                nameSuggestions.style.display = 'none';
            }
        });

        // Initial setup
        activateStep(step1Card);
        if (!imageUrlInput.value) {
            skuImagePreview.src = defaultImageUrl;
            skuImagePreviewContainer.style.display = 'flex';
        } else {
            skuImagePreviewContainer.style.display = 'flex';
        }

        checkStep1Completion(); // Vérifier l'état initial des étapes
        checkStep2Completion(); // Pour le cas où des données seraient pré-remplies

    });
</script>
{% endblock %}