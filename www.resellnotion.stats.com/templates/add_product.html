{% extends 'base.html' %}

{% block title %}Ajouter Produit{% endblock %}

{% block content %}
<style>
    /* Styles Responsifs pour add_product.html */
    @media (max-width: 768px) {
        h1 {
            font-size: 1.8em;
        }
        .form-label {
            font-size: 0.9em;
        }
        .form-control {
            font-size: 0.9em;
            padding: 0.6rem 0.8rem;
        }
        .img-thumbnail {
            max-width: 100px;
        }
        .list-group-item {
            font-size: 0.85em;
            padding: 8px 10px;
        }
        .list-group-item img {
            width: 40px;
            height: 40px;
        }
        .btn {
            padding: 10px 20px;
            font-size: 0.9em;
        }
    }

    @media (max-width: 480px) {
        h1 {
            font-size: 1.5em;
        }
        .form-label {
            font-size: 0.85em;
        }
        .form-control {
            font-size: 0.85em;
            padding: 0.5rem 0.7rem;
        }
        .img-thumbnail {
            max-width: 80px;
        }
        .list-group-item {
            font-size: 0.8em;
            padding: 6px 8px;
        }
        .list-group-item img {
            width: 30px;
            height: 30px;
        }
        .btn {
            padding: 8px 15px;
            font-size: 0.8em;
        }
    }

    /* Style du conteneur principal */
    .form-container {
        background-color: #2c2f33; /* Gris foncé, légèrement plus clair que le noir */
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    /* Styles pour les champs de formulaire */
    .form-control {
        background-color: #36393f; /* Gris foncé légèrement plus clair que le fond */
        border: 1px solid #4f545c;
        color: #dcddde;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .form-control:focus {
        background-color: #36393f;
        border-color: #7289da; /* Une couleur d'accent pour le focus (bleu-violet) */
        box-shadow: 0 0 0 0.25rem rgba(114, 137, 218, 0.25);
        color: #dcddde;
    }

    .form-label {
        color: #dcddde; /* Labels en gris clair */
        font-weight: 500;
    }

    /* Styles pour les boutons */
    .btn-primary {
        background-color: #7289da;
        border-color: #7289da;
    }
    .btn-primary:hover {
        background-color: #677bc4;
        border-color: #677bc4;
    }
    .btn-secondary {
        background-color: #4f545c;
        border-color: #4f545c;
    }
    .btn-secondary:hover {
        background-color: #42464d;
        border-color: #42464d;
    }
    .btn-danger {
        background-color: #992d22;
        border-color: #992d22;
    }
    .btn-danger:hover {
        background-color: #83271d;
        border-color: #83271d;
    }

    /* Styles pour les messages de suggestion */
    .list-group.position-absolute {
        background-color: #36393f;
        border: 1px solid #4f545c;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .list-group-item {
        background-color: transparent;
        color: #dcddde;
        border-color: #4f545c;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }
    .list-group-item:hover {
        background-color: #42464d;
    }

    /* Styles pour les messages flash */
    .flashes .alert {
        border-radius: 8px;
    }

    .alert-success {
        background-color: #43b581;
        color: #fff;
        border-color: #43b581;
    }
    .alert-danger {
        background-color: #f04747;
        color: #fff;
        border-color: #f04747;
    }

</style>
<div class="form-container">
    <h1 class="text-center mb-4 text-white">Ajouter un nouveau produit</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flashes">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <form method="post" id="add-product-form">
        <div class="mb-3">
            <label for="sku" class="form-label">SKU (Référence Unique):</label>
            <input type="text" class="form-control" id="sku" name="sku" value="{{ sku if sku else '' }}" required autocomplete="off">
            <div id="sku-suggestions" class="list-group position-absolute w-100" style="max-height: 200px; overflow-y: auto; display: none; z-index: 1000; border-radius: 0.25rem;">
                <div id="no-sku-found-message" class="list-group-item text-center" style="display: none; background-color: #36393f; color: #dcddde;">
                    Aucun SKU trouvé. Veuillez le renseigner manuellement.
                </div>
            </div>
        </div>

        <input type="hidden" id="image_url" name="image_url" value="{{ image_url if image_url else '' }}">

        <div class="mb-3 d-flex align-items-center" id="sku-image-preview-container" style="display: {{ 'flex' if image_url else 'none' }}; margin-top: 10px;">
            <label class="form-label me-3 mb-0">Image suggérée:</label>
            <img id="sku-image-preview" src="{{ image_url if image_url else '' }}" alt="Image SKU" class="img-thumbnail border-0 bg-transparent" style="max-width: 150px; height: auto;">
        </div>

        <div class="mb-3">
            <label for="name" class="form-label">Nom du produit:</label>
            <input type="text" class="form-control" id="name" name="name" value="{{ name if name else '' }}" required autocomplete="off">
            <div id="name-suggestions" class="list-group position-absolute w-100" style="max-height: 200px; overflow-y: auto; display: none; z-index: 1000; border-radius: 0.25rem;">
                <div id="no-name-found-message" class="list-group-item text-center" style="display: none; background-color: #36393f; color: #dcddde;">
                    Aucun produit trouvé avec ce nom.
                </div>
            </div>
        </div>

        <hr class="my-4" style="border-color: #4f545c;">

        <h3 class="mt-4 mb-3 text-white">Tailles et Prix</h3>
        <div id="dynamic-fields-container">
        </div>
        <button type="button" class="btn btn-secondary btn-sm mb-3" id="add-size-btn">Ajouter une taille</button>

        <hr class="my-4" style="border-color: #4f545c;">

        <div class="mb-3">
            <label for="description" class="form-label">Description (optionnel):</label>
            <textarea class="form-control" id="description" name="description" rows="3">{{ description if description else '' }}</textarea>
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-4">Enregistrer le(s) produit(s)</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const skuInput = document.getElementById('sku');
        const skuSuggestions = document.getElementById('sku-suggestions');
        const skuImagePreviewContainer = document.getElementById('sku-image-preview-container');
        const skuImagePreview = document.getElementById('sku-image-preview');
        const imageUrlInput = document.getElementById('image_url');
        const productNameInput = document.getElementById('name');

        const nameSuggestions = document.getElementById('name-suggestions');
        const noNameFoundMessage = document.getElementById('no-name-found-message');

        const noSkuFoundMessage = document.getElementById('no-sku-found-message');

        const defaultImageUrl = "{{ url_for('static', filename='sku_not_found.png') }}";

        let debounceTimeoutSku;
        let debounceTimeoutName;

        // --- NOUVEAU : Logique pour les champs dynamiques ---
        const addSizeBtn = document.getElementById('add-size-btn');
        const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
        let counter = 0;

        function addSizeFields() {
            counter++;
            const div = document.createElement('div');
            div.classList.add('row', 'mb-3', 'align-items-center');
            div.innerHTML = `
                <div class="col-md-5">
                    <label for="size-${counter}" class="form-label">Taille Produit ${counter}</label>
                    <input type="text" class="form-control" id="size-${counter}" name="sizes[]" required>
                </div>
                <div class="col-md-5">
                    <label for="price-${counter}" class="form-label">Prix Produit ${counter} (€)</label>
                    <input type="number" step="0.01" class="form-control" id="price-${counter}" name="prices[]" required>
                </div>
                <div class="col-md-2 d-flex justify-content-end align-items-end">
                    <button type="button" class="btn btn-danger btn-sm remove-field-btn">Supprimer</button>
                </div>
            `;
            dynamicFieldsContainer.appendChild(div);

            const removeBtn = div.querySelector('.remove-field-btn');
            removeBtn.addEventListener('click', function() {
                div.remove();
            });
        }

        addSizeBtn.addEventListener('click', addSizeFields);

        // Ajoute un champ de taille par défaut au chargement
        addSizeFields();
        // --- FIN NOUVEAU ---

        // Function to handle SKU suggestions
        function handleSkuSuggestions() {
            clearTimeout(debounceTimeoutSku);
            const query = skuInput.value.trim();

            skuSuggestions.innerHTML = '';
            noSkuFoundMessage.style.display = 'none';
            skuSuggestions.style.display = 'none';

            if (query.length < 2) {
                imageUrlInput.value = '';
                skuImagePreview.src = defaultImageUrl;
                skuImagePreviewContainer.style.display = 'flex';
                return;
            }

            debounceTimeoutSku = setTimeout(function() {
                fetch(`/get_sku_suggestions?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        skuSuggestions.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(item => {
                                const div = document.createElement('div');
                                div.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'align-items-center');
                                div.style.backgroundColor = '#36393f';
                                div.style.color = '#dcddde';
                                div.style.borderColor = '#4f545c';
                                div.style.cursor = 'pointer';

                                const img = document.createElement('img');
                                img.src = item.image_url;
                                img.alt = item.sku;
                                img.style.width = '50px';
                                img.style.height = '50px';
                                img.style.marginRight = '10px';
                                img.style.objectFit = 'contain';

                                const textContentDiv = document.createElement('div');
                                const skuSpan = document.createElement('span');
                                skuSpan.textContent = item.sku;
                                const nameSpan = document.createElement('small');
                                nameSpan.textContent = ` (${item.product_name})`;
                                nameSpan.style.marginLeft = '5px';

                                textContentDiv.appendChild(skuSpan);
                                textContentDiv.appendChild(nameSpan);

                                div.appendChild(img);
                                div.appendChild(textContentDiv);

                                div.addEventListener('click', function() {
                                    skuInput.value = item.sku;
                                    imageUrlInput.value = item.image_url;
                                    skuImagePreview.src = item.image_url;
                                    skuImagePreviewContainer.style.display = 'flex';
                                    productNameInput.value = item.product_name;
                                    skuSuggestions.style.display = 'none';
                                    skuSuggestions.innerHTML = '';
                                });
                                skuSuggestions.appendChild(div);
                            });
                            skuSuggestions.style.display = 'block';
                        } else {
                            noSkuFoundMessage.style.display = 'block';
                            skuSuggestions.appendChild(noSkuFoundMessage);
                            skuSuggestions.style.display = 'block';

                            imageUrlInput.value = '';
                            skuImagePreview.src = defaultImageUrl;
                            skuImagePreviewContainer.style.display = 'flex';
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la récupération des suggestions SKU :', error);
                        skuSuggestions.innerHTML = '';
                        noSkuFoundMessage.style.display = 'block';
                        skuSuggestions.appendChild(noSkuFoundMessage);
                        skuSuggestions.style.display = 'block';
                        imageUrlInput.value = '';
                        skuImagePreview.src = defaultImageUrl;
                        skuImagePreviewContainer.style.display = 'flex';
                    });
            }, 300);
        }

        // Function to handle Product Name suggestions
        function handleProductNameSuggestions() {
            clearTimeout(debounceTimeoutName);
            const query = productNameInput.value.trim();

            nameSuggestions.innerHTML = '';
            noNameFoundMessage.style.display = 'none';
            nameSuggestions.style.display = 'none';

            if (query.length < 2) {
                return;
            }

            debounceTimeoutName = setTimeout(function() {
                fetch(`/get_product_name_suggestions?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        nameSuggestions.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(item => {
                                const div = document.createElement('div');
                                div.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'align-items-center');
                                div.style.backgroundColor = '#36393f';
                                div.style.color = '#dcddde';
                                div.style.borderColor = '#4f545c';
                                div.style.cursor = 'pointer';

                                const img = document.createElement('img');
                                img.src = item.image_url;
                                img.alt = item.name;
                                img.style.width = '50px';
                                img.style.height = '50px';
                                img.style.marginRight = '10px';
                                img.style.objectFit = 'contain';

                                const textContentDiv = document.createElement('div');
                                const nameSpan = document.createElement('span');
                                nameSpan.textContent = item.name;
                                const skuSpan = document.createElement('small');
                                skuSpan.textContent = ` (SKU: ${item.sku})`;
                                skuSpan.style.marginLeft = '5px';

                                textContentDiv.appendChild(nameSpan);
                                textContentDiv.appendChild(skuSpan);

                                div.appendChild(img);
                                div.appendChild(textContentDiv);

                                div.addEventListener('click', function() {
                                    productNameInput.value = item.name;
                                    skuInput.value = item.sku;
                                    imageUrlInput.value = item.image_url;
                                    skuImagePreview.src = item.image_url;
                                    skuImagePreviewContainer.style.display = 'flex';
                                    nameSuggestions.style.display = 'none';
                                    nameSuggestions.innerHTML = '';
                                });
                                nameSuggestions.appendChild(div);
                            });
                            nameSuggestions.style.display = 'block';
                        } else {
                            noNameFoundMessage.style.display = 'block';
                            nameSuggestions.appendChild(noNameFoundMessage);
                            nameSuggestions.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la récupération des suggestions de nom de produit :', error);
                        nameSuggestions.innerHTML = '';
                        noNameFoundMessage.style.display = 'block';
                        nameSuggestions.appendChild(noNameFoundMessage);
                        nameSuggestions.style.display = 'block';
                    });
            }, 300);
        }

        // Event Listeners
        skuInput.addEventListener('input', handleSkuSuggestions);
        productNameInput.addEventListener('input', handleProductNameSuggestions);

        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!skuSuggestions.contains(event.target) && event.target !== skuInput) {
                skuSuggestions.style.display = 'none';
                noSkuFoundMessage.style.display = 'none';
            }
            if (!nameSuggestions.contains(event.target) && event.target !== productNameInput) {
                nameSuggestions.style.display = 'none';
                noNameFoundMessage.style.display = 'none';
            }
        });

        // Initialize default image if no image_url is provided
        if (!imageUrlInput.value) {
            skuImagePreview.src = defaultImageUrl;
            skuImagePreviewContainer.style.display = 'flex';
        } else {
             skuImagePreviewContainer.style.display = 'flex';
        }
    });
</script>
{% endblock %}