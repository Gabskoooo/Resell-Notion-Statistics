{% extends 'base.html' %}

{% block title %}Mettre un article en vente{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card p-4 shadow-lg animate__animated animate__fadeIn">
                <h1 class="text-center mb-4">Mettre un article en vente</h1>
                <form method="POST" action="{{ url_for('add_listing') }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="photos" class="form-label">Photos de l'article (10 max)</label>
                        <input type="file" class="form-control" id="photos" name="photos" accept="image/*" multiple required>
                        <div id="image-preview-container" class="d-flex flex-wrap gap-2 mt-3">
                            </div>
                    </div>
                    <div class="mb-3">
                        <label for="brand" class="form-label">Marque</label>
                        <select class="form-select" id="brand" name="brand" required>
                            <option value="">Sélectionnez une marque</option>
                            <option value="Nike">Nike</option>
                            <option value="Nike SB">Nike SB</option>
                            <option value="Supreme">Supreme</option>
                            <option value="Adidas">Adidas</option>
                            <option value="Yeezy">Yeezy</option>
                            <option value="Air Jordan">Air Jordan</option>
                            <option value="New Balance">New Balance</option>
                            <option value="Salomon">Salomon</option>
                            <option value="Puma">Puma</option>
                            <option value="Converse">Converse</option>
                            <option value="Asics">Asics</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="sku" class="form-label">Référence (SKU)</label>
                        <input type="text" class="form-control" id="sku" name="sku" required>
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">Nom du produit</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="sizes" class="form-label">Tailles (séparées par une virgule)</label>
                        <input type="text" class="form-control" id="sizes" name="sizes" placeholder="Ex: S, M, L">
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description détaillée</label>
                        <textarea class="form-control" id="description" name="description" rows="5" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="price" class="form-label">Prix de vente (€)</label>
                        <input type="number" step="0.01" class="form-control" id="price" name="price" required>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">Publier l'annonce</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const photosInput = document.getElementById('photos');
        const previewContainer = document.getElementById('image-preview-container');
        let selectedFiles = []; // Pour stocker les fichiers actuellement sélectionnés

        photosInput.addEventListener('change', function(event) {
            const newFiles = Array.from(event.target.files);

            // Ajoute les nouveaux fichiers à la liste existante
            selectedFiles.push(...newFiles);

            // Limite à 10 photos
            if (selectedFiles.length > 10) {
                alert('Vous ne pouvez sélectionner que 10 photos maximum. Les dernières photos sélectionnées ont été ignorées.');
                selectedFiles = selectedFiles.slice(0, 10);
            }

            displayPreviews();
            // Met à jour l'input file pour que la soumission du formulaire contienne tous les fichiers
            photosInput.files = createFileList(selectedFiles);
        });

        function displayPreviews() {
            previewContainer.innerHTML = ''; // Vide les aperçus précédents

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.classList.add('position-relative', 'image-preview-item', 'm-1'); // Ajoute une petite marge

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('img-thumbnail');
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.objectFit = 'cover';

                    const removeBtn = document.createElement('button');
                    removeBtn.classList.add('btn', 'btn-danger', 'btn-sm', 'position-absolute', 'top-0', 'start-100', 'translate-middle', 'rounded-circle');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = function() {
                        removeFile(index);
                    };

                    imgWrapper.appendChild(img);
                    imgWrapper.appendChild(removeBtn);
                    previewContainer.appendChild(imgWrapper);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeFile(indexToRemove) {
            selectedFiles.splice(indexToRemove, 1);
            displayPreviews();
            photosInput.files = createFileList(selectedFiles);
        }

        // Fonction utilitaire pour créer un FileList à partir d'un tableau de fichiers
        function createFileList(files) {
            const dataTransfer = new DataTransfer();
            files.forEach(file => dataTransfer.items.add(file));
            return dataTransfer.files;
        }
    });
</script>
{% endblock %}